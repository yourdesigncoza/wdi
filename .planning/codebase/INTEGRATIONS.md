# External Integrations

**Analysis Date:** 2026-02-05

## APIs & External Services

**Payment Processing:**
- **PayGate PayWeb3** - South African payment gateway
  - SDK: Custom class in `payment/web/paygate.payweb3.php`
  - Endpoints:
    - Initiate: `https://secure.paygate.co.za/payweb3/initiate.trans`
    - Process: `https://secure.paygate.co.za/payweb3/process.trans`
    - Query: `https://secure.paygate.co.za/payweb3/query.trans`
  - Authentication: PayGate ID and Encryption Key (configuration-based)
  - Protocol: POST with checksum validation (MD5/SHA1)
  - Status Codes: 1=Approved, 2=Declined, 4=Cancelled
  - Implementation: `payment/web/request.php`, `payment/web/result.php`, `payment/web/query.php`

## Data Storage

**Databases:**

- **MySQL (Primary)**
  - Connection: PDO via `models/db-settings.php`
  - Client: PHP PDO with prepared statements
  - Hosts:
    - Development: `localhost:3306` (database: wdi)
    - Production: `cpt1.host-h.net` (database: medayzyzqt_db2)
  - Credentials: Stored in `models/db-settings.php` (hardcoded)
  - Table Prefix: `wdb_` (configured in `models/db-settings.php`)
  - Functions:
    - User authentication (`models/db_functions.php`)
    - Will data storage and retrieval
    - Payment transaction logging
    - Document metadata

**File Storage:**

- **Local Filesystem**
  - Upload directories:
    - `/validated-will/` - User-validated will documents
    - `/signed-will/` - Signed will documents
    - `/uploaded-documents/` - Additional user uploads
  - PHP Upload Handler: `validated-will/UploadHandler.php`, `signed-will/UploadHandler.php`
  - Access Protection: `.htaccess` files set `ForceType application/octet-stream`
  - MIME Types: Special handling for images (gif, jpeg, png) to allow download

- **Generated Documents**
  - Location: `part-print-will-word/` - Temporary storage during generation
  - Format: DOCX (generated by PHPWord)
  - Delivery: Direct browser download via PHP header directives

**Caching:**
- Not detected - No Redis, Memcached, or similar cache systems in use
- PHP session-based state via `$_SESSION` superglobal

## Authentication & Identity

**Auth Provider:**

- **Custom PHP Session-Based Authentication**
  - Implementation: `models/class.user.php` and `models/funcs.php`
  - Session Name: `willsdb` (defined in `models/config.php`)
  - Session Storage: PHP default (filesystem-based)
  - Session Functions:
    - `isUserLoggedIn()` - Check authentication status
    - `destroySession()` - Session cleanup on logout

**User Management:**

- User table: `wdb_users` (prefix `wdb_`)
- Password hashing: `models/password.php` (custom implementation)
- Email-based login: `$email_login` setting in config
- Optional email activation: `$emailActivation` setting
- CSRF Protection:
  - Token generation: `openssl_random_pseudo_bytes()` or custom fallback
  - Token storage: `$_SESSION["__csrf_token"]`
  - Hashing: whirlpool algorithm
  - Validation: `csrf_validate()` method in user class

**Authorization:**

- Group-based permissions: Admin (ID: 2), Sub-Admin (ID: 5)
- Role system with secure functions
- Master admin account: User ID 1 (hardcoded in `models/config.php`)
- Admin pass: Hardcoded in `models/config.php` (used for account access)

## Monitoring & Observability

**Error Tracking:**

- PHP error log: `/usr/home/medayzyzqt/PHP_errors.log` (via `.user.ini`)
- Application error arrays: `$errors` and `$successes` global arrays
- Custom error handler: `logAllErrors()` in `models/config.php`
- Error mode: PDO exceptions enabled with `PDO::ERRMODE_EXCEPTION`

**Logs:**

- Database-driven: Payment transactions logged to `wdb_` prefixed tables
- File-based: PHP errors to configured error_log
- Session logging: Last sign-in timestamps stored in user table
- Alert system: Custom `addAlert()` function for user notifications

**Activity Tracking:**

- Last login: `updateUserLastSignIn()` records timestamp
- Payment history: Query results from payment table queries
- API responses: JSON-encoded status arrays

## CI/CD & Deployment

**Hosting:**

- **cpt1.host-h.net** (Production)
  - LAMP-based shared hosting
  - Document root: `/usr/home/medayzyzqt/public_html/wdi/`
  - SFTP/FTP deployment model (implied)

- **localhost** (Development)
  - XAMPP or local LAMP stack
  - Document root: `/opt/lampp/htdocs/wdi/`

**CI Pipeline:**
- Not detected - No GitHub Actions, GitLab CI, Jenkins, etc.
- Manual deployment process
- Install directory: `install/` (redirects to installation if $dev_env != TRUE)

**Deployment Notes:**
- Database migration: Manual SQL scripts (not detected)
- Configuration management: Environment-specific files (`db-settings.php`)
- No automated testing or deployment workflow

## Environment Configuration

**Required env vars:**
- Not using .env files - Direct file configuration
- Database credentials: `models/db-settings.php`
- Mail credentials: `models/mail_settings.php`

**Secrets location:**

- Database passwords: `models/db-settings.php` (exposed in committed code)
- Mail passwords: `models/mail_settings.php` (exposed in committed code)
- PayGate encryption key: Assumed in `payment/` configuration
- Admin password: `models/config.php` (hardcoded: '5N7$Lch&@Rq')

**Critical configuration files:**

| File | Purpose |
|------|---------|
| `models/db-settings.php` | Database connection |
| `models/mail_settings.php` | SMTP mail server |
| `models/config.php` | Site globals, admin settings |
| `payment/web/` | Payment gateway credentials |

## Webhooks & Callbacks

**Incoming:**

- **PayGate Callback:**
  - Location: `payment/web/result.php`
  - Method: POST
  - Purpose: Receive payment status from PayGate
  - Payload: Transaction ID, status, amount, reference
  - Processing: Checksum validation, status update

- **Document Upload Callbacks:**
  - Location: `validated-will/UploadHandler.php`, `signed-will/UploadHandler.php`
  - Method: POST/PUT (chunked uploads)
  - Purpose: Handle file uploads with progress tracking

**Outgoing:**

- **Email Notifications:**
  - SMTP via PHPMailer to mail recipients
  - Templates in `models/mail-templates/`
  - Hooks: `#WEBSITENAME#`, `#WEBSITEURL#`, `#DATE#` placeholders
  - Recipients: Configured in `models/mail_settings.php`

- **Payment Initiation:**
  - Outgoing POST to PayGate initiate endpoint
  - Client redirect-based flow (user browser submits to PayGate)

---

*Integration audit: 2026-02-05*
