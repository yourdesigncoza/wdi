---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/src/services/api.ts
  - frontend/src/hooks/useAuthApi.ts
autonomous: false

must_haves:
  truths:
    - "Unauthenticated user sees Sign In and Sign Up buttons"
    - "Clicking Sign In opens Clerk modal (not redirect)"
    - "Authenticated user sees UserButton with their avatar/initials"
    - "Authenticated user sees the main app content"
    - "Signing out redirects to landing page with Sign In/Sign Up buttons"
    - "API requests from authenticated users include Bearer token"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "ClerkProvider wrapping entire app"
      contains: "ClerkProvider"
    - path: "frontend/src/App.tsx"
      provides: "Auth-gated routing with SignedIn/SignedOut"
      contains: "SignedIn"
    - path: "frontend/src/hooks/useAuthApi.ts"
      provides: "Hook injecting Clerk session token into API calls"
      contains: "getToken"
    - path: "frontend/src/services/api.ts"
      provides: "API client accepting optional auth token"
      exports: ["api", "createAuthenticatedApi"]
  key_links:
    - from: "frontend/src/main.tsx"
      to: "@clerk/clerk-react"
      via: "ClerkProvider with publishableKey"
      pattern: "ClerkProvider.*publishableKey"
    - from: "frontend/src/App.tsx"
      to: "@clerk/clerk-react"
      via: "SignedIn/SignedOut conditional rendering"
      pattern: "SignedIn|SignedOut"
    - from: "frontend/src/hooks/useAuthApi.ts"
      to: "frontend/src/services/api.ts"
      via: "createAuthenticatedApi with token from useAuth"
      pattern: "useAuth.*getToken"

user_setup:
  - service: clerk
    why: "Authentication provider for user registration, login, email verification, password reset"
    env_vars:
      - name: VITE_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable Key (starts with pk_)"
    dashboard_config:
      - task: "Create Clerk application (or use existing)"
        location: "https://dashboard.clerk.com -> Create Application"
      - task: "Enable Email+Password authentication (disable social logins)"
        location: "Clerk Dashboard -> User & Authentication -> Email, Phone, Username"
      - task: "Configure email verification (enabled by default)"
        location: "Clerk Dashboard -> User & Authentication -> Email, Phone, Username -> Email address -> Require"
---

<objective>
Integrate Clerk authentication into the React frontend. Users will see Sign In/Sign Up buttons when unauthenticated and the main app when authenticated. Clerk handles all auth UI (modal mode), email verification, and password reset flows.

Purpose: Deliver AUTH-01 through AUTH-04 on the frontend -- registration, email verification, login, password reset are all handled by Clerk's prebuilt components.
Output: ClerkProvider wrapping the app, auth-gated routes, and authenticated API client ready for backend integration.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/clerk-react-prompt.md
@frontend/src/main.tsx
@frontend/src/App.tsx
@frontend/src/services/api.ts
@frontend/src/hooks/useConsent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and wrap app in ClerkProvider</name>
  <files>frontend/src/main.tsx</files>
  <action>
    1. Install Clerk React SDK:
       `cd frontend && npm install @clerk/clerk-react@latest`

    2. Create `.env.local` in `frontend/` with placeholder:
       `VITE_CLERK_PUBLISHABLE_KEY=pk_test_REPLACE_ME`
       (Real key comes from user's Clerk Dashboard -- placeholder only in code)

    3. Update `frontend/src/main.tsx` following the exact pattern from `docs/clerk-react-prompt.md`:
       - Import `ClerkProvider` from `@clerk/clerk-react`
       - Read `VITE_CLERK_PUBLISHABLE_KEY` from `import.meta.env`
       - Throw error if key is missing (fail-fast)
       - Wrap `<App />` in `<ClerkProvider publishableKey={key} afterSignOutUrl="/">` inside StrictMode
       - The provider tree becomes: StrictMode > ClerkProvider > App

    IMPORTANT per user decision:
    - Use `publishableKey` prop, NEVER `frontendApi`
    - Set `afterSignOutUrl="/"` to redirect to landing after sign-out
    - ClerkProvider goes in main.tsx, NOT deeper in component tree
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` compiles without errors.
    `grep -q "ClerkProvider" frontend/src/main.tsx` confirms ClerkProvider present.
    `grep -q "VITE_CLERK_PUBLISHABLE_KEY" frontend/src/main.tsx` confirms env var usage.
  </verify>
  <done>main.tsx wraps App in ClerkProvider with publishableKey from env and afterSignOutUrl="/"</done>
</task>

<task type="auto">
  <name>Task 2: Auth-gated UI with Clerk components and authenticated API client</name>
  <files>frontend/src/App.tsx, frontend/src/services/api.ts, frontend/src/hooks/useAuthApi.ts</files>
  <action>
    **App.tsx changes:**

    1. Import `SignedIn`, `SignedOut`, `SignInButton`, `SignUpButton`, `UserButton` from `@clerk/clerk-react`

    2. Create a landing page component (inline or extracted) shown to `<SignedOut>` users:
       - App header with "WillCraft SA" branding
       - Brief value proposition text
       - `<SignInButton mode="modal">` styled as primary button (Tailwind: bg-blue-600 text-white px-6 py-2 rounded-lg)
       - `<SignUpButton mode="modal">` styled as secondary/outline button
       - Per user decision: modal mode (not redirect) to keep users in-app
       - Do NOT include social login buttons -- email+password only (configured in Clerk Dashboard)

    3. Wrap the existing `MainContent` component (and its consent flow) in `<SignedIn>`:
       - `<SignedOut>` renders landing page with sign-in/sign-up buttons
       - `<SignedIn>` renders the existing app (consent check still runs after auth)
       - This enforces the flow order: Landing -> Sign In -> POPIA consent -> App

    4. Add `<UserButton />` to the header inside `MainContent` (top-right corner):
       - Shows user avatar/initials when signed in
       - Built-in sign-out via Clerk's dropdown

    5. Routes: `/privacy-policy` and `/info-officer` should remain accessible WITHOUT auth
       (they are informational pages). Move them outside the SignedIn/SignedOut wrapper, or
       handle via route-level logic. The consent modal and its links must work for unauthenticated users.

    **api.ts changes:**

    6. Refactor the `request` function to accept an optional `token` parameter:
       - If token provided, add `Authorization: Bearer ${token}` header
       - Keep existing `credentials: 'include'` for consent cookie
       - Export a `createAuthenticatedApi` factory that takes a token and returns the api object with all methods pre-bound to that token
       - Keep the existing `api` export as-is for unauthenticated endpoints (consent, privacy-policy, info-officer)

    **useAuthApi.ts hook:**

    7. Create `frontend/src/hooks/useAuthApi.ts`:
       - Import `useAuth` from `@clerk/clerk-react`
       - Import `createAuthenticatedApi` from `services/api`
       - Return an api instance that automatically fetches and injects the Clerk session token
       - Use `useAuth().getToken()` to get the JWT -- this is async, so the hook should provide a function that lazily gets the token on each API call
       - Pattern: `const { getToken } = useAuth(); return createAuthenticatedApi(getToken)`
       - The `createAuthenticatedApi` factory should call `getToken()` before each request to get fresh token

    IMPORTANT per user decisions:
    - Modal mode for SignInButton/SignUpButton (mode="modal")
    - Email+password only (no social login buttons)
    - Brand buttons to match existing Tailwind theme
    - Consent gate remains independent -- anonymous users still see consent modal on public pages
    - Both gates must pass for will-related endpoints (Clerk auth + POPIA consent)
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` compiles without errors.
    `grep -q "SignedIn" frontend/src/App.tsx` confirms auth gating.
    `grep -q "SignedOut" frontend/src/App.tsx` confirms unauthenticated state handling.
    `grep -q 'mode="modal"' frontend/src/App.tsx` confirms modal mode.
    `grep -q "createAuthenticatedApi" frontend/src/services/api.ts` confirms factory export.
    `grep -q "getToken" frontend/src/hooks/useAuthApi.ts` confirms token injection.
  </verify>
  <done>
    Unauthenticated users see landing with Sign In/Sign Up modal buttons.
    Authenticated users see main app with UserButton in header.
    Privacy/info-officer pages accessible without auth.
    API client supports both unauthenticated (consent) and authenticated (will endpoints) calls.
    useAuthApi hook provides Clerk-token-injected API instance.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Clerk authentication integrated into React frontend:
    - ClerkProvider wrapping app in main.tsx
    - Landing page with Sign In / Sign Up buttons (modal mode)
    - Auth-gated main content with UserButton
    - Authenticated API client hook
  </what-built>
  <how-to-verify>
    Prerequisites: Set your real Clerk publishable key in `frontend/.env.local`:
    `VITE_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_REAL_KEY`

    1. Start frontend: `cd frontend && npm run dev`
    2. Visit http://localhost:5173
    3. Verify: You see a landing page with "Sign In" and "Sign Up" buttons
    4. Click "Sign Up" -- verify Clerk modal opens (not a redirect)
    5. Register with email+password -- verify you receive a verification email
    6. After verification, confirm you are signed in and see the main app content
    7. Verify UserButton appears in the header (shows your initials/avatar)
    8. Click UserButton -> Sign Out -- verify you return to the landing page
    9. Click "Sign In" -- verify modal login works with your new credentials
    10. Visit /privacy-policy while signed out -- verify it loads (no auth required)
    11. Visit /info-officer while signed out -- verify it loads (no auth required)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `cd frontend && npm run build` succeeds with no TypeScript or build errors
- ClerkProvider wraps entire app in main.tsx
- SignedIn/SignedOut conditionals gate main content
- Modal sign-in/sign-up buttons visible when signed out
- UserButton visible when signed in
- Public routes (privacy-policy, info-officer) accessible without auth
- api.ts supports both authenticated and unauthenticated requests
</verification>

<success_criteria>
- AUTH-01: User can register via Clerk Sign Up modal (email+password)
- AUTH-02: Clerk sends verification email after registration
- AUTH-03: User can sign in and stays logged in across browser sessions
- AUTH-04: Clerk provides password reset flow via "Forgot password?" link
- Consent flow unchanged -- still independent of auth
- No social login buttons (deferred per user decision)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
