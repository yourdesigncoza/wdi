---
phase: 07-payment-download
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - backend/app/api/payment.py
  - backend/app/api/download.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/payment/initiate creates Payment record and returns PayFast form data"
    - "POST /api/payment/notify (ITN webhook) validates and confirms payment, generates download token, sends email"
    - "GET /api/payment/{payment_id}/status returns current payment status and download token"
    - "GET /api/download/{token} validates token and returns final unwatermarked PDF"
  artifacts:
    - path: "backend/app/api/payment.py"
      provides: "Payment initiation, ITN webhook, status polling endpoints"
      contains: "def initiate_payment"
    - path: "backend/app/api/download.py"
      provides: "Secure download endpoint with token verification"
      contains: "def download_will"
    - path: "backend/app/main.py"
      provides: "Router registration for payment and download"
      contains: "payment.router"
  key_links:
    - from: "backend/app/api/payment.py"
      to: "backend/app/services/payfast_service.py"
      via: "build_payment_form_data, validate_itn_signature"
      pattern: "from app\\.services\\.payfast_service import"
    - from: "backend/app/api/payment.py"
      to: "backend/app/services/download_service.py"
      via: "generate_download_token"
      pattern: "generate_download_token"
    - from: "backend/app/api/payment.py"
      to: "backend/app/services/email_service.py"
      via: "send_download_email"
      pattern: "send_download_email"
    - from: "backend/app/api/download.py"
      to: "backend/app/services/document_service.py"
      via: "generate_final"
      pattern: "generate_final"
---

<objective>
Create the payment and download API endpoints that connect PayFast services, download tokens, email, and document generation.

Purpose: Exposes the complete payment flow (initiate -> ITN -> status -> download) as REST endpoints the frontend can consume.
Output: Payment API router (3 endpoints), download API router (1 endpoint), main.py registration.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-payment-download/07-RESEARCH.md
@.planning/phases/07-payment-download/07-01-SUMMARY.md
@.planning/phases/07-payment-download/07-02-SUMMARY.md

# Existing API patterns
@backend/app/api/document.py
@backend/app/api/verification.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Payment API router (initiate, ITN webhook, status)</name>
  <files>backend/app/api/payment.py</files>
  <action>
    Create `backend/app/api/payment.py`:

    `router = APIRouter(prefix="/api/payment", tags=["payment"])`

    Use the same `_extract_user_id(request)` helper pattern from document.py for auth.

    **Endpoint 1: `POST /api/payment/initiate`**
    - Input: PaymentInitiateRequest (will_id)
    - Auth: Extract user_id from request.state
    - Validate will exists and belongs to user (WillService.get_will)
    - Validate will status is "generated" or "verified" (must have previewed)
    - Create Payment record in DB: m_payment_id=f"PAY-{uuid4().hex[:12]}", amount=settings.WILL_PRICE, status="pending"
    - Get testator name and email from will.testator JSONB (with safe fallbacks)
    - Call `build_payment_form_data()` with m_payment_id, amount, item_name="WillCraft SA - Last Will and Testament", buyer_email, buyer_first, buyer_last
    - Return PaymentInitiateResponse with payment_id, m_payment_id, payfast_url (from get_payfast_url()), form_data dict

    **Endpoint 2: `POST /api/payment/notify`**
    - This is the ITN webhook. NO auth required (called by PayFast servers).
    - Input: `Request` object -- parse body as form data (`await request.form()`)
    - Steps (4-step validation from research):
      1. Parse POST data into dict
      2. `validate_itn_signature(post_data, settings.PAYFAST_PASSPHRASE)` -- return 200 if fails (PayFast expects 200, log warning)
      3. `is_valid_payfast_ip(request.client.host)` -- log warning if fails but continue (may be proxied in dev)
      4. Look up Payment by m_payment_id -- if not found, return 200 (log error)
      5. Validate amount: post_data["amount_gross"] matches Payment.amount
      6. `await validate_itn_server_confirmation(post_data)` -- log warning if fails
      7. If payment_status == "COMPLETE":
         - Update Payment: status="completed", pf_payment_id from post_data, itn_data=dict(post_data)
         - Generate download token: `generate_download_token(str(payment.will_id), str(payment.id))`
         - Save token to Payment.download_token
         - Update Will: paid_at=utcnow(), status stays "generated" (don't change)
         - Fire-and-forget email: build download_url = f"{settings.PAYFAST_RETURN_URL.rsplit('/payment', 1)[0]}/download/{token}", call asyncio.create_task(send_download_email(...))
         - Set Payment.email_sent = True, email_sent_at = utcnow()
      8. If payment_status in ("FAILED", "CANCELLED"): update Payment.status accordingly, itn_data
      9. Make handler IDEMPOTENT: if Payment.status is already "completed", skip processing, return 200
      10. Always return 200 OK (PayFast requirement)

    **Endpoint 3: `GET /api/payment/{payment_id}/status`**
    - Auth: Extract user_id from request.state
    - Look up Payment by id, verify user_id matches
    - Return PaymentStatusResponse with status and download_token (only if completed)

    Dependencies: WillService via Depends(get_will_service), AsyncSession via Depends(get_session). Import PayFast service functions, download service functions, email service function. Use asyncio.create_task for fire-and-forget email.
  </action>
  <verify>
    - `python -c "from app.api.payment import router; print(len(router.routes))"` prints 3
    - Verify all three endpoint functions exist: initiate_payment, payment_notify, payment_status
  </verify>
  <done>
    Payment API has three endpoints: initiate (creates payment + returns form data), notify (ITN webhook with 4-step validation + idempotent processing), status (polling for frontend). All connected to services from plan 07-02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Download API router + main.py registration</name>
  <files>
    backend/app/api/download.py
    backend/app/main.py
  </files>
  <action>
    **1. Create `backend/app/api/download.py`:**

    `router = APIRouter(prefix="/api/download", tags=["download"])`

    **Endpoint: `GET /api/download/{token}`**
    - NO auth middleware required for this endpoint (token IS the auth)
    - Call `verify_download_token(token)` -- if None, raise 403 "Invalid or expired download link"
    - Extract will_id and payment_id from decoded data
    - Look up Payment by id, verify status is "completed" and download_token matches
    - Call `DocumentGenerationService.generate_final(will_id, user_id)` to generate unwatermarked PDF
      - Get user_id from Payment record
    - Return Response with PDF bytes, media_type="application/pdf"
    - Content-Disposition: `attachment; filename="WillCraft-SA-Will-{will_id_short}.pdf"` (attachment, not inline -- this is the final download)
    - Cache-Control: no-store

    Dependencies: AsyncSession via Depends(get_session), DocumentGenerationService via Depends(get_document_service).

    **2. Update `backend/app/main.py`:**

    - Add imports: `from app.api import payment, download`
    - Add router registrations after `document.router`:
      ```python
      app.include_router(payment.router)
      app.include_router(download.router)
      ```
    - IMPORTANT: The ITN webhook (`/api/payment/notify`) must be accessible without auth. Add `/api/payment/notify` to the POPIA middleware and ClerkAuth middleware skip lists. Check how those middlewares handle path exclusions and add this path.
      - In `middleware/popia_consent.py`: Add "/api/payment/notify" to the unprotected paths list
      - In `middleware/clerk_auth.py`: Add "/api/payment/notify" to the unprotected paths list
      - Also add "/api/download/" to skip lists (download uses token auth, not session auth)
  </action>
  <verify>
    - `python -c "from app.api.download import router; print(len(router.routes))"` prints 1
    - `grep -q "payment.router" backend/app/main.py`
    - `grep -q "download.router" backend/app/main.py`
    - Verify /api/payment/notify is in middleware skip lists
  </verify>
  <done>
    Download endpoint verifies token, checks payment status, generates final unwatermarked PDF, returns as attachment. Both payment and download routers registered in main.py. ITN webhook and download endpoints excluded from auth/consent middleware.
  </done>
</task>

</tasks>

<verification>
- POST /api/payment/initiate returns form_data with signature field
- POST /api/payment/notify handles PayFast ITN with idempotent processing
- GET /api/payment/{id}/status returns payment status and download_token when completed
- GET /api/download/{token} returns PDF bytes with correct Content-Disposition
- ITN webhook path bypasses auth and consent middleware
- Download path bypasses auth middleware (token-based auth)
</verification>

<success_criteria>
- All 4 endpoints importable and registered on FastAPI app
- Payment initiation creates DB record and returns PayFast-compatible form data
- ITN handler is idempotent (processing completed payment again is a no-op)
- Download endpoint generates final PDF on-the-fly (no disk storage)
- Middleware skip lists updated for webhook and download paths
</success_criteria>

<output>
After completion, create `.planning/phases/07-payment-download/07-03-SUMMARY.md`
</output>
