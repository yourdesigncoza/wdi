---
phase: 07-payment-download
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/payment.py
  - backend/app/models/__init__.py
  - backend/app/models/will.py
  - backend/app/config.py
  - backend/app/schemas/payment.py
  - backend/alembic/versions/006_add_payment_table.py
  - backend/requirements.txt
autonomous: true
user_setup:
  - service: PayFast
    why: "Payment processing"
    env_vars:
      - name: PAYFAST_MERCHANT_ID
        source: "PayFast Dashboard -> Settings -> Integration (use 10000100 for sandbox)"
      - name: PAYFAST_MERCHANT_KEY
        source: "PayFast Dashboard -> Settings -> Integration (use 46f0cd694581a for sandbox)"
      - name: PAYFAST_PASSPHRASE
        source: "PayFast Dashboard -> Settings -> Integration (use jt7NOE43FZPn for sandbox)"
    dashboard_config:
      - task: "Create PayFast merchant account (or use sandbox defaults)"
        location: "https://www.payfast.co.za/registration"
  - service: SMTP Email
    why: "Post-payment download link email"
    env_vars:
      - name: MAIL_USERNAME
        source: "SMTP provider (e.g., Gmail, SendGrid, Mailgun)"
      - name: MAIL_PASSWORD
        source: "SMTP provider app password or API key"
      - name: MAIL_SERVER
        source: "SMTP host (e.g., smtp.gmail.com)"
    dashboard_config:
      - task: "Configure SMTP credentials (SUPPRESS_SEND=True works for dev without SMTP)"
        location: "Email provider settings"

must_haves:
  truths:
    - "Payment model tracks payment lifecycle (pending -> completed/cancelled/failed)"
    - "Will model has paid_at column for download gating"
    - "Config has all PayFast, email, download token settings"
  artifacts:
    - path: "backend/app/models/payment.py"
      provides: "Payment SQLModel with all required fields"
      contains: "class Payment"
    - path: "backend/alembic/versions/006_add_payment_table.py"
      provides: "Alembic migration for payments table + paid_at on wills"
      contains: "create_table"
    - path: "backend/app/schemas/payment.py"
      provides: "Pydantic request/response schemas for payment API"
      contains: "PaymentInitiateResponse"
    - path: "backend/app/config.py"
      provides: "PayFast, email, and download config settings"
      contains: "PAYFAST_MERCHANT_ID"
  key_links:
    - from: "backend/app/models/payment.py"
      to: "backend/app/models/will.py"
      via: "ForeignKey wills.id"
      pattern: 'ForeignKey.*wills\.id'
---

<objective>
Create the Payment data model, Alembic migration, Pydantic schemas, and config settings for Phase 7.

Purpose: Establishes the data foundation that all payment services and APIs depend on.
Output: Payment model, migration 006, payment schemas, updated config with PayFast/email/download settings.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-payment-download/07-RESEARCH.md

# Existing model patterns
@backend/app/models/will.py
@backend/app/config.py
@backend/alembic/versions/005_add_verification_columns.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Payment model, Will model update, and config settings</name>
  <files>
    backend/app/models/payment.py
    backend/app/models/__init__.py
    backend/app/models/will.py
    backend/app/config.py
    backend/requirements.txt
  </files>
  <action>
    **1. Create `backend/app/models/payment.py`:**

    Payment SQLModel class with:
    - `id`: UUID PK (default_factory=uuid4, sa_column=Column(UUID(as_uuid=True), primary_key=True))
    - `will_id`: UUID FK to wills.id (nullable=False)
    - `user_id`: UUID FK to users.id (nullable=False)
    - `m_payment_id`: String(100) -- merchant payment reference (e.g., "PAY-{uuid4_short}")
    - `pf_payment_id`: String(100) nullable -- PayFast's payment ID (from ITN)
    - `amount`: String(20) -- decimal string "XXX.XX" (ZAR, 2 decimal places)
    - `status`: String(20) default "pending" -- pending | completed | cancelled | failed
    - `itn_data`: JSONB nullable -- full ITN POST data for audit
    - `download_token`: Text nullable -- generated after ITN confirmation
    - `email_sent`: Boolean default False
    - `email_sent_at`: DateTime(timezone=True) nullable
    - `created_at`: DateTime(timezone=True) server_default="now()"
    - `updated_at`: DateTime(timezone=True) server_default="now()"

    Follow the EXACT same sa_column patterns used in will.py (Column wrapping for UUID, DateTime). Add index on will_id and unique index on m_payment_id.

    **2. Update `backend/app/models/will.py`:**

    Add `paid_at` column: `datetime | None = Field(default=None, sa_column=Column(DateTime(timezone=True), nullable=True))` -- placed after the `acknowledged_warnings` field.

    **3. Update `backend/app/models/__init__.py`:**

    Import Payment model so Alembic can discover it.

    **4. Update `backend/app/config.py`:**

    Add these settings to the Settings class:

    ```python
    # PayFast
    PAYFAST_MERCHANT_ID: str = "10000100"  # Sandbox default
    PAYFAST_MERCHANT_KEY: str = "46f0cd694581a"  # Sandbox default
    PAYFAST_PASSPHRASE: str = "jt7NOE43FZPn"  # Sandbox default
    PAYFAST_SANDBOX: bool = True
    PAYFAST_RETURN_URL: str = "http://localhost:5173/payment/return"
    PAYFAST_CANCEL_URL: str = "http://localhost:5173/payment/cancel"
    PAYFAST_NOTIFY_URL: str = "http://localhost:8000/api/payment/notify"

    # Will pricing
    WILL_PRICE: str = "199.00"

    # Download tokens
    DOWNLOAD_TOKEN_SECRET: str = ""  # Falls back to SECRET_KEY if empty
    DOWNLOAD_TOKEN_MAX_AGE: int = 86400  # 24 hours

    # Email (SMTP)
    MAIL_USERNAME: str = ""
    MAIL_PASSWORD: str = ""
    MAIL_FROM: str = "noreply@willcraft.co.za"
    MAIL_FROM_NAME: str = "WillCraft SA"
    MAIL_PORT: int = 587
    MAIL_SERVER: str = ""
    MAIL_STARTTLS: bool = True
    MAIL_SSL_TLS: bool = False
    MAIL_SUPPRESS_SEND: bool = True  # True in dev, False in production
    ```

    **5. Update `backend/requirements.txt`:**

    Add after `weasyprint>=68.0`:
    ```
    itsdangerous>=2.2.0
    fastapi-mail>=1.4.0
    ```
  </action>
  <verify>
    - `python -c "from app.models.payment import Payment; print(Payment.__tablename__)"` prints "payments"
    - `python -c "from app.config import settings; print(settings.PAYFAST_MERCHANT_ID)"` prints sandbox ID
    - `grep -q "itsdangerous" backend/requirements.txt`
  </verify>
  <done>
    Payment model exists with all required fields. Will model has paid_at column. Config has all PayFast, email, and download settings. New dependencies declared in requirements.txt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Alembic migration 006 and Pydantic schemas</name>
  <files>
    backend/alembic/versions/006_add_payment_table.py
    backend/app/schemas/payment.py
  </files>
  <action>
    **1. Create `backend/alembic/versions/006_add_payment_table.py`:**

    Hand-written Alembic migration (following pattern from 005). Revision ID: use a unique hex string. Down_revision: must match the revision ID from `005_add_verification_columns.py`.

    Upgrade:
    - `op.create_table("payments", ...)` with all columns matching the Payment model:
      - id (UUID PK, server_default=sa.text("gen_random_uuid()"))
      - will_id (UUID FK wills.id, nullable=False)
      - user_id (UUID FK users.id, nullable=False)
      - m_payment_id (String(100), nullable=False)
      - pf_payment_id (String(100), nullable=True)
      - amount (String(20), nullable=False)
      - status (String(20), nullable=False, server_default="pending")
      - itn_data (JSONB, nullable=True)
      - download_token (sa.Text, nullable=True)
      - email_sent (Boolean, nullable=False, server_default=sa.text("false"))
      - email_sent_at (DateTime(timezone=True), nullable=True)
      - created_at (DateTime(timezone=True), nullable=False, server_default=sa.text("now()"))
      - updated_at (DateTime(timezone=True), nullable=False, server_default=sa.text("now()"))
    - Create indexes: ix_payments_will_id, ix_payments_m_payment_id (unique)
    - `op.add_column("wills", sa.Column("paid_at", sa.DateTime(timezone=True), nullable=True))`

    Downgrade:
    - `op.drop_column("wills", "paid_at")`
    - `op.drop_table("payments")`

    **2. Create `backend/app/schemas/payment.py`:**

    Pydantic schemas:

    ```python
    class PaymentInitiateRequest(BaseModel):
        will_id: str

    class PaymentInitiateResponse(BaseModel):
        payment_id: str
        m_payment_id: str
        payfast_url: str
        form_data: dict[str, str]  # All fields for hidden form

    class PaymentStatusResponse(BaseModel):
        payment_id: str
        status: str  # pending | completed | cancelled | failed
        download_token: str | None = None

    class PaymentCancelResponse(BaseModel):
        message: str
    ```

    Note: ITN webhook receives raw form POST data, no schema needed for that input.
  </action>
  <verify>
    - Read migration file and confirm it creates "payments" table with correct columns
    - Read migration file and confirm it adds "paid_at" to "wills" table
    - `python -c "from app.schemas.payment import PaymentInitiateResponse; print('OK')"` succeeds
    - Run `cd backend && alembic upgrade head` if DB is available
  </verify>
  <done>
    Migration 006 creates payments table with indexes and adds paid_at to wills. Payment schemas define request/response shapes for all payment API endpoints.
  </done>
</task>

</tasks>

<verification>
- Payment model importable with correct table name and all fields
- Migration 006 is consistent with model definition
- Config settings include all PayFast, email, and download token config
- Will model has paid_at column
- requirements.txt includes itsdangerous and fastapi-mail
- Schemas define PaymentInitiateRequest, PaymentInitiateResponse, PaymentStatusResponse
</verification>

<success_criteria>
- `from app.models.payment import Payment` succeeds
- `from app.schemas.payment import PaymentInitiateResponse` succeeds
- Migration 006 exists and references correct down_revision
- Config has PAYFAST_MERCHANT_ID, WILL_PRICE, DOWNLOAD_TOKEN_MAX_AGE, MAIL_SERVER
- requirements.txt has itsdangerous and fastapi-mail
</success_criteria>

<output>
After completion, create `.planning/phases/07-payment-download/07-01-SUMMARY.md`
</output>
