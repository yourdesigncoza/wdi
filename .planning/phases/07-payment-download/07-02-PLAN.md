---
phase: 07-payment-download
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - backend/app/services/payfast_service.py
  - backend/app/services/download_service.py
  - backend/app/services/email_service.py
  - backend/app/templates/email/download_ready.html
autonomous: true

must_haves:
  truths:
    - "PayFast service generates valid MD5 signatures for form submission"
    - "PayFast service validates ITN callbacks with 4-step security"
    - "Download service generates and verifies time-limited URL-safe tokens"
    - "Email service sends HTML emails with download link via fastapi-mail"
  artifacts:
    - path: "backend/app/services/payfast_service.py"
      provides: "PayFast signature generation and ITN validation"
      contains: "generate_signature"
    - path: "backend/app/services/download_service.py"
      provides: "Time-limited download token management"
      contains: "generate_download_token"
    - path: "backend/app/services/email_service.py"
      provides: "Async email sending with Jinja2 templates"
      contains: "send_download_email"
    - path: "backend/app/templates/email/download_ready.html"
      provides: "HTML email template for download notification"
      contains: "download_url"
  key_links:
    - from: "backend/app/services/payfast_service.py"
      to: "backend/app/config.py"
      via: "settings.PAYFAST_MERCHANT_ID"
      pattern: "settings\\.PAYFAST"
    - from: "backend/app/services/download_service.py"
      to: "backend/app/config.py"
      via: "settings.SECRET_KEY or DOWNLOAD_TOKEN_SECRET"
      pattern: "URLSafeTimedSerializer"
---

<objective>
Build the three core services for Phase 7: PayFast integration, download token management, and email notification.

Purpose: Encapsulates all business logic for payment processing, secure download links, and email delivery in reusable service classes.
Output: PayFast service, download token service, email service, and email HTML template.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-payment-download/07-RESEARCH.md
@.planning/phases/07-payment-download/07-01-SUMMARY.md

# Existing service patterns
@backend/app/services/will_service.py
@backend/app/services/verification_service.py
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: PayFast service (signature generation + ITN validation)</name>
  <files>backend/app/services/payfast_service.py</files>
  <action>
    Create `backend/app/services/payfast_service.py` with:

    **Module-level constants:**
    - `PAYFAST_FIELD_ORDER`: list of field names in PayFast's required order for checkout signatures (merchant_id, merchant_key, return_url, cancel_url, notify_url, name_first, name_last, email_address, cell_number, m_payment_id, amount, item_name, item_description, custom_str1-5, custom_int1-5, email_confirmation, confirmation_address, payment_method)
    - `PAYFAST_SANDBOX_URL = "https://sandbox.payfast.co.za/eng/process"`
    - `PAYFAST_LIVE_URL = "https://www.payfast.co.za/eng/process"`
    - `PAYFAST_SANDBOX_VALIDATE = "https://sandbox.payfast.co.za/eng/query/validate"`
    - `PAYFAST_LIVE_VALIDATE = "https://www.payfast.co.za/eng/query/validate"`
    - `PAYFAST_IP_RANGES`: compiled list of `ipaddress.ip_network` objects for 197.97.145.144/28 and 41.74.179.192/27

    **Functions (pure functions, no class needed):**

    1. `generate_signature(data: dict, passphrase: str | None = None) -> str`:
       - Build ordered parameter string from `data` using `PAYFAST_FIELD_ORDER`
       - Filter empty/None values
       - URL-encode values with `urllib.parse.quote_plus()`
       - Append passphrase if provided
       - Return MD5 hex digest

    2. `build_payment_form_data(m_payment_id: str, amount: str, item_name: str, buyer_email: str, buyer_first: str, buyer_last: str) -> dict[str, str]`:
       - Read settings for merchant_id, merchant_key, return_url, cancel_url, notify_url
       - Build form data dict with all fields
       - Add signature field using `generate_signature()`
       - Return complete dict ready for frontend hidden form

    3. `get_payfast_url() -> str`:
       - Return sandbox or live URL based on `settings.PAYFAST_SANDBOX`

    4. `validate_itn_signature(post_data: dict, passphrase: str | None = None) -> bool`:
       - Build param string from ALL POST fields EXCEPT "signature", in received order
       - Append passphrase if provided
       - MD5 hash and compare with `hmac.compare_digest()` (timing-safe)

    5. `is_valid_payfast_ip(ip_str: str) -> bool`:
       - Check if IP is in any PAYFAST_IP_RANGES using `ipaddress` stdlib

    6. `async validate_itn_server_confirmation(post_data: dict) -> bool`:
       - POST the received data to PayFast's validate URL
       - Use httpx AsyncClient (already in requirements)
       - Return True if response body is "VALID"
       - Handle errors gracefully (log warning, return False)

    Use `from app.config import settings` for all config access. Import hashlib, hmac, urllib.parse, ipaddress, httpx, logging.
  </action>
  <verify>
    - `python -c "from app.services.payfast_service import generate_signature, build_payment_form_data, validate_itn_signature, is_valid_payfast_ip; print('OK')"` succeeds
    - Verify signature function produces consistent MD5 output for known input
  </verify>
  <done>
    PayFast service has signature generation matching PayFast's algorithm, form data builder using config settings, ITN signature validation with timing-safe comparison, IP validation against known PayFast ranges, and async server confirmation. All functions are pure/stateless.
  </done>
</task>

<task type="auto">
  <name>Task 2: Download token service + Email service + email template</name>
  <files>
    backend/app/services/download_service.py
    backend/app/services/email_service.py
    backend/app/templates/email/download_ready.html
  </files>
  <action>
    **1. Create `backend/app/services/download_service.py`:**

    Uses itsdangerous URLSafeTimedSerializer.

    Functions:
    - `generate_download_token(will_id: str, payment_id: str) -> str`:
      - Create serializer with secret = `settings.DOWNLOAD_TOKEN_SECRET or settings.SECRET_KEY`, salt = "will-download"
      - Serialize dict `{"will_id": will_id, "payment_id": payment_id}`
      - Return URL-safe token string

    - `verify_download_token(token: str) -> dict | None`:
      - Create serializer with same secret and salt
      - Try to load with `max_age=settings.DOWNLOAD_TOKEN_MAX_AGE`
      - On `SignatureExpired` or `BadData`, return None
      - On success, return the decoded dict

    Import from `itsdangerous` (URLSafeTimedSerializer, SignatureExpired, BadData).

    **2. Create `backend/app/services/email_service.py`:**

    Uses fastapi-mail with Jinja2 templates.

    - Module-level `_get_mail_config() -> ConnectionConfig`:
      - Return ConnectionConfig with all MAIL_* settings from config
      - Set `TEMPLATE_FOLDER` to `Path(__file__).parent.parent / "templates" / "email"`
      - Set `SUPPRESS_SEND` from settings.MAIL_SUPPRESS_SEND

    - `async send_download_email(recipient_email: str, testator_name: str, download_url: str) -> bool`:
      - Create MessageSchema with subject "Your WillCraft SA Will Document is Ready"
      - Set template_body with testator_name and download_url
      - Set subtype=MessageType.html
      - Create FastMail instance with config
      - Send message with template_name="download_ready.html"
      - Return True on success, False on exception (log error, don't crash)
      - Fire-and-forget pattern: caller uses asyncio.create_task()

    **3. Create `backend/app/templates/email/download_ready.html`:**

    Simple HTML email template (Jinja2):
    - Greeting with testator_name
    - Message: "Your WillCraft SA will document is ready for download."
    - Prominent download button/link using download_url
    - Note: "This download link expires in 24 hours."
    - Reminder: "Remember to print your will and sign it in the presence of two competent witnesses as required by South African law."
    - Footer: "WillCraft SA - This is not legal advice."
    - Keep styling inline (email-safe CSS). Simple, professional design.
  </action>
  <verify>
    - `python -c "from app.services.download_service import generate_download_token, verify_download_token; t = generate_download_token('abc', 'def'); print(verify_download_token(t))"` prints the dict
    - `python -c "from app.services.email_service import send_download_email; print('OK')"` succeeds
    - Email template file exists at `backend/app/templates/email/download_ready.html`
  </verify>
  <done>
    Download service generates and verifies time-limited URL-safe tokens using itsdangerous. Email service sends HTML emails via fastapi-mail with SUPPRESS_SEND for dev. Email template has professional design with download link, 24h expiry notice, and signing reminder.
  </done>
</task>

</tasks>

<verification>
- PayFast signature generation produces MD5 hex digest from ordered, URL-encoded parameters
- PayFast ITN validation uses timing-safe comparison (hmac.compare_digest)
- PayFast IP validation checks against known IP ranges
- Download token roundtrip: generate -> verify returns original data
- Email service handles SUPPRESS_SEND gracefully for dev environments
- Email template exists with download_url and testator_name variables
</verification>

<success_criteria>
- All three services import cleanly
- PayFast generate_signature returns consistent output for same input
- Download token generation + verification roundtrip succeeds
- Email template renders with Jinja2 variables
- No new external API calls required during testing (all configurable)
</success_criteria>

<output>
After completion, create `.planning/phases/07-payment-download/07-02-SUMMARY.md`
</output>
