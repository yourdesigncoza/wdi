---
phase: 07-payment-download
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - frontend/src/features/will/components/PaymentPage.tsx
  - frontend/src/features/will/components/PaymentReturnPage.tsx
  - frontend/src/features/will/components/PaymentCancelPage.tsx
  - frontend/src/features/will/components/DownloadPage.tsx
  - frontend/src/features/will/components/DocumentPreviewPage.tsx
  - frontend/src/features/will/components/WillWizard.tsx
  - frontend/src/features/will/types/will.ts
  - frontend/src/services/api.ts
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees 'Proceed to Payment' button on DocumentPreviewPage after generating preview"
    - "User is auto-redirected to PayFast via hidden form submission"
    - "User returns to app and sees payment confirmation with download link"
    - "User can download final unwatermarked PDF from download page"
    - "Payment cancel page offers retry option"
  artifacts:
    - path: "frontend/src/features/will/components/PaymentPage.tsx"
      provides: "PayFast hidden form auto-submit redirect"
      contains: "formRef"
    - path: "frontend/src/features/will/components/PaymentReturnPage.tsx"
      provides: "Post-payment polling and download link display"
      contains: "polling"
    - path: "frontend/src/features/will/components/DownloadPage.tsx"
      provides: "Token-based PDF download page"
      contains: "download"
    - path: "frontend/src/App.tsx"
      provides: "Routes for /payment/return, /payment/cancel, /download/:token"
      contains: "payment/return"
  key_links:
    - from: "frontend/src/features/will/components/PaymentPage.tsx"
      to: "frontend/src/services/api.ts"
      via: "initiatePayment API call"
      pattern: "initiatePayment"
    - from: "frontend/src/features/will/components/PaymentReturnPage.tsx"
      to: "frontend/src/services/api.ts"
      via: "getPaymentStatus polling"
      pattern: "getPaymentStatus"
    - from: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      to: "frontend/src/features/will/components/PaymentPage.tsx"
      via: "onProceedToPayment callback"
      pattern: "onProceedToPayment|PaymentPage"
---

<objective>
Build the complete frontend payment flow: PayFast redirect, return page with polling, download page, and integrate into wizard + routes.

Purpose: Connects the user-facing UI to the backend payment and download APIs, completing the payment gate before PDF download.
Output: PaymentPage, PaymentReturnPage, PaymentCancelPage, DownloadPage, updated DocumentPreviewPage, updated App.tsx routes, updated WillWizard.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-payment-download/07-RESEARCH.md
@.planning/phases/07-payment-download/07-01-SUMMARY.md
@.planning/phases/07-payment-download/07-02-SUMMARY.md
@.planning/phases/07-payment-download/07-03-SUMMARY.md

# Existing frontend patterns
@frontend/src/features/will/components/DocumentPreviewPage.tsx
@frontend/src/features/will/components/WillWizard.tsx
@frontend/src/features/will/types/will.ts
@frontend/src/services/api.ts
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API functions, types, PaymentPage, return/cancel/download pages</name>
  <files>
    frontend/src/services/api.ts
    frontend/src/features/will/types/will.ts
    frontend/src/features/will/components/PaymentPage.tsx
    frontend/src/features/will/components/PaymentReturnPage.tsx
    frontend/src/features/will/components/PaymentCancelPage.tsx
    frontend/src/features/will/components/DownloadPage.tsx
  </files>
  <action>
    **1. Add to `frontend/src/services/api.ts`:**

    Add interfaces and functions at the end:

    ```typescript
    // -- Payment API --

    export interface PaymentInitiateResponse {
      payment_id: string
      m_payment_id: string
      payfast_url: string
      form_data: Record<string, string>
    }

    export interface PaymentStatusResponse {
      payment_id: string
      status: string  // pending | completed | cancelled | failed
      download_token: string | null
    }

    export function initiatePayment(willId: string): Promise<PaymentInitiateResponse> {
      return request('/payment/initiate', {
        method: 'POST',
        body: JSON.stringify({ will_id: willId }),
      })
    }

    export function getPaymentStatus(paymentId: string): Promise<PaymentStatusResponse> {
      return request(`/payment/${paymentId}/status`)
    }

    /** Download final PDF via token - returns blob */
    export async function downloadWill(token: string): Promise<Blob> {
      const response = await fetch(`${BASE_URL}/download/${token}`, {
        credentials: 'include',
      })
      if (!response.ok) {
        const err = await response.json().catch(() => ({ detail: 'Download failed' }))
        throw new Error(err.detail || `Download error: ${response.status}`)
      }
      return response.blob()
    }
    ```

    **2. Update `frontend/src/features/will/types/will.ts`:**

    Add 'payment' to WILL_SECTIONS array, between 'document' and the end:
    ```typescript
    export const WILL_SECTIONS = [
      'personal', 'beneficiaries', 'assets', 'guardians', 'executor',
      'bequests', 'residue', 'trust', 'usufruct', 'business', 'joint',
      'review', 'verification', 'document', 'payment',
    ] as const
    ```

    **3. Create `frontend/src/features/will/components/PaymentPage.tsx`:**

    Props: `{ willId: string, onBack: () => void }`

    - State: isLoading, error, formData (PaymentInitiateResponse | null)
    - On mount (useEffect), call `initiatePayment(willId)` and store response
    - Display payment summary: "Your Will Document - R199.00" (read from response)
    - "Pay Now" button that triggers form submission
    - When formData available, render hidden `<form>` with ref pointing to response.payfast_url, containing hidden inputs for all form_data entries
    - "Pay Now" calls `formRef.current?.submit()` to redirect to PayFast
    - Show loading spinner during API call
    - Show error alert if initiation fails
    - "Back to Preview" button calls onBack
    - Store payment_id in localStorage key `willcraft_payment_id` so return page can retrieve it
    - DaisyUI styling: card layout, btn btn-neutral for Pay Now, btn btn-soft for Back

    **4. Create `frontend/src/features/will/components/PaymentReturnPage.tsx`:**

    This is a standalone route component (not inside WillWizard).

    - Read payment_id from localStorage `willcraft_payment_id`
    - Poll `getPaymentStatus(paymentId)` every 3 seconds, up to 30 seconds (10 attempts)
    - States: polling, completed (with download token), timeout, error
    - **Polling state:** Show "Confirming your payment..." with spinner
    - **Completed state:** Show success alert + "Download Your Will" button
      - Download button: navigate to `/download/{token}` (React Router Link)
      - Also show: "A download link has been emailed to you as backup."
    - **Timeout state:** Show info alert: "Payment is being processed. You will receive an email with your download link shortly."
    - **Error state:** Show error alert with retry button
    - DaisyUI styling: centered card layout, navbar with WillCraft SA branding

    **5. Create `frontend/src/features/will/components/PaymentCancelPage.tsx`:**

    Standalone route component.

    - Simple message: "Payment Cancelled"
    - "Your payment was not completed. No charges have been made."
    - "Return to Will" button: Link to /will (restores wizard state from Zustand persist)
    - DaisyUI styling: centered card, btn btn-neutral

    **6. Create `frontend/src/features/will/components/DownloadPage.tsx`:**

    Standalone route component. Uses React Router `useParams` for token.

    - Extract token from URL params
    - "Download Your Will" button that calls `downloadWill(token)`
    - On click: get blob, create object URL, trigger download via temporary `<a>` element with download attribute
    - States: ready, downloading, error, success
    - Show file name: "WillCraft-SA-Will.pdf"
    - After download: "Your will has been downloaded. Remember to print it and sign in the presence of two witnesses."
    - Handle expired/invalid token: show error "This download link has expired or is invalid."
    - DaisyUI styling: centered card, btn btn-neutral for download
  </action>
  <verify>
    - All new components import cleanly: `PaymentPage`, `PaymentReturnPage`, `PaymentCancelPage`, `DownloadPage`
    - api.ts exports `initiatePayment`, `getPaymentStatus`, `downloadWill`
    - WILL_SECTIONS includes 'payment'
    - TypeScript compiles without errors
  </verify>
  <done>
    All payment and download frontend components created. API client has payment and download functions. Will types include payment section.
  </done>
</task>

<task type="auto">
  <name>Task 2: DocumentPreviewPage update, WillWizard integration, App routes</name>
  <files>
    frontend/src/features/will/components/DocumentPreviewPage.tsx
    frontend/src/features/will/components/WillWizard.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **1. Update `frontend/src/features/will/components/DocumentPreviewPage.tsx`:**

    Add "Proceed to Payment" button that appears AFTER a preview has been generated (when `hasGenerated` is true):

    - Add `onProceedToPayment` prop to interface: `onProceedToPayment?: () => void`
    - After the "Preview Generated" success alert, add a prominent "Proceed to Payment" button:
      ```tsx
      {hasGenerated && (
        <div className="mt-4">
          <button
            type="button"
            className="btn btn-neutral btn-lg w-full"
            onClick={onProceedToPayment}
          >
            Proceed to Payment â€” R199.00
          </button>
        </div>
      )}
      ```
    - Keep existing Generate Preview and Back to Verification buttons

    **2. Update `frontend/src/features/will/components/WillWizard.tsx`:**

    - Import PaymentPage
    - In `renderSection()`, add case for 'payment' section (after 'document' case):
      ```tsx
      if (section === 'payment') {
        if (!willId) { return loading spinner }
        return (
          <PaymentPage
            willId={willId}
            onBack={() => setCurrentSection('document')}
          />
        )
      }
      ```
    - Update the DocumentPreviewPage rendering to pass `onProceedToPayment`:
      ```tsx
      <DocumentPreviewPage
        willId={willId}
        onBack={() => setCurrentSection('verification')}
        onProceedToPayment={() => setCurrentSection('payment')}
      />
      ```
    - Add 'payment' to the `isChatSection` conditional (so it gets the card wrapper)
    - Add 'payment' to the ensureWillExists useEffect conditions

    **3. Update `frontend/src/App.tsx`:**

    Add three new routes for PayFast callback URLs and download:

    ```tsx
    import { PaymentReturnPage } from './features/will/components/PaymentReturnPage.tsx'
    import { PaymentCancelPage } from './features/will/components/PaymentCancelPage.tsx'
    import { DownloadPage } from './features/will/components/DownloadPage.tsx'
    ```

    Add routes BEFORE the wildcard route:
    ```tsx
    <Route path="/payment/return" element={<AuthGatedContent><PaymentReturnPage /></AuthGatedContent>} />
    <Route path="/payment/cancel" element={<AuthGatedContent><PaymentCancelPage /></AuthGatedContent>} />
    <Route path="/download/:token" element={<AuthGatedContent><DownloadPage /></AuthGatedContent>} />
    ```

    Note: These routes go through AuthGatedContent so user must be signed in and have consent. The download route requires auth because the token already serves as authorization for the actual API call.
  </action>
  <verify>
    - TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`
    - DocumentPreviewPage has onProceedToPayment prop
    - WillWizard renders PaymentPage for 'payment' section
    - App.tsx has routes for /payment/return, /payment/cancel, /download/:token
    - Dev server starts: `cd frontend && npm run dev` (check for compilation errors)
  </verify>
  <done>
    DocumentPreviewPage has "Proceed to Payment" button after preview. WillWizard handles payment section. App.tsx routes handle PayFast return/cancel callbacks and download page. Complete payment flow UI is wired together.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete payment and download flow:
    1. Document Preview shows "Proceed to Payment" button after generating preview
    2. Payment page shows summary and redirects to PayFast sandbox
    3. PayFast return page polls for confirmation and shows download link
    4. Download page allows PDF download via secure token
    5. Cancel page offers retry option
  </what-built>
  <how-to-verify>
    1. Navigate to a will that has been verified and generated
    2. On Document Preview, generate a preview, then click "Proceed to Payment"
    3. Verify the Payment page shows will summary and R199.00 amount
    4. Click "Pay Now" -- should redirect to PayFast sandbox
    5. Complete sandbox payment (use any test card details PayFast provides)
    6. After payment, verify return page polls and shows download link
    7. Click download -- verify final PDF downloads without watermark
    8. Test cancel flow: start payment, cancel on PayFast, verify cancel page shows
    9. Test download/:token route directly with a valid token
    10. Note: ITN webhook requires a publicly accessible URL. For local dev, the return page polling + email won't work until ITN is received. Manual testing: call POST /api/payment/notify with test data if needed.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- "Proceed to Payment" button visible on DocumentPreviewPage after preview generation
- PaymentPage calls initiatePayment API and renders hidden form
- PayFast redirect works with sandbox credentials
- PaymentReturnPage polls for status every 3 seconds
- DownloadPage triggers PDF download via blob
- All routes registered in App.tsx
- TypeScript compiles without errors
</verification>

<success_criteria>
- User can navigate from Document Preview to Payment
- PayFast hidden form auto-submits to sandbox URL
- Return page shows polling spinner, then download link
- Download page renders PDF as downloadable file
- Cancel page offers return to will
- All components use DaisyUI styling (btn btn-neutral, card, alert)
</success_criteria>

<output>
After completion, create `.planning/phases/07-payment-download/07-04-SUMMARY.md`
</output>
