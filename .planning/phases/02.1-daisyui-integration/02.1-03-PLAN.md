---
phase: 02.1-daisyui-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/src/components/common/PrivacyPolicy.tsx
  - frontend/src/components/common/InfoOfficerContact.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Dark theme persists on Privacy Policy and Info Officer pages when opened in new tab"
    - "Back buttons on sub-pages navigate to app root when no browser history exists"
    - "Theme selection in main app is reflected immediately in new-tab sub-pages"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "Synchronous theme init from localStorage before React render"
      contains: "localStorage.getItem"
    - path: "frontend/src/components/common/PrivacyPolicy.tsx"
      provides: "Fallback navigation when no history"
      contains: "navigate('/')"
    - path: "frontend/src/components/common/InfoOfficerContact.tsx"
      provides: "Fallback navigation when no history"
      contains: "navigate('/')"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "document.documentElement"
      via: "setAttribute('data-theme', ...) before createRoot"
      pattern: "setAttribute.*data-theme"
    - from: "frontend/src/components/common/PrivacyPolicy.tsx"
      to: "react-router-dom navigate"
      via: "history length check with fallback"
      pattern: "navigate\\('/'\\)"
    - from: "frontend/src/components/common/InfoOfficerContact.tsx"
      to: "react-router-dom navigate"
      via: "history length check with fallback"
      pattern: "navigate\\('/'\\)"
---

<objective>
Fix two UAT gaps: (1) dark theme not applied on sub-pages opened in new tabs, (2) back buttons non-functional on sub-pages with no browser history.

Purpose: Sub-pages (Privacy Policy, Info Officer) opened via ConsentModal target="_blank" links load in fresh tabs where localStorage theme is not applied and browser history is empty, breaking both theming and navigation.
Output: Both sub-pages respect user's theme choice and have working back navigation regardless of how they were opened.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-daisyui-integration/02.1-01-SUMMARY.md
@.planning/phases/02.1-daisyui-integration/02.1-02-SUMMARY.md
@frontend/src/main.tsx
@frontend/src/components/common/PrivacyPolicy.tsx
@frontend/src/components/common/InfoOfficerContact.tsx
@frontend/src/components/ui/ThemeToggle.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global theme initialization before React render</name>
  <files>frontend/src/main.tsx</files>
  <action>
    Add synchronous theme initialization BEFORE the createRoot() call in main.tsx.
    This must run before React renders anything to prevent theme flash.

    Insert these lines before createRoot():

    ```typescript
    // Apply saved theme before React renders to prevent flash
    const savedTheme = localStorage.getItem('wdi-theme')
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme)
    }
    ```

    This ensures that when a new tab opens (via target="_blank" from ConsentModal links),
    the user's saved theme preference from localStorage is applied to the HTML element
    before React mounts. The index.html default of data-theme="corporate" acts as the
    fallback when no theme has been saved.

    Do NOT modify ThemeToggle.tsx -- it already handles runtime theme switching correctly.
    The issue was only that the initial page load in new tabs didn't read localStorage.
  </action>
  <verify>
    1. `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit` passes
    2. `cd /opt/lampp/htdocs/wdi/frontend && npm run build` passes
    3. Grep main.tsx for `localStorage.getItem('wdi-theme')` -- must find a match
    4. Grep main.tsx for `setAttribute.*data-theme` -- must find a match
  </verify>
  <done>
    main.tsx reads localStorage('wdi-theme') and sets data-theme on document element
    before createRoot(), so new tabs opened via target="_blank" inherit the user's
    saved theme preference without flash.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fallback navigation for back buttons on sub-pages</name>
  <files>frontend/src/components/common/PrivacyPolicy.tsx, frontend/src/components/common/InfoOfficerContact.tsx</files>
  <action>
    In both PrivacyPolicy.tsx and InfoOfficerContact.tsx, replace all navigate(-1) calls
    with a goBack helper that falls back to navigate('/') when there is no history.

    In each component, add this helper function inside the component (after the useNavigate call):

    ```typescript
    function goBack() {
      if (window.history.length > 1) {
        navigate(-1)
      } else {
        navigate('/')
      }
    }
    ```

    Then replace every `navigate(-1)` call with `goBack()`.

    **PrivacyPolicy.tsx** has navigate(-1) in 3 places:
    - Line 33: error state "Go Back" button onClick
    - Line 50: header "Back" link onClick
    - Line 79: footer "Go Back" button onClick

    **InfoOfficerContact.tsx** has navigate(-1) in 3 places:
    - Line 62: error state "Go Back" button onClick
    - Line 79: header "Back" link onClick
    - Line 239: footer "Go Back" button onClick

    Replace all 6 occurrences with goBack().

    Why window.history.length > 1: When a page opens in a new tab (target="_blank"),
    window.history.length is 1 (only the current page). When navigated to from within
    the SPA, history.length > 1. This correctly distinguishes between the two cases.
  </action>
  <verify>
    1. `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit` passes
    2. `cd /opt/lampp/htdocs/wdi/frontend && npm run build` passes
    3. Grep PrivacyPolicy.tsx for `navigate(-1)` -- must find 0 matches
    4. Grep PrivacyPolicy.tsx for `goBack()` -- must find 3 matches
    5. Grep PrivacyPolicy.tsx for `navigate('/')` -- must find 1 match (in goBack helper)
    6. Grep InfoOfficerContact.tsx for `navigate(-1)` -- must find 0 matches
    7. Grep InfoOfficerContact.tsx for `goBack()` -- must find 3 matches
    8. Grep InfoOfficerContact.tsx for `navigate('/')` -- must find 1 match (in goBack helper)
  </verify>
  <done>
    All back buttons in PrivacyPolicy and InfoOfficerContact use goBack() helper that
    checks window.history.length and falls back to navigate('/') when opened in a new tab
    with no browser history. navigate(-1) no longer appears in either file.
  </done>
</task>

</tasks>

<verification>
1. `cd /opt/lampp/htdocs/wdi/frontend && npm run build` -- full build passes
2. main.tsx contains theme init from localStorage before createRoot()
3. PrivacyPolicy.tsx and InfoOfficerContact.tsx contain zero navigate(-1) calls
4. Both sub-page components have goBack() helper with navigate('/') fallback
5. No hard-coded color classes introduced (maintain DaisyUI semantic colors)
</verification>

<success_criteria>
- Dark theme selection persists when Privacy Policy or Info Officer pages load in new tabs
- Back buttons navigate to app root (/) when opened in new tabs with no history
- Back buttons still navigate(-1) correctly when opened from within the SPA
- Build passes with zero errors
- No regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-daisyui-integration/02.1-03-SUMMARY.md`
</output>
