---
phase: 08-post-purchase-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/will.py
  - backend/alembic/versions/007_add_will_versioning.py
  - backend/app/schemas/will.py
  - backend/app/services/will_service.py
  - backend/app/api/will.py
autonomous: true

must_haves:
  truths:
    - "Will model has version and current_section columns"
    - "API exposes PATCH current-section endpoint"
    - "API exposes POST regenerate endpoint that bypasses payment for paid wills"
    - "WillResponse schema includes version, current_section, and paid_at fields"
  artifacts:
    - path: "backend/alembic/versions/007_add_will_versioning.py"
      provides: "Migration adding version and current_section columns"
      contains: "version"
    - path: "backend/app/models/will.py"
      provides: "Will model with version and current_section fields"
      contains: "current_section"
    - path: "backend/app/api/will.py"
      provides: "update_current_section and regenerate_will endpoints"
      contains: "regenerate"
  key_links:
    - from: "backend/app/api/will.py"
      to: "backend/app/services/will_service.py"
      via: "WillService.update_current_section and WillService.increment_version"
      pattern: "update_current_section|increment_version"
---

<objective>
Add will versioning and session persistence columns to the backend, plus new API endpoints for current-section tracking and post-purchase re-generation.

Purpose: Foundation for save/resume and post-purchase update features. All other Phase 8 plans depend on these backend additions.
Output: Migration 007, updated Will model, new API endpoints, updated response schemas.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/models/will.py
@backend/app/schemas/will.py
@backend/app/services/will_service.py
@backend/app/api/will.py
@backend/app/api/payment.py
@backend/app/api/download.py
@backend/app/services/download_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 007 and Will model updates</name>
  <files>
    backend/app/models/will.py
    backend/alembic/versions/007_add_will_versioning.py
  </files>
  <action>
    Add two new columns to the Will model in `backend/app/models/will.py`:

    1. `version: int` — Integer column, nullable=False, server_default="1", default=1. Tracks how many times a paid will has been regenerated.
    2. `current_section: str` — String(50) column, nullable=False, server_default="'personal'", default="personal". Tracks user's wizard position for resume.

    Place both after `paid_at` and before `sections_complete`.

    Use `Column(Integer, nullable=False, server_default="1")` for version.
    Use `Column(String(50), nullable=False, server_default="'personal'")` for current_section.

    Create Alembic migration `007_add_will_versioning.py`:
    - Add `version` column (Integer, server_default="1", nullable=False)
    - Add `current_section` column (String(50), server_default="personal", nullable=False)
    - Downgrade: drop both columns

    Follow the existing migration pattern from 005/006 files. Use `op.add_column` and `op.drop_column`.

    **GOTCHA**: Do NOT double-quote server_default for String columns. Use `server_default="1"` for Integer and `server_default="personal"` for String (Alembic handles quoting).
  </action>
  <verify>
    Run `cd /opt/lampp/htdocs/wdi/backend && python -c "from app.models.will import Will; w = Will(); print(w.version, w.current_section)"` — should print `1 personal`.
  </verify>
  <done>Will model has `version` (int, default 1) and `current_section` (str, default "personal") columns. Migration 007 exists and is valid.</done>
</task>

<task type="auto">
  <name>Task 2: Schema, service, and API endpoint updates</name>
  <files>
    backend/app/schemas/will.py
    backend/app/services/will_service.py
    backend/app/api/will.py
  </files>
  <action>
    **1. Update WillResponse schema** (`backend/app/schemas/will.py`):
    Add these fields to the `WillResponse` class:
    - `version: int` (default 1)
    - `current_section: str` (default "personal")
    - `paid_at: datetime | None` (default None)

    Add a new request schema:
    ```python
    class CurrentSectionUpdate(BaseModel):
        """Request body for updating the user's current wizard section."""
        current_section: str
    ```

    **2. Update WillService** (`backend/app/services/will_service.py`):
    Add two new methods:

    a) `update_current_section(self, will_id, user_id, section: str) -> Will`:
       - Validate section is in VALID_SECTIONS or one of: "personal", "review", "verification", "document", "payment"
       - Fetch will with ownership check
       - Set `will.current_section = section`
       - Set `will.updated_at`
       - Flush and refresh
       - Return will

    b) `regenerate_will(self, will_id, user_id) -> Will`:
       - Fetch will with ownership check
       - If `will.paid_at is None`, raise HTTPException(402, "Payment required")
       - If `will.status != "verified"`, raise HTTPException(400, "Will must be re-verified before regeneration")
       - Increment `will.version` by 1
       - Set `will.status = "generated"`
       - Set `will.updated_at`
       - Flush and refresh
       - Return will

    **3. Add new endpoints** (`backend/app/api/will.py`):

    a) `PATCH /api/wills/{will_id}/current-section`:
       - Accept `CurrentSectionUpdate` body
       - Extract user_id, call `service.update_current_section`
       - Return WillResponse

    b) `POST /api/wills/{will_id}/regenerate`:
       - Extract user_id
       - Call `service.regenerate_will(will_id, user_id)` to validate paid_at and status
       - Get the original completed Payment for this will (query Payment where will_id matches and status == "completed", order by created_at desc, take first)
       - If no payment found, raise HTTPException(400, "No completed payment found")
       - Generate new download token via `generate_download_token(str(will_id), str(payment.id))`
       - Update `payment.download_token = new_token`
       - Flush
       - Return `{"download_token": new_token, "version": will.version}`

       This endpoint needs to import: `Payment` model, `generate_download_token`, `select` from sqlmodel, `AsyncSession` from database.

    Import `CurrentSectionUpdate` in the will.py API file's import block from `app.schemas.will`.
    Import `Payment` from `app.models.payment` and `generate_download_token` from `app.services.download_service`.
    Import `AsyncSession` via `Depends(get_session)` from `app.database`.
  </action>
  <verify>
    Run `cd /opt/lampp/htdocs/wdi/backend && python -c "from app.api.will import router; print([r.path for r in router.routes])"` — should include `/api/wills/{will_id}/current-section` and `/api/wills/{will_id}/regenerate`.
  </verify>
  <done>WillResponse includes version/current_section/paid_at. PATCH current-section and POST regenerate endpoints exist and work. Regenerate checks paid_at, increments version, generates new download token.</done>
</task>

</tasks>

<verification>
1. Will model has `version` and `current_section` fields with correct defaults
2. Migration 007 adds both columns
3. WillResponse schema includes `version`, `current_section`, `paid_at`
4. PATCH `/api/wills/{will_id}/current-section` endpoint exists
5. POST `/api/wills/{will_id}/regenerate` endpoint exists and checks `paid_at`
</verification>

<success_criteria>
- Migration 007 file exists with version + current_section columns
- Will model Python class has both new fields
- WillResponse exposes version, current_section, paid_at
- Two new API endpoints registered on the will router
- Regenerate endpoint enforces paid_at and verified status gates
</success_criteria>

<output>
After completion, create `.planning/phases/08-post-purchase-features/08-01-SUMMARY.md`
</output>
