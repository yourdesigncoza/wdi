---
phase: 08-post-purchase-features
plan: 04
type: execute
wave: 4
depends_on: ["08-01", "08-03"]
files_modified:
  - frontend/src/features/will/components/WillWizard.tsx
  - frontend/src/features/will/components/DocumentPreviewPage.tsx
  - frontend/src/features/will/components/WillDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit a paid will by resuming from dashboard"
    - "Editing a paid will resets status to draft but preserves paid_at"
    - "After re-verification, user can re-generate PDF without payment"
    - "Re-generation increments version and produces new download token"
  artifacts:
    - path: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      provides: "Conditional flow: Proceed to Payment vs Re-generate for paid wills"
      contains: "regenerate"
    - path: "frontend/src/features/will/components/WillWizard.tsx"
      provides: "Paid will edit resets status to draft"
      contains: "paid_at"
  key_links:
    - from: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      to: "frontend/src/services/api.ts"
      via: "regenerateWill API call for paid wills"
      pattern: "regenerateWill"
    - from: "frontend/src/features/will/components/WillDashboard.tsx"
      to: "frontend/src/features/will/components/WillWizard.tsx"
      via: "loadFromServer hydration then navigate to /will"
      pattern: "loadFromServer"
---

<objective>
Implement the post-purchase update flow: paid will editing resets to draft, re-verification is required, and re-generation bypasses payment using the new regenerate endpoint.

Purpose: Fulfills AUTH-06 (unlimited will updates after purchase) and Success Criteria #3/#4 of Phase 8. Users who have already paid can update and re-download their will without paying again.
Output: Conditional payment/re-generation flow, version tracking in UI.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-post-purchase-features/08-01-SUMMARY.md
@.planning/phases/08-post-purchase-features/08-03-SUMMARY.md
@frontend/src/features/will/components/WillWizard.tsx
@frontend/src/features/will/components/DocumentPreviewPage.tsx
@frontend/src/features/will/components/WillDashboard.tsx
@frontend/src/services/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Paid will edit flow and status reset in WillWizard</name>
  <files>
    frontend/src/features/will/components/WillWizard.tsx
  </files>
  <action>
    Update `WillWizard.tsx` to handle the paid will update flow:

    **1. Track paid status in WillWizard:**
    Add a state variable to track whether the current will has been paid for:
    ```typescript
    const [isPaidWill, setIsPaidWill] = useState(false)
    ```

    **2. Detect paid will on load:**
    When the wizard mounts, if `willId` exists, check the will's paid status. Add a useEffect:
    ```typescript
    useEffect(() => {
      if (!willId) {
        setIsPaidWill(false)
        return
      }
      // Check if will is paid (need to fetch current status)
      getWill(willId)
        .then((will) => {
          if (will.paid_at) {
            setIsPaidWill(true)
          }
        })
        .catch(() => {
          // Ignore fetch errors — will be caught elsewhere
        })
    }, [willId])
    ```
    Import `getWill` from `'../../../services/api.ts'`.

    **3. Reset status on edit:**
    When a paid will starts being edited (user modifies any section), the backend status should be reset to "draft". Add a function:
    ```typescript
    const resetPaidWillStatus = useCallback(async () => {
      if (!willId || !isPaidWill) return
      try {
        await updateWillSection(willId, 'testator', useWillStore.getState().testator)
        // The backend auto-updates updated_at; status reset happens via explicit call
        // We need to call updateWillStatus — but that's not exposed as API yet
        // Alternative: rely on the existing flow where moving through sections
        // naturally resets the verification/generation status
      } catch (err) {
        console.error('Failed to reset will status:', err)
      }
    }, [willId, isPaidWill])
    ```

    Actually, a simpler approach: when navigating BACK from a terminal section (document/payment) to an editing section on a paid will, the backend verification and generation status will naturally become stale. The user must re-verify, which the existing verification flow enforces. No explicit status reset is needed on the frontend -- the verification page already gates document generation, and document preview gates payment.

    **Instead, the key change is in ensureWillExists:**
    Modify `ensureWillExists` to also handle the case where `willId` is already set (from resume/loadFromServer) and the will exists in the DB. Currently it short-circuits if `willId` exists. This is correct behavior -- no change needed here.

    **4. Pass `isPaidWill` down to document section:**
    When rendering the `document` section, pass the paid status:
    ```tsx
    return (
      <DocumentPreviewPage
        willId={willId}
        isPaidWill={isPaidWill}
        onBack={() => setCurrentSection('verification')}
        onProceedToPayment={() => setCurrentSection('payment')}
      />
    )
    ```

    **5. Skip payment section for paid wills:**
    After document preview, if `isPaidWill` is true, the flow should NOT go to payment. Instead, DocumentPreviewPage will handle re-generation directly (see Task 2). The WillWizard does not need to change the payment routing -- it is handled by the DocumentPreviewPage callbacks.
  </action>
  <verify>
    Run `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit 2>&1 | head -20` — no errors.
    Grep: `grep -n "isPaidWill" frontend/src/features/will/components/WillWizard.tsx` — should find the state and the prop.
  </verify>
  <done>WillWizard detects paid wills on load and passes isPaidWill prop to DocumentPreviewPage. No duplicate wills created on resume.</done>
</task>

<task type="auto">
  <name>Task 2: Conditional re-generation vs payment in DocumentPreviewPage</name>
  <files>
    frontend/src/features/will/components/DocumentPreviewPage.tsx
    frontend/src/features/will/components/WillDashboard.tsx
  </files>
  <action>
    **1. Update DocumentPreviewPage** to accept `isPaidWill` prop and show conditional flow:

    Read `frontend/src/features/will/components/DocumentPreviewPage.tsx` first to understand its current structure.

    Add `isPaidWill?: boolean` to the component's props interface.

    When `isPaidWill` is true, replace the "Proceed to Payment" button with a "Re-generate Will" button:

    a) Add state for re-generation:
    ```typescript
    const [isRegenerating, setIsRegenerating] = useState(false)
    const [regenerateResult, setRegenerateResult] = useState<{ download_token: string; version: number } | null>(null)
    ```

    b) Add handler:
    ```typescript
    const handleRegenerate = async () => {
      setIsRegenerating(true)
      try {
        const result = await regenerateWill(willId)
        setRegenerateResult(result)
      } catch (err) {
        console.error('Re-generation failed:', err)
        // Show error to user
      } finally {
        setIsRegenerating(false)
      }
    }
    ```
    Import `regenerateWill` from `'../../../services/api.ts'`.

    c) Conditional button rendering in the action area:
    - If `isPaidWill` AND no `regenerateResult`: Show "Re-generate Will (Free)" button with `btn btn-neutral`. On click: `handleRegenerate`. Show spinner when `isRegenerating`.
    - If `isPaidWill` AND `regenerateResult`: Show success message "Will updated to version {version}!" and a "Download Updated Will" button that navigates to `/download/{regenerateResult.download_token}`.
    - If NOT `isPaidWill`: Show the existing "Proceed to Payment" button (current behavior).

    d) Also show a "Back to Dashboard" link (Link to "/") for paid wills, so the user can return after re-generation.

    Import `Link, useNavigate` from `react-router-dom` if not already imported.

    **2. Update WillDashboard** to show download button for paid wills that have a completed payment:

    In the WillDashboard will cards, for paid wills:
    - Show the "Update Will" button (already planned in 08-03)
    - Additionally show the will version: "Version {will.version}" text

    No other dashboard changes needed here — the download token is generated during re-generation and the user is directed to the download page from DocumentPreviewPage.

    **IMPORTANT**: The `regenerateWill` API call requires the will to be in "verified" status. If the user edits a section and the will reverts to "draft", they must go through verification again before re-generation. The existing wizard flow (verification -> document) already enforces this. The re-generate button only appears on the DocumentPreviewPage which is only reachable after verification.
  </action>
  <verify>
    Run `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit 2>&1 | head -20` — no errors.
    Grep: `grep -n "regenerateWill\|isPaidWill\|Re-generate" frontend/src/features/will/components/DocumentPreviewPage.tsx` — should show the conditional flow.
  </verify>
  <done>DocumentPreviewPage shows "Re-generate Will (Free)" for paid wills instead of "Proceed to Payment". Re-generation calls backend, gets new download token, shows download link. Dashboard shows version number.</done>
</task>

</tasks>

<verification>
1. WillWizard detects paid_at on will load and sets isPaidWill flag
2. DocumentPreviewPage shows "Re-generate" button when isPaidWill is true
3. Re-generation calls POST /api/wills/{id}/regenerate endpoint
4. Success shows new download link with updated version
5. Unpaid wills still show "Proceed to Payment" (existing flow preserved)
6. Dashboard shows version number for wills with version > 1
7. Frontend compiles without errors
</verification>

<success_criteria>
- Paid wills can be edited and re-verified through the normal wizard flow
- DocumentPreviewPage conditionally shows re-generation for paid wills
- Re-generation produces a new download token without payment
- Version is incremented and displayed
- Existing payment flow for unpaid wills is unchanged
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-post-purchase-features/08-04-SUMMARY.md`
</output>
