---
phase: 05-ai-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/verification.py
  - backend/app/prompts/verification.py
autonomous: true

must_haves:
  truths:
    - "Verification result schema defines Error/Warning/Info severity levels"
    - "SA Wills Act rules encoded as verification check definitions"
    - "Verification prompt instructs Gemini to check completeness, consistency, and compliance"
    - "Attorney referral triggers defined for complex scenarios and unusual patterns"
  artifacts:
    - path: "backend/app/schemas/verification.py"
      provides: "Pydantic models for verification results (VerificationResult, VerificationIssue, SectionResult)"
      min_lines: 60
    - path: "backend/app/prompts/verification.py"
      provides: "System prompt and SA Wills Act rule definitions for verification"
      min_lines: 80
  key_links:
    - from: "backend/app/schemas/verification.py"
      to: "backend/app/prompts/verification.py"
      via: "Schema referenced in prompt for structured output"
      pattern: "VerificationResult"
---

<objective>
Define verification schemas (Pydantic models for Gemini structured output) and SA Wills Act verification rules/prompts.

Purpose: The data contracts and rule definitions that drive the verification flow. Schemas define what Gemini returns; prompts define what Gemini checks.
Output: Verification Pydantic schemas and verification prompt with embedded SA Wills Act rules.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-verification/05-RESEARCH.md
@backend/app/schemas/will.py
@backend/app/prompts/system.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verification Pydantic schemas</name>
  <files>backend/app/schemas/verification.py</files>
  <action>
    Create backend/app/schemas/verification.py with these Pydantic models (used as Gemini structured output schema AND API response models):

    1. `IssueSeverity` -- str enum: "error", "warning", "info"

    2. `VerificationIssue`:
       - `code: str` -- machine-readable code (e.g. "MISSING_TESTATOR", "NO_BACKUP_EXECUTOR")
       - `severity: IssueSeverity`
       - `section: str` -- which will section this relates to (e.g. "testator", "beneficiaries")
       - `title: str` -- short human-readable title
       - `explanation: str` -- plain-language explanation of WHY this is a problem
       - `suggestion: str` -- what the user should do to fix it

    3. `SectionResult`:
       - `section: str` -- section name
       - `status: str` -- "pass", "warning", "error"
       - `issues: list[VerificationIssue]` -- issues found in this section (empty = pass)

    4. `AttorneyReferral`:
       - `recommended: bool` -- whether attorney consultation is recommended
       - `reasons: list[str]` -- list of reasons (e.g. "Testamentary trust provisions detected")

    5. `VerificationResult`:
       - `overall_status: str` -- "pass", "warning", "error" (worst severity found)
       - `sections: list[SectionResult]` -- per-section results
       - `attorney_referral: AttorneyReferral` -- attorney recommendation
       - `summary: str` -- one-paragraph plain-language summary of verification findings

    6. API-specific response models (not sent to Gemini):
       - `VerificationResponse` -- wraps VerificationResult + `verified_at: str` + `has_blocking_errors: bool`
       - `AcknowledgeWarningsRequest` -- `warning_codes: list[str]`
       - `AcknowledgeWarningsResponse` -- `acknowledged: list[str]` + `can_proceed: bool`

    IMPORTANT: Keep schema flat with str enums (not Python Enum classes) for Gemini structured output compatibility. Use `Literal` types where possible for constrained string fields.
  </action>
  <verify>
    cd backend && python -c "
from app.schemas.verification import VerificationResult, VerificationIssue, SectionResult, AttorneyReferral
r = VerificationResult(
    overall_status='warning',
    sections=[SectionResult(section='testator', status='pass', issues=[])],
    attorney_referral=AttorneyReferral(recommended=False, reasons=[]),
    summary='All good'
)
print('Schema OK:', r.overall_status)
"
  </verify>
  <done>
    VerificationResult, VerificationIssue, SectionResult, AttorneyReferral schemas defined with proper types. API response wrappers (VerificationResponse, AcknowledgeWarningsRequest/Response) defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verification prompt with SA Wills Act rules</name>
  <files>backend/app/prompts/verification.py</files>
  <action>
    Create backend/app/prompts/verification.py containing:

    1. `VERIFICATION_RULES` -- a dict organizing SA Wills Act checks by severity:

       **Errors (must block generation):**
       - MISSING_TESTATOR: Testator personal details incomplete (name, ID, address required)
       - INVALID_ID_NUMBER: SA ID number fails Luhn check or is wrong length (13 digits)
       - TESTATOR_UNDER_16: Testator must be 16+ per Wills Act s4
       - NO_BENEFICIARIES: Will must have at least one beneficiary
       - NO_EXECUTOR: Will must nominate an executor
       - NO_RESIDUE_CLAUSE: Will must address residual estate distribution
       - PERCENTAGES_EXCEED_100: Beneficiary percentages in any category exceed 100%
       - RESIDUE_PERCENTAGES_INVALID: Residue distribution percentages don't sum to 100%
       - MINOR_NO_PROVISION: Minor beneficiary inheriting without trust or guardian provision

       **Warnings (need acknowledgment):**
       - NO_BACKUP_EXECUTOR: No alternate executor nominated
       - NO_ALTERNATE_BENEFICIARY: No alternate beneficiaries if primary predeceases
       - NO_GUARDIANS_WITH_MINORS: Minor children exist but no guardians nominated
       - COMMUNITY_PROPERTY_HALF: Married in community of property -- can only bequeath own half
       - JOINT_WILL_IRREVOCABLE: Joint will becomes irrevocable on first death (s2B Wills Act)
       - NO_SIMULTANEOUS_DEATH: No provision for simultaneous death of spouses
       - BUSINESS_NO_BUY_SELL: Business assets without succession/buy-sell reference

       **Info (helpful tips):**
       - RECOMMEND_PROFESSIONAL_EXECUTOR: Large/complex estate may benefit from professional executor
       - TRUST_VESTING_AGE: Trust vesting age should typically be 18-25
       - KEEP_WILL_UPDATED: Remind to update will after major life events

    2. `ATTORNEY_REFERRAL_TRIGGERS` -- list of conditions that trigger attorney recommendation:
       - Complex scenarios: trusts, usufruct, business succession, international assets, disinheriting dependents
       - Unusual patterns: very unequal distribution, leaving everything to non-family, no executor, very large estate

    3. `build_verification_prompt(will_data: dict) -> str`:
       - Takes the full will JSONB data as a dict
       - Returns a complete system instruction for Gemini that:
         - Identifies itself as a SA will verification system
         - Lists all rules to check (from VERIFICATION_RULES)
         - Includes the will data as JSON to analyze
         - Instructs to return structured output matching VerificationResult schema
         - Instructs to check completeness (all required sections filled), consistency (cross-section data matches), and SA Wills Act compliance
         - Instructs to evaluate attorney referral triggers
         - Uses generic recommendation language: "We recommend consulting a qualified attorney"
         - Maintains UPL boundary: system verifies data completeness, NOT legal validity

    Follow the pattern in backend/app/prompts/system.py for prompt organization (constants + builder function).
  </action>
  <verify>
    cd backend && python -c "
from app.prompts.verification import build_verification_prompt, VERIFICATION_RULES
prompt = build_verification_prompt({'testator': {'firstName': 'Test'}})
print('Prompt length:', len(prompt))
print('Has rules:', 'MISSING_TESTATOR' in prompt)
print('Has UPL:', 'legal advice' in prompt.lower() or 'not legal' in prompt.lower())
"
  </verify>
  <done>
    VERIFICATION_RULES dict with 9 errors, 7 warnings, 3 info rules defined. ATTORNEY_REFERRAL_TRIGGERS defined. build_verification_prompt() generates a complete verification system instruction including will data, all rules, and UPL boundaries.
  </done>
</task>

</tasks>

<verification>
1. All Pydantic schemas import and instantiate correctly
2. VerificationResult can be serialized to JSON (for Gemini response_schema)
3. build_verification_prompt produces a prompt containing all rule codes
4. Attorney referral triggers are defined
5. Prompt includes UPL boundary language
</verification>

<success_criteria>
- VerificationResult schema with sections, issues (3 severity levels), attorney_referral, summary
- SA Wills Act rules defined: 9 errors, 7 warnings, 3 info
- Verification prompt builder generates complete Gemini instruction
- Attorney referral triggers defined for complex scenarios and unusual patterns
- All models importable and JSON-serializable
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-verification/05-02-SUMMARY.md`
</output>
