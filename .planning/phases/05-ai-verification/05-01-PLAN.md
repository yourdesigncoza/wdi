---
phase: 05-ai-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/config.py
  - backend/app/services/gemini_service.py
  - backend/app/models/will.py
  - backend/alembic/versions/005_add_verification_columns.py
autonomous: true
user_setup:
  - service: gemini
    why: "Gemini API for dual-LLM verification"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API Key (https://aistudio.google.com/apikey)"

must_haves:
  truths:
    - "Gemini SDK installed and importable"
    - "GeminiService can make async structured-output API calls"
    - "Will model has verification_result, verified_at, acknowledged_warnings columns"
    - "Migration 005 applies cleanly on top of 004"
  artifacts:
    - path: "backend/app/services/gemini_service.py"
      provides: "Async Gemini API client with Pydantic structured output"
      min_lines: 40
    - path: "backend/alembic/versions/005_add_verification_columns.py"
      provides: "Migration adding verification columns to wills table"
      contains: "verification_result"
  key_links:
    - from: "backend/app/services/gemini_service.py"
      to: "backend/app/config.py"
      via: "GEMINI_API_KEY and GEMINI_MODEL settings"
      pattern: "settings\\.GEMINI"
    - from: "backend/app/models/will.py"
      to: "backend/alembic/versions/005_add_verification_columns.py"
      via: "model columns match migration"
      pattern: "verification_result"
---

<objective>
Set up Gemini SDK integration, configuration, and database schema for the verification layer.

Purpose: Foundation for Phase 5 -- install google-genai, create thin async Gemini service wrapper, add verification columns to Will model, create Alembic migration.
Output: Working GeminiService, updated Will model with verification columns, migration 005.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/config.py
@backend/app/models/will.py
@backend/app/services/openai_service.py
@backend/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gemini SDK setup, config, and service</name>
  <files>
    backend/requirements.txt
    backend/app/config.py
    backend/app/services/gemini_service.py
  </files>
  <action>
    1. Add `google-genai>=1.62.0` to backend/requirements.txt (after openai line).

    2. Add two settings to backend/app/config.py Settings class:
       - `GEMINI_API_KEY: str = ""` (empty = verification disabled/fallback)
       - `GEMINI_MODEL: str = "gemini-2.5-flash"` (cost-effective for verification)

    3. Create backend/app/services/gemini_service.py with a GeminiService class:
       - Constructor takes `api_key: str` and `model: str` params
       - Creates `genai.Client(api_key=api_key)` client
       - Method `async def verify(self, will_data: dict, response_schema: type[T]) -> T`:
         - Uses `client.aio.models.generate_content()` with:
           - `response_mime_type="application/json"`
           - `response_schema=response_schema` (Pydantic model)
           - `temperature=0.1` (deterministic verification)
         - Returns `response.parsed` (typed Pydantic object)
         - Raises on API errors (let caller handle fallback)
       - Method `async def is_available(self) -> bool`:
         - Returns False if api_key is empty
         - Makes a minimal test call wrapped in try/except, returns True/False
       - Follow the same thin-wrapper pattern as OpenAIService (constructor with client init, async methods)

    Import pattern: `from google import genai` and `from google.genai import types`
    Do NOT use the old `google-generativeai` package. Use `google-genai` (the new unified SDK).
  </action>
  <verify>
    cd backend && pip install -r requirements.txt && python -c "from app.services.gemini_service import GeminiService; print('GeminiService imported OK')"
  </verify>
  <done>
    google-genai installed, GeminiService importable with verify() and is_available() methods, config has GEMINI_API_KEY and GEMINI_MODEL settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Will model verification columns and migration 005</name>
  <files>
    backend/app/models/will.py
    backend/alembic/versions/005_add_verification_columns.py
  </files>
  <action>
    1. Add three new columns to the Will model in backend/app/models/will.py, placed after the `sections_complete` field and before `created_at`:
       - `verification_result: dict | None` -- JSONB, nullable=True, default=None (stores full VerificationResult JSON)
       - `verified_at: datetime | None` -- DateTime(timezone=True), nullable=True, default=None
       - `acknowledged_warnings: list` -- JSONB, nullable=False, server_default="'[]'" (list of acknowledged warning codes)

       Use the same sa_column pattern as existing fields:
       ```python
       verification_result: dict | None = Field(
           default=None,
           sa_column=Column(JSONB, nullable=True),
       )
       verified_at: datetime | None = Field(
           default=None,
           sa_column=Column(DateTime(timezone=True), nullable=True),
       )
       acknowledged_warnings: list = Field(
           default_factory=list,
           sa_column=Column(JSONB, nullable=False, server_default="'[]'"),
       )
       ```

    2. Create backend/alembic/versions/005_add_verification_columns.py:
       - Revision depends on 004 (check 004's revision ID from the file)
       - upgrade(): Add three columns to 'wills' table:
         - sa.Column('verification_result', postgresql.JSONB, nullable=True)
         - sa.Column('verified_at', sa.DateTime(timezone=True), nullable=True)
         - sa.Column('acknowledged_warnings', postgresql.JSONB, nullable=False, server_default="'[]'")
       - downgrade(): Drop those three columns

       Follow the same pattern as existing migrations. Use `from alembic import op` and `import sqlalchemy as sa` and `from sqlalchemy.dialects import postgresql`.

    GOTCHA: For JSONB server_default, use `server_default="'[]'"` (the outer quotes are for Python string, inner single quotes are the SQL literal). This matches the established pattern in this codebase.
  </action>
  <verify>
    cd backend && python -c "from app.models.will import Will; w = Will(); print('verified_at:', w.verified_at, 'acknowledged_warnings:', w.acknowledged_warnings)"
    cd backend && alembic upgrade head
  </verify>
  <done>
    Will model has verification_result (JSONB nullable), verified_at (DateTime nullable), acknowledged_warnings (JSONB default []) columns. Migration 005 applies cleanly.
  </done>
</task>

</tasks>

<verification>
1. `pip install -r requirements.txt` succeeds with google-genai
2. `python -c "from google import genai"` imports successfully
3. `python -c "from app.services.gemini_service import GeminiService"` imports successfully
4. `python -c "from app.config import settings; print(settings.GEMINI_API_KEY, settings.GEMINI_MODEL)"` prints defaults
5. `alembic upgrade head` runs migration 005 without errors
6. Will model instantiates with new verification fields
</verification>

<success_criteria>
- google-genai SDK installed and importable
- GeminiService class with verify() and is_available() async methods
- Will model extended with verification_result, verified_at, acknowledged_warnings
- Migration 005 applies cleanly
- Config has GEMINI_API_KEY and GEMINI_MODEL settings
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-verification/05-01-SUMMARY.md`
</output>
