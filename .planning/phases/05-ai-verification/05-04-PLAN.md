---
phase: 05-ai-verification
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - frontend/src/features/will/types/verification.ts
  - frontend/src/features/will/hooks/useVerification.ts
  - frontend/src/services/api.ts
  - frontend/src/features/will/components/VerificationPage.tsx
  - frontend/src/features/will/components/WillWizard.tsx
  - frontend/src/features/will/types/will.ts
  - frontend/src/features/will/store/useWillStore.ts
autonomous: false

must_haves:
  truths:
    - "User can trigger verification from wizard after completing all sections"
    - "User sees live checklist progress during verification (SSE streaming)"
    - "User sees verification results: green/yellow/red summary card with section breakdown"
    - "User can acknowledge warnings and proceed"
    - "User cannot proceed to generation if blocking errors exist"
    - "Issues link back to relevant section for fixing"
    - "Attorney referral notification appears when triggered"
  artifacts:
    - path: "frontend/src/features/will/components/VerificationPage.tsx"
      provides: "Full verification UI: trigger button, progress checklist, results card, section breakdown, attorney referral"
      min_lines: 100
    - path: "frontend/src/features/will/hooks/useVerification.ts"
      provides: "SSE streaming hook for verification progress events"
      min_lines: 40
    - path: "frontend/src/features/will/types/verification.ts"
      provides: "TypeScript types matching backend verification schemas"
      min_lines: 30
  key_links:
    - from: "frontend/src/features/will/hooks/useVerification.ts"
      to: "/api/wills/{id}/verify"
      via: "SSE EventSource to POST endpoint"
      pattern: "verify|EventSource|fetch"
    - from: "frontend/src/features/will/components/VerificationPage.tsx"
      to: "frontend/src/features/will/hooks/useVerification.ts"
      via: "useVerification hook"
      pattern: "useVerification"
    - from: "frontend/src/features/will/components/WillWizard.tsx"
      to: "frontend/src/features/will/components/VerificationPage.tsx"
      via: "verification section in wizard"
      pattern: "VerificationPage|verification"
---

<objective>
Build the frontend verification UI: types, SSE hook, VerificationPage component, and wizard integration.

Purpose: Users see a live verification checklist, results with green/yellow/red status, section-by-section breakdown, attorney referral notification, and can acknowledge warnings before proceeding.
Output: Complete verification UI integrated into the will wizard.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-verification/05-03-SUMMARY.md
@frontend/src/features/will/components/WillWizard.tsx
@frontend/src/features/will/hooks/useConversation.ts
@frontend/src/features/will/store/useWillStore.ts
@frontend/src/features/will/types/will.ts
@frontend/src/services/api.ts
@backend/app/schemas/verification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verification types, hook, and API client methods</name>
  <files>
    frontend/src/features/will/types/verification.ts
    frontend/src/features/will/hooks/useVerification.ts
    frontend/src/services/api.ts
  </files>
  <action>
    1. Create frontend/src/features/will/types/verification.ts:
       - `IssueSeverity` type: "error" | "warning" | "info"
       - `VerificationIssue`: { code, severity, section, title, explanation, suggestion }
       - `SectionResult`: { section, status: "pass"|"warning"|"error", issues: VerificationIssue[] }
       - `AttorneyReferral`: { recommended: boolean, reasons: string[] }
       - `VerificationResult`: { overall_status, sections: SectionResult[], attorney_referral, summary }
       - `VerificationResponse`: extends VerificationResult + verified_at, has_blocking_errors, acknowledged_warnings
       - `VerificationProgress`: { step: string, message: string } (for SSE check events)
       - `SectionProgressEvent`: { section: string, status: string, issue_count: number }
       Must mirror backend schemas exactly.

    2. Create frontend/src/features/will/hooks/useVerification.ts:
       SSE streaming hook following the same pattern as useConversation.ts.

       ```typescript
       export function useVerification(willId: string | null) {
         // State: isVerifying, progress (VerificationProgress[]), sectionResults (SectionProgressEvent[]), result (VerificationResult | null), error
         // startVerification(): connects to POST /api/wills/{willId}/verify via fetch + ReadableStream
         //   - Parses SSE events: "check" -> append to progress, "section_result" -> append to sectionResults, "done" -> set result, "error" -> set error
         //   - Uses the same SSE parsing approach as useConversation (manual line-by-line parsing of event: and data: lines from ReadableStream)
         //   - Sets isVerifying=false when done/error received
         // Return: { isVerifying, progress, sectionResults, result, error, startVerification }
       }
       ```

       IMPORTANT: Use fetch + ReadableStream for SSE (not EventSource), matching the existing pattern in useConversation.ts for POST requests. EventSource only supports GET.

    3. Add to frontend/src/services/api.ts:
       - `getVerificationResult(willId: string): Promise<VerificationResponse>` -- GET /api/wills/{willId}/verification
       - `acknowledgeWarnings(willId: string, warningCodes: string[]): Promise<{ acknowledged: string[], can_proceed: boolean }>` -- POST /api/wills/{willId}/acknowledge-warnings
       Follow existing request() helper pattern.
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>
    TypeScript types mirror backend schemas. useVerification hook streams SSE events via fetch+ReadableStream. API client has getVerificationResult and acknowledgeWarnings methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: VerificationPage component and wizard integration</name>
  <files>
    frontend/src/features/will/components/VerificationPage.tsx
    frontend/src/features/will/components/WillWizard.tsx
    frontend/src/features/will/types/will.ts
    frontend/src/features/will/store/useWillStore.ts
  </files>
  <action>
    1. Create frontend/src/features/will/components/VerificationPage.tsx:

    **Layout (3 states):**

    **State A - Not yet verified (initial):**
    - Summary text: "Verify your will before generating the document"
    - "Verify My Will" button (btn-primary, large)
    - Manual trigger -- user clicks to start (per user decision: manual re-verify button, not auto)

    **State B - Verification in progress:**
    - Live checklist using DaisyUI steps or list component:
      - Each progress step shows with a loading spinner (loading-spinner) while active
      - Completed steps show checkmark
      - Map progress[] array to step items
    - Section results appear as they stream in:
      - Pass = green badge, Warning = yellow badge, Error = red badge
      - Show issue_count next to each section

    **State C - Verification complete (result available):**
    - **Top summary card** using DaisyUI alert:
      - Green (alert-success): "Your will is ready for document generation"
      - Yellow (alert-warning): "Your will has warnings that need acknowledgment"
      - Red (alert-error): "Your will has errors that must be fixed"
    - **Section-by-section breakdown** using DaisyUI collapse/accordion:
      - Each section: header with name + status badge
      - Expandable: list of issues with severity icon, title, explanation, suggestion
      - Each issue has a "Go to section" link that navigates back to that section via setCurrentSection()
    - **Attorney referral notification** (if recommended):
      - DaisyUI alert-info card at bottom
      - "We recommend consulting a qualified attorney" + list of reasons
      - Non-blocking -- notification style, never gates progress
    - **Warning acknowledgment:**
      - If warnings exist: checkbox per warning "I acknowledge this warning"
      - Or bulk "Acknowledge all warnings" button
      - Calls acknowledgeWarnings API on click
    - **Action buttons:**
      - If errors: "Fix Issues" button (primary, navigates to first section with errors)
      - If warnings unacknowledged: "Acknowledge Warnings" button
      - If all clear or warnings acknowledged: "Proceed to Document Generation" button (disabled -- Phase 6)
      - "Re-verify" button (secondary, re-runs verification)

    Use DaisyUI classes throughout: card, alert, badge, collapse, btn, steps, checkbox.

    2. Add 'verification' to WILL_SECTIONS in frontend/src/features/will/types/will.ts:
       - Insert 'verification' after 'review' in the WILL_SECTIONS array
       - This adds it as the final step before document generation

    3. Update frontend/src/features/will/store/useWillStore.ts:
       - Add `verificationResult: VerificationResult | null` to WillState (default null)
       - Add `setVerificationResult: (result: VerificationResult | null) => void` to WillActions
       - Add `acknowledgedWarnings: string[]` to WillState (default [])
       - Add `setAcknowledgedWarnings: (codes: string[]) => void` to WillActions

    4. Update frontend/src/features/will/components/WillWizard.tsx:
       - Import VerificationPage
       - Add 'verification' case to the section rendering logic:
         ```
         if (currentSection === 'verification') {
           return <VerificationPage />
         }
         ```
       - Ensure the step indicator shows "Verification" as the final step
       - User reaches verification after review section (natural flow: review -> verification)

    Style: Use the project's existing DaisyUI theme (corporate/business). Keep visual language consistent with existing components (SectionReview, ChatSection patterns).
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | head -20
    cd frontend && npm run build 2>&1 | tail -10
  </verify>
  <done>
    VerificationPage renders three states (initial, in-progress, complete). Live checklist shows during verification. Results show green/yellow/red summary + section breakdown. Issues link back to sections. Attorney referral appears as non-blocking notification. Warning acknowledgment works. Wizard has verification as final step after review.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete AI verification flow: Gemini verifies will data, streams progress via SSE, shows results with green/yellow/red summary, section-by-section breakdown, attorney referral notification, and warning acknowledgment.
  </what-built>
  <how-to-verify>
    1. Start backend: cd backend && uvicorn app.main:app --reload
    2. Start frontend: cd frontend && npm run dev
    3. Navigate to will wizard and complete at least testator + beneficiaries + executor + residue sections
    4. Navigate past review to the Verification step
    5. Click "Verify My Will" button
    6. Verify: Live checklist appears with progress steps
    7. Verify: Section results stream in with pass/warning/error badges
    8. Verify: Summary card shows correct color (green/yellow/red)
    9. Verify: Section breakdown is expandable with issue details
    10. Verify: Issues have "Go to section" links that navigate correctly
    11. If warnings present: acknowledge them and verify "Proceed" button enables
    12. If attorney referral shows: verify it's non-blocking notification style
    13. Click "Re-verify" and confirm it runs again
    14. Note: If GEMINI_API_KEY not set, verify OpenAI fallback activates (check backend logs)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Frontend builds successfully
3. Verification section appears in wizard step indicator
4. SSE streaming works with progress events
5. Results display with proper DaisyUI styling
6. Section navigation from issues works
7. Warning acknowledgment persists
8. Attorney referral shows when triggered
</verification>

<success_criteria>
- User triggers verification from wizard (manual button, not auto)
- Live checklist streams during verification
- Results: green/yellow/red summary card + expandable section breakdown
- Each issue has plain-language explanation + "Go to section" link
- Warnings can be acknowledged (checkbox/bulk button)
- Attorney referral appears as non-blocking notification
- Blocking errors prevent proceeding
- Re-verify button available
- Human-verified checkpoint passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-verification/05-04-SUMMARY.md`
</output>
