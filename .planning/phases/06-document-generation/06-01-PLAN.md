---
phase: 06-document-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/templates/will/base.html
  - backend/app/templates/will/cover_page.html
  - backend/app/templates/will/will_body.html
  - backend/app/templates/will/signature_page.html
  - backend/app/templates/will/instruction_sheet.html
autonomous: true

must_haves:
  truths:
    - "WeasyPrint is installed and importable in the backend venv"
    - "HTML templates render a complete will document structure (cover, body, signature, instructions)"
    - "CSS Paged Media produces A4 pages with 25mm margins, page numbers, and initials lines"
    - "Watermark conditionally appears on all pages when is_preview is true"
  artifacts:
    - path: "backend/app/templates/will/base.html"
      provides: "Master HTML template with CSS Paged Media, watermark, and block structure"
      min_lines: 80
    - path: "backend/app/templates/will/cover_page.html"
      provides: "Cover page with testator name, date, reference, disclaimer, attorney recommendation"
      min_lines: 30
    - path: "backend/app/templates/will/will_body.html"
      provides: "Will body with hierarchical numbered clause rendering loop"
      min_lines: 20
    - path: "backend/app/templates/will/signature_page.html"
      provides: "Full signature page with testator line, 2 witness blocks"
      min_lines: 30
    - path: "backend/app/templates/will/instruction_sheet.html"
      provides: "Witness instruction sheet with SA signing requirements"
      min_lines: 30
  key_links:
    - from: "backend/app/templates/will/base.html"
      to: "cover_page.html, will_body.html, signature_page.html, instruction_sheet.html"
      via: "Jinja2 {% include %} blocks"
      pattern: "include.*\\.html"
---

<objective>
Install WeasyPrint and create the full set of Jinja2 HTML templates with CSS Paged Media styling for SA will document generation.

Purpose: These templates are the rendering foundation -- they define what the PDF looks like. The DocumentGenerationService (Plan 02) feeds data into these templates.
Output: WeasyPrint in requirements.txt, 5 HTML template files under backend/app/templates/will/
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-generation/06-RESEARCH.md
@backend/requirements.txt
@backend/scripts/seed_clauses.py (clause codes and template_text for reference)
@backend/app/models/clause.py (ClauseCategory, WillType enums)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install WeasyPrint and create base HTML template with CSS Paged Media</name>
  <files>
    backend/requirements.txt
    backend/app/templates/will/base.html
  </files>
  <action>
    1. Add `weasyprint>=68.0` to backend/requirements.txt (after existing deps, before testing section).
    2. Run `pip install weasyprint>=68.0` in the backend venv. If import fails due to missing system libs, try `sudo apt install libharfbuzz-subset0` then retry.
    3. Create `backend/app/templates/will/` directory.
    4. Create `base.html` -- the master Jinja2 template. This is the single HTML file passed to WeasyPrint. Structure:

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head><meta charset="UTF-8"><title>Last Will and Testament</title></head>
    <body>
      {% if is_preview %}
      <div class="watermark-overlay">PREVIEW — NOT VALID</div>
      {% endif %}

      {% include "cover_page.html" %}
      {% include "will_body.html" %}
      {% include "signature_page.html" %}
      <div class="instruction-break"></div>
      {% include "instruction_sheet.html" %}
    </body>
    </html>
    ```

    5. Embed full CSS in a `<style>` block inside `<head>`. CSS must include:

    **@page rules (CSS Paged Media):**
    - `size: A4; margin: 25mm 25mm 30mm 25mm;`
    - `@bottom-center`: `content: "Page " counter(page) " of " counter(pages);` -- Liberation Serif, 9pt, #666
    - `@bottom-right`: `content: "Initials: ______ / ______ / ______";` -- 8pt, #999
    - `@page :first` -- suppress bottom-center and bottom-right (cover page has no page number or initials)

    **Typography:**
    - `body`: font-family "Liberation Serif", "Times New Roman", serif; font-size 12pt; line-height 1.5; color #000
    - `.clause-title`: 12pt bold
    - `.sub-clause`: margin-left 20pt
    - `.sub-sub-clause`: margin-left 40pt

    **Watermark (position: fixed for WeasyPrint -- repeats on every page):**
    - `.watermark-overlay`: position fixed, top 30%, left 5%, width 90%, text-align center, font-size 72pt, color rgba(200,0,0,0.12), transform rotate(-35deg), z-index 1000, pointer-events none, font-weight bold, letter-spacing 8px

    **Page break helpers:**
    - `.signature-page`: page-break-before always
    - `.instruction-break`: page-break-before always
    - `.witness-block`: page-break-inside avoid
    - `.clause-block`: page-break-inside avoid (when possible)
  </action>
  <verify>
    Run in backend venv: `python -c "import weasyprint; print(weasyprint.__version__)"` -- should print version >=68.0.
    Verify file exists: `ls backend/app/templates/will/base.html`
  </verify>
  <done>WeasyPrint installed, base.html exists with complete CSS Paged Media styling, watermark, and include blocks.</done>
</task>

<task type="auto">
  <name>Task 2: Create cover page, will body, signature page, and instruction sheet templates</name>
  <files>
    backend/app/templates/will/cover_page.html
    backend/app/templates/will/will_body.html
    backend/app/templates/will/signature_page.html
    backend/app/templates/will/instruction_sheet.html
  </files>
  <action>
    Create 4 HTML partial templates (no `<html>`, `<head>`, `<body>` -- they are included by base.html):

    **cover_page.html:**
    Formal centered layout:
    ```
    <div class="cover-page">
      <div class="cover-brand">WillCraft SA</div>
      <h1 class="cover-title">LAST WILL AND TESTAMENT</h1>
      <p class="cover-of">OF</p>
      <h2 class="cover-name">{{ testator_name | upper }}</h2>
      <div class="cover-meta">
        <p>Date of Execution: _______________</p>
        <p>Document Reference: {{ document_reference }}</p>
      </div>
      <div class="cover-disclaimer">
        <h3>DISCLAIMER</h3>
        <p>WillCraft SA is not a law firm and does not provide legal advice. This document was generated using WillCraft SA's guided will creation service. We strongly recommend that you have this will reviewed by a qualified South African attorney before signing. This document does not constitute legal advice.</p>
        <p class="cover-attorney-rec"><strong>Attorney Review Recommended:</strong> We recommend all wills be reviewed by a qualified attorney before signing, regardless of complexity.</p>
      </div>
    </div>
    ```
    Add CSS in base.html for `.cover-page` (centered, flex column, justify-center, min-height 100vh), `.cover-title` (18pt bold uppercase, letter-spacing 2px), `.cover-name` (16pt bold uppercase), `.cover-disclaimer` (margin-top 60pt, border-top 1px solid #333, padding-top 20pt, font-size 10pt, color #333).

    **will_body.html:**
    Render the ordered clause list passed as `clauses` variable:
    ```html
    <div class="will-body">
      {% for clause in clauses %}
      <div class="clause-block">
        <p class="clause-title">{{ clause.number }}. {{ clause.name | upper }}</p>
        <div class="clause-text">{{ clause.rendered_text }}</div>
        {% if clause.sub_clauses %}
          {% for sub in clause.sub_clauses %}
          <div class="sub-clause">
            <p>{{ clause.number }}.{{ loop.index }} {{ sub.text }}</p>
          </div>
          {% endfor %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    ```
    Each clause dict has: `number` (int), `name` (str), `rendered_text` (str, already rendered from Jinja2 clause templates), optional `sub_clauses` (list of {text}).

    **signature_page.html:**
    Full dedicated signing page:
    ```html
    <div class="signature-page">
      <h2 class="sig-title">SIGNING PAGE</h2>
      <p class="sig-preamble">SIGNED at _________________________ on this _______ day of _______________ {{ signing_year }}.</p>

      <div class="sig-block testator-block">
        <div class="sig-line"></div>
        <p class="sig-label">{{ testator_name }}</p>
        <p class="sig-sublabel">TESTATOR</p>
      </div>

      <p class="sig-witness-preamble">The above signature was made by the Testator in our joint presence, and we at the request of the Testator and in the presence of the Testator and of each other have signed as witnesses:</p>

      <div class="witness-block">
        <h3>WITNESS 1</h3>
        <div class="sig-line"></div>
        <p class="sig-field">Full Name: _________________________________</p>
        <p class="sig-field">Identity Number: ____________________________</p>
        <p class="sig-field">Address: ____________________________________</p>
        <p class="sig-field">____________________________________________</p>
      </div>

      <div class="witness-block">
        <h3>WITNESS 2</h3>
        <div class="sig-line"></div>
        <p class="sig-field">Full Name: _________________________________</p>
        <p class="sig-field">Identity Number: ____________________________</p>
        <p class="sig-field">Address: ____________________________________</p>
        <p class="sig-field">____________________________________________</p>
      </div>
    </div>
    ```
    CSS: `.sig-line` = border-bottom 1px solid #000, width 250pt, margin 40pt 0 5pt 0. `.sig-label` = font-weight bold. `.sig-field` = margin 8pt 0, font-size 11pt.

    **instruction_sheet.html:**
    Separate page (after the legal document):
    ```html
    <div class="instruction-sheet">
      <h2 class="inst-title">WITNESS INSTRUCTION SHEET</h2>
      <p class="inst-subtitle">Important information for the signing of this will</p>
      <p class="inst-note"><em>This instruction sheet is not part of the will itself. It is provided for guidance only.</em></p>

      <h3>Who Can Be a Witness</h3>
      <ul>
        <li>Any person aged 14 years or older</li>
        <li>Must be competent to give evidence in court</li>
        <li>Must NOT be a beneficiary named in this will</li>
        <li>Must NOT be the spouse of a beneficiary named in this will</li>
      </ul>

      <h3>How to Sign</h3>
      <ol>
        <li>The testator (will-maker) signs first, in the presence of BOTH witnesses</li>
        <li>Both witnesses then sign, in the presence of the testator AND each other</li>
        <li>All three persons (testator + 2 witnesses) must be present simultaneously</li>
        <li>The testator and both witnesses must initial EVERY page of the will</li>
      </ol>

      <h3>Important Requirements</h3>
      <ul>
        <li><strong>Wet ink only:</strong> Electronic or digital signatures are NOT valid for South African wills (ECTA exclusion)</li>
        <li><strong>Original document:</strong> The Master of the High Court only accepts the original signed will, not copies</li>
        <li><strong>Safe storage:</strong> Store the original in a safe place and inform your executor of its location</li>
      </ul>

      <h3>Do NOT</h3>
      <ul>
        <li>Do NOT use correcting fluid (Tipp-Ex) on any page</li>
        <li>Do NOT cross out or alter any text after signing</li>
        <li>Do NOT sign pages in advance or separately -- all signing must happen at the same time</li>
        <li>Do NOT staple or bind additional pages after signing</li>
      </ul>

      <div class="inst-footer">
        <p>For questions about signing requirements, consult a qualified South African attorney.</p>
        <p class="inst-brand">Generated by WillCraft SA — www.willcraft.co.za</p>
      </div>
    </div>
    ```
    CSS: `.instruction-sheet` = font-size 11pt, `.inst-title` = 14pt bold uppercase centered, `h3` in instruction = 11pt bold margin-top 16pt, `li` = margin 4pt 0.
  </action>
  <verify>
    Verify all 4 template files exist:
    `ls backend/app/templates/will/cover_page.html backend/app/templates/will/will_body.html backend/app/templates/will/signature_page.html backend/app/templates/will/instruction_sheet.html`
    Verify base.html includes all 4 partials:
    `grep -c "include" backend/app/templates/will/base.html` -- should return 4.
  </verify>
  <done>All 5 HTML templates exist. Cover page has disclaimer + attorney recommendation. Will body loops over clauses with hierarchical numbering. Signature page has testator + 2 witness blocks. Instruction sheet covers SA signing requirements.</done>
</task>

</tasks>

<verification>
1. `pip show weasyprint` in backend venv shows version >=68.0
2. `python -c "import weasyprint"` succeeds without error
3. `ls backend/app/templates/will/` shows 5 files: base.html, cover_page.html, will_body.html, signature_page.html, instruction_sheet.html
4. base.html contains @page CSS rules with A4 size, margin boxes, and watermark
5. Templates use Jinja2 variables (testator_name, clauses, is_preview, etc.)
</verification>

<success_criteria>
WeasyPrint installed and verified. Complete set of will document templates with CSS Paged Media (A4, page numbers, initials), conditional watermark, cover page with disclaimer, clause body, signature page, and witness instruction sheet.
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-generation/06-01-SUMMARY.md`
</output>
