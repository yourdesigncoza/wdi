---
phase: 06-document-generation
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - frontend/src/services/api.ts
  - frontend/src/features/will/components/DocumentPreviewPage.tsx
  - frontend/src/features/will/components/WillWizard.tsx
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees disclaimer confirmation checkbox before generating preview"
    - "User can click 'Generate Preview' and see a PDF in a new browser tab"
    - "Preview PDF has PREVIEW watermark visible on each page"
    - "User can return to wizard, edit data, and regenerate preview"
    - "Attorney review recommendation is visible on the cover page"
  artifacts:
    - path: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      provides: "Document preview page with disclaimer checkbox, generate button, and new-tab PDF opening"
      min_lines: 60
    - path: "frontend/src/services/api.ts"
      provides: "generatePreview API method returning PDF blob"
      min_lines: 5
  key_links:
    - from: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      to: "frontend/src/services/api.ts"
      via: "generatePreview function call"
      pattern: "generatePreview"
    - from: "frontend/src/features/will/components/WillWizard.tsx"
      to: "frontend/src/features/will/components/DocumentPreviewPage.tsx"
      via: "Wizard step rendering conditional"
      pattern: "DocumentPreviewPage"
---

<objective>
Build the frontend document preview page with disclaimer confirmation and PDF preview in a new browser tab. Integrate into the will wizard as the final step after verification.

Purpose: Users can see their generated will before payment. The disclaimer confirmation (locked decision) must happen in-app before any PDF is generated.
Output: DocumentPreviewPage component, API client method, wizard integration
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-document-generation/06-RESEARCH.md
@.planning/phases/06-document-generation/06-02-SUMMARY.md
@.planning/phases/06-document-generation/06-03-SUMMARY.md
@frontend/src/services/api.ts
@frontend/src/features/will/components/WillWizard.tsx
@frontend/src/features/will/components/VerificationPage.tsx (pattern reference)
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generatePreview API method and create DocumentPreviewPage component</name>
  <files>
    frontend/src/services/api.ts
    frontend/src/features/will/components/DocumentPreviewPage.tsx
  </files>
  <action>
    **api.ts -- add generatePreview function:**
    Add at the end of the file, after the verification section:

    ```typescript
    // ── Document Generation API ─────────────────────────────────────────

    /** Generate a watermarked preview PDF and open in new tab */
    export async function generatePreview(willId: string): Promise<Blob> {
      const response = await fetch(`${BASE_URL}/wills/${willId}/preview`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ disclaimer_acknowledged: true }),
      })
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ detail: 'Preview generation failed' }))
        throw new Error(errorData.detail || `API error: ${response.status}`)
      }
      return response.blob()
    }
    ```
    Note: This returns a Blob (not JSON), so it cannot use the generic `request<T>` helper which calls `response.json()`.

    **DocumentPreviewPage.tsx:**
    Create a new component that:

    1. **State:** `disclaimerChecked` (boolean), `isGenerating` (boolean), `error` (string | null), `hasGenerated` (boolean)

    2. **Layout** (DaisyUI classes, matching VerificationPage pattern):
       ```
       <div class="space-y-6">
         <div class="text-center">
           <h2 class="text-2xl font-bold">Document Preview</h2>
           <p class="text-base-content/70">Review your will document before proceeding</p>
         </div>

         <!-- Attorney recommendation alert -->
         <div class="alert alert-info">
           <svg ...info icon.../>
           <div>
             <h3 class="font-bold">Attorney Review Recommended</h3>
             <p>We recommend all wills be reviewed by a qualified South African attorney before signing, regardless of complexity.</p>
           </div>
         </div>

         <!-- Disclaimer acknowledgment card -->
         <div class="card bg-base-100 shadow-sm">
           <div class="card-body">
             <h3 class="card-title text-lg">Legal Disclaimer</h3>
             <p class="text-base-content/70">WillCraft SA is not a law firm and does not provide legal advice. This document was generated using WillCraft SA's guided will creation service and does not constitute legal advice.</p>
             <div class="form-control">
               <label class="label cursor-pointer justify-start gap-3">
                 <input type="checkbox" class="checkbox checkbox-primary"
                   checked={disclaimerChecked}
                   onChange={(e) => setDisclaimerChecked(e.target.checked)} />
                 <span class="label-text">I acknowledge that this is not legal advice and understand that I should have this will reviewed by a qualified attorney.</span>
               </label>
             </div>
           </div>
         </div>

         <!-- Generate button -->
         <div class="flex flex-col items-center gap-4">
           <button
             class="btn btn-primary btn-lg"
             disabled={!disclaimerChecked || isGenerating}
             onClick={handleGenerate}
           >
             {isGenerating ? (
               <><span class="loading loading-spinner"></span> Generating Preview...</>
             ) : hasGenerated ? 'Regenerate Preview' : 'Generate Preview'}
           </button>

           {hasGenerated && (
             <p class="text-success text-sm">
               Preview opened in a new tab. You can close it and regenerate anytime.
             </p>
           )}

           {error && (
             <div class="alert alert-error">
               <span>{error}</span>
             </div>
           )}
         </div>

         <!-- Navigation: back to edit -->
         <div class="flex justify-between">
           <button class="btn btn-ghost" onClick={onBack}>
             ← Back to Verification
           </button>
         </div>
       </div>
       ```

    3. **handleGenerate function:**
       ```typescript
       const handleGenerate = async () => {
         setIsGenerating(true)
         setError(null)
         try {
           const blob = await generatePreview(willId)
           const url = URL.createObjectURL(blob)
           window.open(url, '_blank')
           // Clean up object URL after browser has time to load
           setTimeout(() => URL.revokeObjectURL(url), 60000)
           setHasGenerated(true)
         } catch (err) {
           setError(err instanceof Error ? err.message : 'Failed to generate preview')
         } finally {
           setIsGenerating(false)
         }
       }
       ```

    4. **Props:** `willId: string`, `onBack: () => void` (to go back to verification/wizard)

    5. Use DaisyUI classes throughout. Match the visual style of VerificationPage.tsx.
  </action>
  <verify>
    `ls frontend/src/features/will/components/DocumentPreviewPage.tsx` -- exists.
    `grep "generatePreview" frontend/src/services/api.ts` -- matches.
    `grep "disclaimer" frontend/src/features/will/components/DocumentPreviewPage.tsx` -- matches.
    `grep "window.open" frontend/src/features/will/components/DocumentPreviewPage.tsx` -- matches.
  </verify>
  <done>DocumentPreviewPage component exists with disclaimer checkbox, generate/regenerate button, new-tab PDF preview, error handling, and back navigation. API client has generatePreview method returning Blob.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate DocumentPreviewPage into WillWizard as final step</name>
  <files>
    frontend/src/features/will/components/WillWizard.tsx
  </files>
  <action>
    1. Import DocumentPreviewPage into WillWizard.tsx.
    2. Add a "document" step after the verification step in the wizard step list/logic.
    3. When the user is on the verification step and verification passes (can_proceed), show a "Generate Document" or "Next" button that advances to the document preview step.
    4. The DocumentPreviewPage receives the willId from the wizard's state and an onBack callback that returns to the verification step.
    5. The document step should appear in the StepIndicator if there is one -- add "Document" as the final step label.
    6. Do NOT add any download functionality -- that is Phase 7. Preview only.

    Follow the existing wizard pattern for step management. Look at how VerificationPage is integrated and follow the same approach for DocumentPreviewPage.
  </action>
  <verify>
    `grep "DocumentPreviewPage" frontend/src/features/will/components/WillWizard.tsx` -- matches.
    `grep -i "document" frontend/src/features/will/components/WillWizard.tsx` -- matches document step.
  </verify>
  <done>WillWizard has document preview as final step after verification. Users flow: sections -> review -> verification -> document preview.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full document generation pipeline: WeasyPrint PDF generation from Jinja2 HTML templates, clause assembly from will JSONB data, preview API endpoint with disclaimer check, and frontend preview page with disclaimer acknowledgment UI.
  </what-built>
  <how-to-verify>
    1. Start backend: `cd backend && uvicorn app.main:app --reload`
    2. Start frontend: `cd frontend && npm run dev`
    3. Navigate to the will wizard, complete sections through verification
    4. After verification passes, advance to the Document Preview step
    5. Verify the disclaimer checkbox and "Generate Preview" button appear
    6. Check the checkbox and click "Generate Preview"
    7. A new browser tab should open showing a PDF with:
       - "PREVIEW -- NOT VALID" watermark visible on each page
       - Cover page with testator name, document reference, disclaimer
       - Numbered clauses in the will body
       - Signature page with testator and 2 witness blocks
       - Witness instruction sheet at the end
       - "Page X of Y" in footer, initials line on each page (except cover)
    8. Close the PDF tab, return to the app
    9. Click "Regenerate Preview" -- a new PDF should open
    10. Click "Back to Verification" -- should return to verification step

    If backend is not running or will data is incomplete, test the API directly:
    ```bash
    curl -X POST http://localhost:8000/api/wills/{will_id}/preview \
      -H "Content-Type: application/json" \
      -d '{"disclaimer_acknowledged": true}' \
      --output preview.pdf
    # Open preview.pdf to verify formatting
    ```
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Frontend: Disclaimer checkbox prevents generation until checked
2. Frontend: PDF opens in new browser tab (not download dialog)
3. Frontend: User can regenerate preview after going back and editing
4. Backend: POST /api/wills/{will_id}/preview returns PDF with watermark
5. Backend: Returns 422 if disclaimer not acknowledged
6. Backend: Returns 400 if will not verified
7. PDF: Has cover page, numbered clauses, signature page, instruction sheet
8. PDF: Has watermark on every page, page numbers, initials lines
</verification>

<success_criteria>
User can generate and view a watermarked PDF preview of their will in a new browser tab. Disclaimer confirmation required before generation. Attorney review recommended. Full document includes cover, clauses, signature page, and witness instructions.
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-generation/06-04-SUMMARY.md`
</output>
