---
phase: 06-document-generation
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/api/document.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/wills/{will_id}/preview returns PDF bytes with Content-Disposition: inline"
    - "Preview endpoint requires disclaimer_acknowledged=true or returns 422"
    - "Preview endpoint requires will status verified or generated"
    - "Document router is registered in main.py"
  artifacts:
    - path: "backend/app/api/document.py"
      provides: "Preview API endpoint with disclaimer check and status gating"
      min_lines: 40
  key_links:
    - from: "backend/app/api/document.py"
      to: "backend/app/services/document_service.py"
      via: "FastAPI Depends injection"
      pattern: "get_document_service"
    - from: "backend/app/main.py"
      to: "backend/app/api/document.py"
      via: "include_router"
      pattern: "document\\.router"
---

<objective>
Create the document preview API endpoint and register it in the FastAPI app.

Purpose: Exposes the PDF generation capability to the frontend. Enforces disclaimer acknowledgment and verification status checks before generating.
Output: document.py (API) + updated main.py
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-document-generation/06-RESEARCH.md
@.planning/phases/06-document-generation/06-02-SUMMARY.md
@backend/app/api/verification.py (pattern reference for _extract_user_id, router structure)
@backend/app/main.py (router registration pattern)
@backend/app/services/document_service.py
@backend/app/schemas/document.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document API endpoint with disclaimer and status gating</name>
  <files>
    backend/app/api/document.py
  </files>
  <action>
    Create `backend/app/api/document.py` following the verification.py pattern:

    ```python
    """Document generation endpoints for will PDF preview and download.

    POST /api/wills/{will_id}/preview -- Generate watermarked preview PDF
    """
    ```

    1. Router: `APIRouter(prefix="/api/wills", tags=["document"])`

    2. `_extract_user_id(request)` -- copy from verification.py (same dev-mode fallback pattern). Or better: import from a shared utility if one exists. If not, duplicate it (DRY is preferred but don't refactor across files in this plan).

    3. **POST `/{will_id}/preview` endpoint:**
       ```python
       @router.post("/{will_id}/preview")
       async def preview_will(
           will_id: uuid.UUID,
           body: GeneratePreviewRequest,
           request: Request,
           service: DocumentGenerationService = Depends(get_document_service),
       ):
       ```
       Logic:
       - Extract user_id from request
       - Validate `body.disclaimer_acknowledged is True`, else raise HTTPException(422, "You must acknowledge the legal disclaimer before generating a preview.")
       - Fetch the will via service (which internally uses WillService with ownership check)
       - Check will status: must be "verified" or "generated". If not, raise HTTPException(400, "Will must be verified before generating a document. Current status: {status}")
       - Call `service.generate_preview(will_id, user_id)`
       - Return `Response(content=pdf_bytes, media_type="application/pdf", headers={"Content-Disposition": "inline; filename=will-preview.pdf", "Cache-Control": "no-store"})`

    4. Import FastAPI Response (not StreamingResponse -- we return the full bytes at once since PDF is typically <1MB).

    Note: A download endpoint (for paid final PDFs) will be added in Phase 7. Only preview endpoint exists now.
  </action>
  <verify>
    `python -c "from app.api.document import router; print(len(router.routes), 'routes')"` from backend/ dir.
    `grep "disclaimer_acknowledged" backend/app/api/document.py` -- should match.
    `grep "Content-Disposition.*inline" backend/app/api/document.py` -- should match.
  </verify>
  <done>Document preview endpoint exists with disclaimer validation, status gating (verified/generated), user ownership check, and inline PDF response headers.</done>
</task>

<task type="auto">
  <name>Task 2: Register document router in main.py</name>
  <files>
    backend/app/main.py
  </files>
  <action>
    1. Add import: `from app.api import ai, consent, conversation, privacy, health, clauses, verification, will, document` (add `document` to existing import line).
    2. Add router registration: `app.include_router(document.router)` after the verification router line.
  </action>
  <verify>
    `grep "document.router" backend/app/main.py` -- should match.
    `grep "from app.api import.*document" backend/app/main.py` -- should match.
  </verify>
  <done>Document router registered in FastAPI app. POST /api/wills/{will_id}/preview is accessible.</done>
</task>

</tasks>

<verification>
1. `from app.api.document import router` imports cleanly
2. main.py includes document router
3. Preview endpoint returns 422 if disclaimer not acknowledged
4. Preview endpoint returns 400 if will status is not verified/generated
5. Endpoint returns PDF bytes with Content-Disposition: inline
</verification>

<success_criteria>
Preview API endpoint accessible at POST /api/wills/{will_id}/preview. Returns watermarked PDF inline. Enforces disclaimer acknowledgment and verification status.
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-generation/06-03-SUMMARY.md`
</output>
