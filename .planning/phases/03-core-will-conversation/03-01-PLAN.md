---
phase: 03-core-will-conversation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/will.py
  - backend/app/models/conversation.py
  - backend/app/models/__init__.py
  - backend/app/schemas/will.py
  - backend/app/schemas/conversation.py
  - backend/app/schemas/__init__.py
  - backend/alembic/versions/003_add_will_and_conversation_tables.py
autonomous: true

must_haves:
  truths:
    - "Will model stores section data as separate JSONB columns (testator, marital, beneficiaries, assets, guardians, executor, bequests, residue)"
    - "Conversation model stores per-section message history linked to a will"
    - "Database migration creates wills and conversations tables with proper indexes"
  artifacts:
    - path: "backend/app/models/will.py"
      provides: "Will SQLModel with JSONB section columns"
      contains: "class Will"
    - path: "backend/app/models/conversation.py"
      provides: "Conversation history model"
      contains: "class Conversation"
    - path: "backend/app/schemas/will.py"
      provides: "Pydantic schemas for testator, beneficiary, asset, guardian, executor, bequest, residue, marital"
    - path: "backend/app/schemas/conversation.py"
      provides: "Message and conversation request/response schemas"
    - path: "backend/alembic/versions/003_add_will_and_conversation_tables.py"
      provides: "Alembic migration for wills + conversations"
  key_links:
    - from: "backend/app/models/will.py"
      to: "backend/app/models/user.py"
      via: "ForeignKey user_id -> users.id"
    - from: "backend/app/models/conversation.py"
      to: "backend/app/models/will.py"
      via: "ForeignKey will_id -> wills.id"
---

<objective>
Create the Will and Conversation data models, Pydantic validation schemas, and database migration for the core will conversation feature.

Purpose: Establishes the data layer that all subsequent plans depend on -- will storage with JSONB flexibility per section, and conversation history for context continuity across section switches.
Output: Will model, Conversation model, section-specific Pydantic schemas, Alembic migration 003.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-will-conversation/03-RESEARCH.md
@backend/app/models/user.py
@backend/app/models/consent.py
@backend/app/database.py
@backend/app/config.py
@backend/alembic/versions/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Will and Conversation SQLModels</name>
  <files>
    backend/app/models/will.py
    backend/app/models/conversation.py
    backend/app/models/__init__.py
  </files>
  <action>
    Create Will model in backend/app/models/will.py following the Pattern 2 from RESEARCH.md:
    - UUID primary key, user_id FK to users.id (not nullable)
    - will_type (str, default "basic"), status (str, default "draft" -- values: draft/review/verified/generated)
    - JSONB columns for each section: testator (dict), marital (dict), beneficiaries (list), assets (list), guardians (list), executor (dict), bequests (list), residue (dict)
    - sections_complete (JSONB dict tracking completion: personal, beneficiaries, assets, guardians, executor, bequests, residue -- all default false)
    - created_at, updated_at timestamps with timezone
    - Index on user_id

    Create Conversation model in backend/app/models/conversation.py:
    - UUID primary key
    - will_id FK to wills.id (not nullable)
    - section (str -- which will section this conversation belongs to)
    - messages (JSONB list -- array of {role, content, timestamp} dicts)
    - created_at, updated_at timestamps
    - Composite index on (will_id, section) for fast lookup

    Follow existing model patterns from consent.py and user.py. Use SQLModel with sa_column for JSONB columns.

    Update backend/app/models/__init__.py to export Will and Conversation.
  </action>
  <verify>
    python -c "from app.models.will import Will; from app.models.conversation import Conversation; print('Models imported OK')"
  </verify>
  <done>Will and Conversation models importable with all JSONB fields, FKs, indexes defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Pydantic schemas for will sections and conversation</name>
  <files>
    backend/app/schemas/will.py
    backend/app/schemas/conversation.py
    backend/app/schemas/__init__.py
  </files>
  <action>
    Create backend/app/schemas/will.py with these Pydantic models (from RESEARCH.md Pattern - Will Data Section Schemas):

    Enums: MaritalStatus (single, married_in_community, married_anc, married_cop, divorced, widowed), Province (EC, FS, GP, KZN, LP, MP, NC, NW, WC), AssetType (property, vehicle, bank_account, investment, insurance, business, other)

    Schemas:
    - TestatorSchema: first_name, last_name, id_number (regex 13 digits), date_of_birth, address, city, province (Province enum), postal_code (regex 4 digits), phone (optional), email (optional)
    - MaritalSchema: status (MaritalStatus), spouse_first_name/last_name/id_number (all optional), married_outside_sa (bool), marriage_country (optional)
    - BeneficiarySchema: full_name, relationship, id_number (optional), share_percent (optional, 0-100), alternate_beneficiary (optional), is_charity (bool default false)
    - AssetSchema: asset_type (AssetType), description, details (optional dict)
    - GuardianSchema: full_name, relationship, id_number (optional), is_primary (bool default true)
    - ExecutorSchema: name, relationship (optional), is_professional (bool default false), backup_name (optional), backup_relationship (optional)
    - BequestSchema: item_description, recipient_name, recipient_relationship (optional)
    - ResidueSchema: beneficiaries (list of dicts with name + share_percent), simultaneous_death_clause (optional str)
    - WillSectionUpdate: section (str), data (Any) -- generic section update payload
    - WillResponse: id, user_id, will_type, status, testator, marital, beneficiaries, assets, guardians, executor, bequests, residue, sections_complete, created_at, updated_at
    - WillCreateRequest: will_type (default "basic")

    Create backend/app/schemas/conversation.py:
    - MessageSchema: role (Literal["user", "assistant", "system"]), content (str), timestamp (optional datetime)
    - ConversationRequest: messages (list[MessageSchema]), current_section (str), will_context (dict)
    - ConversationResponse: section, messages
    - SSEEvent: event (str), data (dict)

    Update backend/app/schemas/__init__.py to export new schemas.
  </action>
  <verify>
    python -c "from app.schemas.will import TestatorSchema, BeneficiarySchema, WillResponse; from app.schemas.conversation import ConversationRequest; print('Schemas imported OK')"
  </verify>
  <done>All will section schemas and conversation schemas validate correctly with proper constraints</done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration 003 for wills and conversations tables</name>
  <files>
    backend/alembic/versions/003_add_will_and_conversation_tables.py
  </files>
  <action>
    Create migration 003_add_will_and_conversation_tables.py following existing migration patterns (see 001 and 002 in alembic/versions/).

    upgrade():
    - Create "wills" table with columns matching Will model (UUID PK, user_id FK to users.id, will_type, status, all JSONB section columns with server_defaults, sections_complete, timestamps)
    - Create index ix_wills_user_id on wills(user_id)
    - Create "conversations" table with columns matching Conversation model (UUID PK, will_id FK to wills.id with CASCADE delete, section varchar, messages JSONB, timestamps)
    - Create index ix_conversations_will_section on conversations(will_id, section) as unique constraint (one conversation per will+section)

    downgrade():
    - Drop conversations table
    - Drop wills table

    Set revision ID to a short hex string, down_revision to the 002 migration revision ID. Check existing migrations for the exact revision chain.
  </action>
  <verify>
    cd backend && alembic check 2>&1 | head -5 (should detect new migration); python -c "import alembic.versions" (import check)
  </verify>
  <done>Migration 003 creates wills and conversations tables with proper FKs, indexes, JSONB defaults</done>
</task>

</tasks>

<verification>
1. All models import: `python -c "from app.models import Will, Conversation"`
2. All schemas import: `python -c "from app.schemas.will import TestatorSchema; from app.schemas.conversation import ConversationRequest"`
3. Schema validation works: `python -c "from app.schemas.will import TestatorSchema; t = TestatorSchema(first_name='John', last_name='Doe', id_number='9001015009088', date_of_birth='1990-01-01', address='123 Main', city='Cape Town', province='WC', postal_code='8001'); print(t)"`
4. Migration file exists and has correct revision chain
</verification>

<success_criteria>
- Will model with 8 JSONB section columns + sections_complete tracker
- Conversation model with per-section message history
- Full set of Pydantic schemas covering all SA will data fields
- Alembic migration 003 ready to apply
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-will-conversation/03-01-SUMMARY.md`
</output>
