---
phase: 03-core-will-conversation
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/app/services/will_service.py
  - backend/app/api/will.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "User can create a new will draft via POST /api/wills"
    - "User can retrieve their will via GET /api/wills/{will_id}"
    - "User can update individual will sections via PATCH /api/wills/{will_id}/sections/{section}"
    - "Section updates validate data against Pydantic schemas before saving"
  artifacts:
    - path: "backend/app/services/will_service.py"
      provides: "WillService with create, get, update_section, list_user_wills methods"
      contains: "class WillService"
    - path: "backend/app/api/will.py"
      provides: "Will CRUD API endpoints"
      contains: "router"
  key_links:
    - from: "backend/app/api/will.py"
      to: "backend/app/services/will_service.py"
      via: "Depends() injection"
    - from: "backend/app/services/will_service.py"
      to: "backend/app/models/will.py"
      via: "SQLModel session queries"
    - from: "backend/app/main.py"
      to: "backend/app/api/will.py"
      via: "app.include_router(will.router)"
---

<objective>
Create the Will CRUD service and API endpoints for creating, reading, and updating will data by section.

Purpose: Provides the persistence layer that both the structured forms (personal/marital) and the AI conversation use to save will data. Section-level updates allow independent saving without overwriting other sections.
Output: WillService class, will API router with CRUD endpoints, registered in main.py.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-core-will-conversation/03-RESEARCH.md
@.planning/phases/03-core-will-conversation/03-01-SUMMARY.md
@backend/app/database.py
@backend/app/services/audit_service.py
@backend/app/api/consent.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WillService with CRUD operations</name>
  <files>backend/app/services/will_service.py</files>
  <action>
    Create backend/app/services/will_service.py following existing service patterns (see audit_service.py, clause_library.py):

    class WillService:
      - __init__(self, session: AsyncSession)
      - async create_will(self, user_id: UUID, will_type: str = "basic") -> Will
        * Creates new Will with all default empty sections, returns it
      - async get_will(self, will_id: UUID, user_id: UUID) -> Will | None
        * Fetch will by ID, verify it belongs to user_id (security check)
      - async list_user_wills(self, user_id: UUID) -> list[Will]
        * Return all wills for a user, ordered by updated_at desc
      - async update_section(self, will_id: UUID, user_id: UUID, section: str, data: Any) -> Will
        * Validate section name is one of: testator, marital, beneficiaries, assets, guardians, executor, bequests, residue
        * Update the specific JSONB column with provided data
        * Update updated_at timestamp
        * Return updated Will
      - async mark_section_complete(self, will_id: UUID, user_id: UUID, section: str) -> Will
        * Set sections_complete[section] = true
        * Return updated Will
      - async update_will_status(self, will_id: UUID, user_id: UUID, status: str) -> Will
        * Validate status is one of: draft, review, verified, generated
        * Update status field

    Use DI pattern: create a get_will_service dependency function that gets AsyncSession from get_session and returns WillService(session).

    IMPORTANT: Every method that accesses a will must verify user_id ownership. Raise HTTPException(403) if will doesn't belong to user.
  </action>
  <verify>python -c "from app.services.will_service import WillService; print('OK')"</verify>
  <done>WillService with all CRUD methods, user ownership verification, section-level updates</done>
</task>

<task type="auto">
  <name>Task 2: Create Will API endpoints and register router</name>
  <files>
    backend/app/api/will.py
    backend/app/main.py
  </files>
  <action>
    Create backend/app/api/will.py:

    router = APIRouter(prefix="/wills", tags=["wills"])

    Endpoints:
    - POST /api/wills -- Create new will draft
      * Request body: WillCreateRequest (will_type, default "basic")
      * Extract user_id from request.state.user (set by ClerkAuth middleware)
      * Returns WillResponse (201)
    - GET /api/wills -- List user's wills
      * Returns list[WillResponse]
    - GET /api/wills/{will_id} -- Get specific will
      * Returns WillResponse
    - PATCH /api/wills/{will_id}/sections/{section} -- Update a section
      * Request body: the section data (validated against appropriate schema based on section name)
      * Use a section-to-schema mapping: testator->TestatorSchema, marital->MaritalSchema, beneficiaries->list[BeneficiarySchema], etc.
      * Returns WillResponse
    - POST /api/wills/{will_id}/sections/{section}/complete -- Mark section complete
      * Returns WillResponse

    For user_id extraction: check request.state for "user" attribute (set by ClerkAuth middleware). If auth is disabled (dev mode), use a fallback UUID or raise 401.

    Register in backend/app/main.py: import will router and add app.include_router(will.router)
  </action>
  <verify>cd backend && python -c "from app.api.will import router; print(f'Routes: {len(router.routes)}')"</verify>
  <done>Will API with 5 endpoints registered, section updates validate against proper schemas</done>
</task>

</tasks>

<verification>
1. Service imports: python -c "from app.services.will_service import WillService, get_will_service"
2. Router has routes: python -c "from app.api.will import router; print(len(router.routes))"
3. Main includes will router: grep "will.router" backend/app/main.py
4. Section validation mapping exists: grep "TestatorSchema\|BeneficiarySchema" backend/app/api/will.py
</verification>

<success_criteria>
- WillService with create, get, list, update_section, mark_complete, update_status methods
- All methods verify user ownership
- 5 API endpoints covering full will CRUD
- Section updates validated against appropriate Pydantic schema
- Router registered in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-will-conversation/03-04-SUMMARY.md`
</output>
