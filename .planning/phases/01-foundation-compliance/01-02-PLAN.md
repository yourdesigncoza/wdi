---
phase: 01-foundation-compliance
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/app/main.py
  - backend/app/middleware/__init__.py
  - backend/app/middleware/popia_consent.py
  - backend/app/middleware/audit.py
  - backend/app/api/__init__.py
  - backend/app/api/consent.py
  - backend/app/api/privacy.py
  - backend/app/api/health.py
  - backend/app/schemas/__init__.py
  - backend/app/schemas/consent.py
  - backend/app/services/__init__.py
  - backend/app/services/audit_service.py
autonomous: true

must_haves:
  truths:
    - "API blocks access to protected endpoints without consent token"
    - "User can POST consent and receive signed token in cookie"
    - "User can GET privacy policy and info officer details"
    - "All consent events are logged to audit trail"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI app with middleware"
      contains: "app.add_middleware"
    - path: "backend/app/middleware/popia_consent.py"
      provides: "Consent verification middleware"
      contains: "class POPIAConsentMiddleware"
    - path: "backend/app/api/consent.py"
      provides: "Consent endpoints"
      exports: ["router"]
    - path: "backend/app/api/privacy.py"
      provides: "Privacy policy and info officer endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/api/consent.py"
      via: "router include"
      pattern: "app\\.include_router.*consent"
    - from: "backend/app/api/consent.py"
      to: "backend/app/services/audit_service.py"
      via: "audit logging"
      pattern: "audit_service\\.log"
---

<objective>
Create FastAPI application with POPIA consent middleware, consent/privacy endpoints, and audit logging service.

Purpose: API layer that enforces consent-before-data-collection and provides POPIA-required endpoints
Output: Running FastAPI server with consent flow, privacy policy access, and audit trail
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-compliance/01-RESEARCH.md
@.planning/phases/01-foundation-compliance/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: FastAPI app with POPIA middleware</name>
  <files>
    backend/app/main.py
    backend/app/middleware/__init__.py
    backend/app/middleware/popia_consent.py
    backend/app/middleware/audit.py
  </files>
  <action>
    Create FastAPI application with middleware:

    **main.py:**
    - FastAPI app with title "WillCraft SA API", CORS middleware for React frontend (localhost:3000, localhost:5173)
    - Add POPIAConsentMiddleware
    - Include routers: consent, privacy, health
    - Lifespan context manager for startup/shutdown (database connection test)

    **middleware/popia_consent.py:**
    - POPIAConsentMiddleware (BaseHTTPMiddleware)
    - EXEMPT_PATHS: /api/health, /api/consent, /api/consent/status, /api/privacy-policy, /api/info-officer, /docs, /openapi.json, /redoc
    - Check for popia_consent cookie
    - Validate JWT token using python-jose (verify signature, check expiry)
    - Return 403 with {error: "consent_required", consent_url: "/api/consent"} if missing/invalid
    - Use settings.SECRET_KEY for JWT validation

    **middleware/audit.py:**
    - AuditMiddleware that logs request method, path, status code, duration to audit service
    - Skip logging for health checks and static files
    - Non-blocking (fire and forget to avoid request latency)

    Use patterns from RESEARCH.md middleware section.
  </action>
  <verify>
    cd backend && python -c "from app.main import app; print(app.title)"
  </verify>
  <done>FastAPI app loads with middleware, CORS configured for local dev</done>
</task>

<task type="auto">
  <name>Task 2: Consent and privacy API endpoints</name>
  <files>
    backend/app/api/__init__.py
    backend/app/api/consent.py
    backend/app/api/privacy.py
    backend/app/api/health.py
    backend/app/schemas/__init__.py
    backend/app/schemas/consent.py
  </files>
  <action>
    Create API endpoints:

    **schemas/consent.py:**
    - ConsentRequest: categories (list[str])
    - ConsentResponse: consent_id (UUID), accepted_at (datetime), consent_version (str)
    - ConsentStatusResponse: has_valid_consent (bool), consent_version (str | None)

    **api/consent.py:**
    - POST /api/consent - Record consent, create ConsentRecord, log to audit, return signed JWT in httpOnly cookie
    - GET /api/consent/status - Check if valid consent cookie exists
    - POST /api/consent/withdraw - Mark consent as withdrawn (set withdrawn_at), clear cookie, log to audit

    **api/privacy.py:**
    - GET /api/privacy-policy - Return privacy policy text (hardcoded for now, version from settings)
    - GET /api/info-officer - Return Information Officer contact details (from settings or hardcoded placeholder)
    - POST /api/data-request - Record data subject request (access/correction/deletion), log to audit, return confirmation

    **api/health.py:**
    - GET /api/health - Return {status: "healthy", version: "0.1.0"}

    All consent/privacy endpoints must log events via audit_service.
  </action>
  <verify>
    cd backend && uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    sleep 2
    curl http://localhost:8000/api/health
    curl http://localhost:8000/api/privacy-policy
    curl http://localhost:8000/api/info-officer
    pkill -f "uvicorn app.main"
  </verify>
  <done>Health, privacy-policy, and info-officer endpoints return 200 without consent</done>
</task>

<task type="auto">
  <name>Task 3: Audit logging service</name>
  <files>
    backend/app/services/__init__.py
    backend/app/services/audit_service.py
  </files>
  <action>
    Create audit logging service:

    **services/audit_service.py:**
    - AuditService class with async methods
    - log_event(event_type, event_category, user_id=None, session_id=None, ip_address=None, user_agent=None, resource_type=None, resource_id=None, details=None)
    - Creates AuditLog record and commits
    - Event types: consent_granted, consent_withdrawn, consent_checked, data_request_submitted, api_request
    - Event categories: popia, upl_filter, data_request, system

    - get_audit_service dependency for injection into endpoints

    Service should handle database errors gracefully (log error, don't crash request).
  </action>
  <verify>
    python -c "from app.services.audit_service import AuditService; print('AuditService OK')"
  </verify>
  <done>AuditService importable with log_event method for all POPIA event types</done>
</task>

</tasks>

<verification>
1. `uvicorn app.main:app` starts without errors
2. `curl http://localhost:8000/api/health` returns 200
3. `curl http://localhost:8000/api/privacy-policy` returns privacy policy text
4. `curl http://localhost:8000/api/info-officer` returns contact details
5. `curl -X POST http://localhost:8000/api/consent -H "Content-Type: application/json" -d '{"categories":["essential"]}' -c cookies.txt` returns consent response and sets cookie
6. `curl http://localhost:8000/api/consent/status -b cookies.txt` returns has_valid_consent: true
7. Protected endpoint without cookie returns 403 consent_required (test once protected endpoints exist)
</verification>

<success_criteria>
- FastAPI app runs with CORS and POPIA middleware
- Consent endpoints record consent and set signed cookie
- Privacy policy and info officer endpoints accessible without consent
- Audit service logs all consent events to database
- Middleware blocks protected routes without valid consent
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-02-SUMMARY.md`
</output>
