---
phase: 01-foundation-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/__init__.py
  - backend/app/config.py
  - backend/app/database.py
  - backend/app/models/__init__.py
  - backend/app/models/consent.py
  - backend/app/models/clause.py
  - backend/app/models/audit.py
  - backend/alembic.ini
  - backend/alembic/env.py
  - backend/alembic/versions/001_initial_schema.py
  - backend/requirements.txt
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "Database schema exists for consent records, clauses, and audit logs"
    - "Migrations run successfully against PostgreSQL"
    - "Audit log table is append-only (no UPDATE/DELETE)"
  artifacts:
    - path: "backend/app/models/consent.py"
      provides: "ConsentRecord model"
      contains: "class ConsentRecord"
    - path: "backend/app/models/clause.py"
      provides: "Clause model with versioning"
      contains: "class Clause"
    - path: "backend/app/models/audit.py"
      provides: "Immutable AuditLog model"
      contains: "class AuditLog"
    - path: "backend/alembic/versions/001_initial_schema.py"
      provides: "Initial migration"
      contains: "def upgrade"
  key_links:
    - from: "backend/app/database.py"
      to: "backend/app/config.py"
      via: "settings.DATABASE_URL"
      pattern: "settings\\.DATABASE_URL"
    - from: "backend/alembic/env.py"
      to: "backend/app/models"
      via: "model imports for autogenerate"
      pattern: "from app\\.models"
---

<objective>
Create PostgreSQL database schema with SQLModel for POPIA consent records, versioned clause library, and immutable audit logs.

Purpose: Foundation for all compliance features - consent tracking, clause management, and audit trail
Output: Database models, Alembic migrations, async session factory
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-compliance/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend project scaffold with config and database</name>
  <files>
    backend/app/__init__.py
    backend/app/config.py
    backend/app/database.py
    backend/requirements.txt
    backend/.env.example
  </files>
  <action>
    Create backend directory structure:
    - `backend/app/__init__.py` - Empty init
    - `backend/app/config.py` - pydantic-settings for DATABASE_URL, SECRET_KEY, DEBUG, CONSENT_VERSION, PRIVACY_POLICY_VERSION
    - `backend/app/database.py` - Async engine with asyncpg, async_sessionmaker, get_session dependency
    - `backend/requirements.txt` - fastapi[standard], sqlmodel, alembic, asyncpg, pydantic-settings, python-jose, httpx
    - `backend/.env.example` - Template with DATABASE_URL=postgresql+asyncpg://user:pass@localhost/willcraft

    Use patterns from RESEARCH.md Code Examples section. Engine should use pool_pre_ping=True.
  </action>
  <verify>
    cd backend && pip install -r requirements.txt
    python -c "from app.config import settings; print(settings)"
  </verify>
  <done>Config loads from environment, database module importable without errors</done>
</task>

<task type="auto">
  <name>Task 2: SQLModel models for consent, clauses, and audit</name>
  <files>
    backend/app/models/__init__.py
    backend/app/models/consent.py
    backend/app/models/clause.py
    backend/app/models/audit.py
  </files>
  <action>
    Create models following RESEARCH.md patterns:

    **consent.py:**
    - ConsentRecord: id (UUID), consent_version, privacy_policy_version, accepted_at, withdrawn_at (nullable), ip_address, user_agent, consent_categories (JSONB list), created_at
    - Index on accepted_at

    **clause.py:**
    - ClauseCategory enum: REVOCATION, EXECUTOR, BENEFICIARY, GUARDIAN, TRUST, USUFRUCT, RESIDUE, WITNESS, SIGNATURE
    - WillType enum: BASIC, TRUST, USUFRUCT, JOINT
    - Clause model: id (UUID), code (unique indexed), name, category, version, is_current (indexed), previous_version_id, template_text, variables_schema (JSONB), will_types (JSONB list), is_required, display_order, approved_by, approved_at, approval_notes, created_at, updated_at
    - Composite index on (category, is_current)

    **audit.py:**
    - AuditLog: id (UUID), event_type (indexed), event_category (indexed), user_id (nullable, indexed), session_id, ip_address, user_agent, resource_type, resource_id, details (JSONB), created_at (indexed)
    - Table will be partitioned in migration

    **__init__.py:** Export all models for Alembic autogenerate
  </action>
  <verify>
    python -c "from app.models import ConsentRecord, Clause, AuditLog; print('Models OK')"
  </verify>
  <done>All three models importable, enums defined, JSONB fields configured</done>
</task>

<task type="auto">
  <name>Task 3: Alembic setup and initial migration</name>
  <files>
    backend/alembic.ini
    backend/alembic/env.py
    backend/alembic/script.py.mako
    backend/alembic/versions/001_initial_schema.py
  </files>
  <action>
    Initialize Alembic and create migration:

    1. Run `alembic init alembic` in backend/
    2. Configure alembic.ini: sqlalchemy.url from env var
    3. Configure env.py:
       - Import models for autogenerate: `from app.models import *`
       - Set target_metadata from SQLModel.metadata
       - Async migration support with asyncpg

    4. Create manual migration 001_initial_schema.py:
       - consent_records table with all columns and indexes
       - clauses table with all columns, unique constraint on code, indexes
       - audit_logs as PARTITIONED TABLE by RANGE (created_at)
       - Initial partition for current month (audit_logs_2026_02)
       - Indexes on audit_logs (event_type, created_at) and (user_id, created_at)
       - REVOKE UPDATE, DELETE on audit_logs for app user (comment noting this should be applied after table creation)

    Use exact migration SQL from RESEARCH.md Code Examples.
  </action>
  <verify>
    cd backend && alembic check
    alembic upgrade head --sql | head -50
  </verify>
  <done>Migration generates valid SQL, creates all tables with partitioning, includes audit immutability comment</done>
</task>

</tasks>

<verification>
1. `cd backend && pip install -r requirements.txt` completes without errors
2. `python -c "from app.models import ConsentRecord, Clause, AuditLog"` works
3. `alembic upgrade head --sql` shows CREATE TABLE for all three tables
4. Migration includes PARTITION BY RANGE for audit_logs
5. .env.example documents all required environment variables
</verification>

<success_criteria>
- Backend Python project structure exists with config, database, and models
- ConsentRecord, Clause, AuditLog models defined with correct fields and indexes
- Alembic configured for async PostgreSQL with initial migration ready
- Migration creates partitioned audit_logs table
- All dependencies in requirements.txt installable
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-01-SUMMARY.md`
</output>
