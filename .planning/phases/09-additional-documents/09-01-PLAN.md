---
phase: 09-additional-documents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/additional_document.py
  - backend/alembic/versions/008_add_additional_documents.py
  - backend/app/schemas/additional_document.py
  - backend/app/services/additional_document_service.py
  - backend/app/api/additional_documents.py
  - backend/app/main.py
  - backend/app/templates/living_will/base.html
  - backend/app/templates/living_will/body.html
  - backend/app/templates/living_will/signature_page.html
  - backend/app/templates/funeral_wishes/base.html
  - backend/app/templates/funeral_wishes/body.html
  - backend/app/templates/funeral_wishes/signature_page.html
autonomous: true

must_haves:
  truths:
    - "AdditionalDocument model persists living will and funeral wishes data as JSONB"
    - "API endpoints support CRUD for additional documents"
    - "Service generates PDF from JSONB content via Jinja2+WeasyPrint pipeline"
    - "Living will and funeral wishes have separate PDF templates with professional formatting"
  artifacts:
    - path: "backend/app/models/additional_document.py"
      provides: "AdditionalDocument SQLModel with JSONB content column"
      contains: "class AdditionalDocument"
    - path: "backend/alembic/versions/008_add_additional_documents.py"
      provides: "Migration creating additional_documents table"
      contains: "additional_documents"
    - path: "backend/app/schemas/additional_document.py"
      provides: "LivingWillContent, FuneralWishesContent, and API request/response schemas"
      contains: "class LivingWillContent"
    - path: "backend/app/services/additional_document_service.py"
      provides: "AdditionalDocumentService with CRUD and PDF generation"
      contains: "class AdditionalDocumentService"
    - path: "backend/app/api/additional_documents.py"
      provides: "FastAPI router with CRUD and PDF endpoints"
      contains: "router"
    - path: "backend/app/templates/living_will/base.html"
      provides: "Living will PDF template"
      contains: "Advance Healthcare Directive"
    - path: "backend/app/templates/funeral_wishes/base.html"
      provides: "Funeral wishes PDF template"
      contains: "Funeral Wishes"
  key_links:
    - from: "backend/app/api/additional_documents.py"
      to: "backend/app/services/additional_document_service.py"
      via: "FastAPI Depends injection"
      pattern: "get_additional_document_service"
    - from: "backend/app/services/additional_document_service.py"
      to: "backend/app/templates/"
      via: "Jinja2 FileSystemLoader"
      pattern: "get_template.*living_will|funeral_wishes"
    - from: "backend/app/main.py"
      to: "backend/app/api/additional_documents.py"
      via: "include_router"
      pattern: "additional_documents\\.router"
---

<objective>
Build the complete backend for additional documents (living will + funeral wishes): data model, migration, schemas, service with PDF generation, API endpoints, and Jinja2 PDF templates.

Purpose: Establish the entire backend pipeline so the frontend can create, update, and download additional documents.
Output: Working API for CRUD operations on additional documents with PDF generation via Jinja2+WeasyPrint.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-additional-documents/09-RESEARCH.md
@backend/app/models/will.py
@backend/app/services/document_service.py
@backend/app/templates/will/base.html
@backend/app/api/document.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdditionalDocument model, migration 008, and Pydantic schemas</name>
  <files>
    backend/app/models/additional_document.py
    backend/alembic/versions/008_add_additional_documents.py
    backend/app/schemas/additional_document.py
  </files>
  <action>
    **Model (additional_document.py):**
    Create AdditionalDocument SQLModel following the Will model pattern:
    - `id`: UUID PK (uuid4 default)
    - `user_id`: UUID FK to users.id, NOT NULL
    - `will_id`: UUID FK to wills.id, nullable, ondelete="SET NULL" (optional link to main will)
    - `document_type`: String(50), NOT NULL -- "living_will" or "funeral_wishes"
    - `status`: String(50), NOT NULL, server_default="draft" -- draft | completed | generated
    - `content`: JSONB, NOT NULL, server_default="{}" (GOTCHA: use `server_default="{}"` not `server_default="'{}'"`)
    - `created_at`: DateTime(timezone=True), NOT NULL, server_default="now()"
    - `updated_at`: DateTime(timezone=True), NOT NULL, server_default="now()"
    - Index on user_id: `Index("ix_additional_documents_user_id", "user_id")`

    **Migration 008:**
    Create Alembic migration `008_add_additional_documents.py`. Use the pattern from existing migrations (e.g., 006). Creates the `additional_documents` table with all columns and the user_id index.

    **Schemas (additional_document.py):**
    Create Pydantic schemas:

    1. `LivingWillContent(BaseModel)` -- JSONB shape for living will:
       - `full_name: str = ""`
       - `id_number: str = ""`
       - `date_of_birth: str = ""`
       - `address: str = ""`
       - Treatment prefs (all `bool`): `life_support`, `artificial_ventilation`, `artificial_nutrition`, `resuscitation_cpr`, `antibiotics_terminal` (default False), `pain_management` (default True)
       - Trigger conditions (all `bool`, default True): `terminal_illness`, `permanent_vegetative_state`, `permanent_unconsciousness`
       - Healthcare proxy: `proxy_name`, `proxy_id_number`, `proxy_phone`, `proxy_relationship`, `alternate_proxy_name` (all `str | None = None`)
       - Values: `personal_values`, `religious_considerations` (str | None), `organ_donation` (bool | None), `organ_donation_details` (str | None)

    2. `FuneralWishesContent(BaseModel)` -- JSONB shape for funeral wishes:
       - `full_name: str = ""`
       - `id_number: str = ""`
       - Body: `disposition: str = ""` (burial/cremation), `embalming: bool | None = None`
       - Burial: `cemetery_name`, `burial_location_details`, `casket_preference` (all str | None)
       - Cremation: `ashes_instruction`, `ashes_details` (str | None)
       - Ceremony: `ceremony_type`, `ceremony_location`, `religious_denomination`, `officiant_preference` (all str | None)
       - Music: `music_preferences`, `readings_or_poems` (str | None)
       - `specific_attendees`, `budget_preference`, `additional_wishes`, `messages_to_family` (all str | None)

    3. `AdditionalDocumentCreate(BaseModel)`: `document_type: str`, `will_id: str | None = None`
    4. `AdditionalDocumentUpdate(BaseModel)`: `content: dict`, `status: str | None = None`
    5. `AdditionalDocumentResponse(BaseModel)`: all fields from model, with `model_config = ConfigDict(from_attributes=True)`
  </action>
  <verify>
    - `python -c "from app.models.additional_document import AdditionalDocument; print('OK')"` from backend/
    - `python -c "from app.schemas.additional_document import LivingWillContent, FuneralWishesContent, AdditionalDocumentCreate, AdditionalDocumentUpdate, AdditionalDocumentResponse; print('OK')"` from backend/
    - Migration file exists at backend/alembic/versions/008_add_additional_documents.py
  </verify>
  <done>
    AdditionalDocument model importable, all Pydantic schemas importable, migration 008 file exists with additional_documents table creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: AdditionalDocumentService with PDF generation and Jinja2 templates</name>
  <files>
    backend/app/services/additional_document_service.py
    backend/app/templates/living_will/base.html
    backend/app/templates/living_will/body.html
    backend/app/templates/living_will/signature_page.html
    backend/app/templates/funeral_wishes/base.html
    backend/app/templates/funeral_wishes/body.html
    backend/app/templates/funeral_wishes/signature_page.html
  </files>
  <action>
    **Service (additional_document_service.py):**
    Create `AdditionalDocumentService` following the DocumentGenerationService pattern:
    - Constructor takes `AsyncSession` (DI via Depends)
    - `async create(user_id, document_type, will_id=None) -> AdditionalDocument`: Create new doc, optionally pre-populate content from linked will's testator data (name, id_number, address)
    - `async get(doc_id, user_id) -> AdditionalDocument`: Get with ownership check (raise HTTPException 404)
    - `async list_by_user(user_id) -> list[AdditionalDocument]`: List all user's additional docs
    - `async update(doc_id, user_id, content, status=None) -> AdditionalDocument`: Update content JSONB and optionally status
    - `async delete(doc_id, user_id) -> None`: Delete with ownership check
    - `async generate_pdf(doc_id, user_id, is_preview=True) -> bytes`: Generate PDF using Jinja2+WeasyPrint pipeline
      - Extract content from doc.content JSONB
      - Select template based on doc.document_type ("living_will" or "funeral_wishes")
      - Render HTML via Jinja2 with is_preview flag for watermark
      - Generate PDF in thread executor (reuse the _pdf_executor pattern from document_service.py)
      - If not preview, update status to "generated"
    - FastAPI dependency function: `get_additional_document_service(session=Depends(get_session))`

    Use the same TEMPLATE_DIR, _pdf_executor, and _render_pdf_sync pattern from document_service.py. Create a module-level Jinja2 Environment with FileSystemLoader pointing at TEMPLATE_DIR.

    **Living Will Templates:**
    Create `backend/app/templates/living_will/` directory with 3 files:

    `base.html`: Full HTML document with CSS (reuse page rules, typography, watermark, signature styles from will/base.html). Title: "Advance Healthcare Directive". Include body.html and signature_page.html via Jinja2 include. Add is_preview watermark.

    `body.html`: Sections for:
    - Declaration of intent (declarant name, ID, date of birth, address)
    - Trigger conditions section (terminal illness, permanent vegetative state, permanent unconsciousness)
    - Treatment preferences table (life support, ventilation, nutrition, CPR, antibiotics, pain management -- each with Accept/Refuse based on boolean)
    - Healthcare proxy section (proxy name, ID, phone, relationship, alternate proxy -- only rendered if proxy_name is provided)
    - Personal values section (rendered if personal_values or religious_considerations provided)
    - Organ donation section (rendered if organ_donation is not None)
    - Revocation clause (can be revoked at any time in writing or verbally)
    - Important notes: recommend consulting medical professional, recommend informing family/doctor, SA legal context (no statutory framework but constitutional backing)

    `signature_page.html`: Signature lines for:
    - Declarant: signature line, date, place
    - Two recommended witnesses (not legally required but strengthens evidentiary value): each with name, ID, address, signature, date
    - Note: "While not legally required, witness signatures strengthen the evidentiary value of this directive."

    **Funeral Wishes Templates:**
    Create `backend/app/templates/funeral_wishes/` directory with 3 files:

    `base.html`: Same structure as living will base. Title: "Record of Funeral Wishes".

    `body.html`: Sections for:
    - Personal details (name, ID)
    - Body disposition preference (burial or cremation, with conditional sub-sections)
    - If burial: cemetery, location details, casket preference
    - If cremation: ashes instruction, ashes details
    - Ceremony preferences (type, location, denomination, officiant)
    - Music and readings (if provided)
    - People to notify (if provided)
    - Budget guidance (if provided)
    - Additional wishes and messages to family (if provided)
    - Important note: "This document records my wishes but is not legally binding. The executor of my estate has final authority over funeral arrangements."

    `signature_page.html`: Simple signature line for the author + date. One optional witness. Note: "This document is a record of personal wishes and does not require witnesses for validity."

    **CSS reuse strategy:** Extract the common CSS (page rules, typography, watermark, signature, cover styles) from will/base.html and replicate it in each base.html. Do NOT create a shared include -- WeasyPrint requires CSS inline in each document. Keep the duplicated CSS manageable by only including styles relevant to each document type (no clause-block styles in additional documents).
  </action>
  <verify>
    - `python -c "from app.services.additional_document_service import AdditionalDocumentService, get_additional_document_service; print('OK')"` from backend/
    - All 6 template files exist: `ls backend/app/templates/living_will/ backend/app/templates/funeral_wishes/`
    - Templates contain valid HTML with Jinja2 syntax
  </verify>
  <done>
    AdditionalDocumentService with CRUD + PDF generation is importable. Six Jinja2 template files exist for both document types with professional formatting matching the will PDF style.
  </done>
</task>

<task type="auto">
  <name>Task 3: API endpoints and router registration</name>
  <files>
    backend/app/api/additional_documents.py
    backend/app/main.py
  </files>
  <action>
    **API Router (additional_documents.py):**
    Create FastAPI router with prefix="/api/additional-documents", tags=["additional-documents"]:

    - `POST /` -- Create new additional document. Body: `AdditionalDocumentCreate`. Returns `AdditionalDocumentResponse`. Gets user_id from request.state.user_id (same pattern as will.py).
    - `GET /` -- List user's additional documents. Returns `list[AdditionalDocumentResponse]`.
    - `GET /{doc_id}` -- Get single document. Returns `AdditionalDocumentResponse`. 404 if not found/not owned.
    - `PATCH /{doc_id}` -- Update document content. Body: `AdditionalDocumentUpdate`. Returns `AdditionalDocumentResponse`.
    - `DELETE /{doc_id}` -- Delete document. Returns 204 No Content.
    - `POST /{doc_id}/preview` -- Generate preview PDF (watermarked). Returns StreamingResponse with content_type "application/pdf", Content-Disposition inline.
    - `POST /{doc_id}/generate` -- Generate final PDF (no watermark). Returns StreamingResponse with content_type "application/pdf", Content-Disposition attachment. Updates status to "generated".

    Follow the same patterns as backend/app/api/document.py for PDF response streaming (use `StreamingResponse` with `io.BytesIO`).

    **main.py:**
    Add import: `from app.api import additional_documents`
    Add router: `app.include_router(additional_documents.router)` after the existing router registrations.
  </action>
  <verify>
    - `python -c "from app.api.additional_documents import router; print('OK')"` from backend/
    - `grep -q "additional_documents" backend/app/main.py` confirms router is registered
    - Start the backend and verify `/docs` shows the additional-documents endpoints (or just confirm imports work)
  </verify>
  <done>
    Seven API endpoints registered under /api/additional-documents. Router imported and included in main.py. Endpoints handle CRUD + PDF preview/generation with ownership checks.
  </done>
</task>

</tasks>

<verification>
1. All Python modules import without errors
2. Migration 008 file exists with correct table structure
3. All 6 Jinja2 template files exist with valid HTML
4. Router registered in main.py
5. Service follows DI pattern with AsyncSession + Depends
6. PDF generation reuses WeasyPrint thread pool executor pattern
</verification>

<success_criteria>
- AdditionalDocument model with JSONB content column and proper FK relationships
- LivingWillContent and FuneralWishesContent Pydantic schemas define complete data shapes
- Service supports create, read, update, delete, and PDF generation
- Living will PDF includes declaration, treatment preferences, proxy, values, signatures
- Funeral wishes PDF includes disposition, ceremony, music, messages, signature
- 7 API endpoints (CRUD + preview + generate) registered and importable
</success_criteria>

<output>
After completion, create `.planning/phases/09-additional-documents/09-01-SUMMARY.md`
</output>
