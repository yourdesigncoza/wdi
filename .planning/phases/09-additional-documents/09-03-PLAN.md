---
phase: 09-additional-documents
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - frontend/src/features/additional-documents/components/AdditionalDocumentsDashboard.tsx
  - frontend/src/features/additional-documents/components/DocumentPreview.tsx
  - frontend/src/features/will/components/WillDashboard.tsx
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to additional documents section from the main dashboard"
    - "User can create, view, and manage living will and funeral wishes documents"
    - "User can preview and download generated additional document PDFs"
    - "Additional documents follow same professional formatting as main will"
  artifacts:
    - path: "frontend/src/features/additional-documents/components/AdditionalDocumentsDashboard.tsx"
      provides: "Dashboard listing additional documents with create/resume/preview actions"
      contains: "AdditionalDocumentsDashboard"
    - path: "frontend/src/features/additional-documents/components/DocumentPreview.tsx"
      provides: "PDF preview and download component for additional documents"
      contains: "DocumentPreview"
    - path: "frontend/src/features/will/components/WillDashboard.tsx"
      provides: "Updated dashboard with link to additional documents"
      contains: "additional-documents"
    - path: "frontend/src/App.tsx"
      provides: "Routes for /documents and /documents/:docId/edit and /documents/:docId/preview"
      contains: "AdditionalDocumentsDashboard"
  key_links:
    - from: "frontend/src/features/will/components/WillDashboard.tsx"
      to: "/documents"
      via: "Link component"
      pattern: "Link.*to.*documents"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/features/additional-documents/components/AdditionalDocumentsDashboard.tsx"
      via: "Route element"
      pattern: "Route.*path.*documents"
    - from: "frontend/src/features/additional-documents/components/DocumentPreview.tsx"
      to: "frontend/src/services/api.ts"
      via: "previewAdditionalDocument/generateAdditionalDocument"
      pattern: "api\\.previewAdditionalDocument|api\\.generateAdditionalDocument"
---

<objective>
Build the dashboard, preview, routing, and integration layer for additional documents. Users can navigate from the main dashboard, manage their documents, edit via forms, and preview/download PDFs.

Purpose: Complete the user-facing flow for creating and downloading additional documents.
Output: Full end-to-end user journey from dashboard to document creation to PDF download.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-additional-documents/09-RESEARCH.md
@.planning/phases/09-additional-documents/09-01-SUMMARY.md
@.planning/phases/09-additional-documents/09-02-SUMMARY.md
@frontend/src/App.tsx
@frontend/src/features/will/components/WillDashboard.tsx
@frontend/src/features/will/components/DocumentPreviewPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdditionalDocumentsDashboard, DocumentPreview, and routing</name>
  <files>
    frontend/src/features/additional-documents/components/AdditionalDocumentsDashboard.tsx
    frontend/src/features/additional-documents/components/DocumentPreview.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **AdditionalDocumentsDashboard.tsx:**
    Create a dashboard component (follow WillDashboard.tsx pattern) that:

    - Uses `useApi()` from AuthApiContext for API calls
    - Uses `useQuery` (TanStack Query) to fetch `api.listAdditionalDocuments()`
    - Shows a navbar with "WillCraft SA" brand, "Additional Documents" subtitle, ThemeToggle, UserButton
    - Shows "Back to Dashboard" link (btn btn-soft) pointing to "/" via Link
    - If no documents exist, shows welcome card:
      - "Additional Documents" heading
      - Description: "Create supplementary estate planning documents alongside your will."
      - Two action cards side by side:
        - Living Will card: icon/description, "Create Living Will" button
        - Funeral Wishes card: icon/description, "Create Funeral Wishes" button
    - If documents exist, shows list of document cards (similar to WillCard):
      - Each card shows: document type (formatted label), status badge, updated date
      - Actions per card based on status:
        - draft/completed: "Edit" button -> navigates to /documents/{id}/edit
        - completed/generated: "Preview" button -> navigates to /documents/{id}/preview
        - Any: "Delete" button (with confirmation)
      - Plus "Create New" buttons for document types not yet created
    - Create action: calls `api.createAdditionalDocument({ document_type })`, stores response in Zustand, navigates to /documents/{id}/edit

    Status badges (reuse pattern from WillDashboard):
    - draft: badge-warning "Draft"
    - completed: badge-success "Completed"
    - generated: badge-accent "Generated"

    Document type labels: "living_will" -> "Living Will", "funeral_wishes" -> "Funeral Wishes"

    **DocumentPreview.tsx:**
    Create preview/download component (follow DocumentPreviewPage.tsx pattern):

    - Gets `docId` from URL params via `useParams()`
    - Uses `useApi()` for API calls
    - Has two modes: preview (watermarked) and generate (final)
    - "Generate Preview" button: calls `api.previewAdditionalDocument(docId)`, opens Blob in new tab
    - "Download Final PDF" button: calls `api.generateAdditionalDocument(docId)`, triggers blob download via temporary anchor element (same pattern as DownloadPage.tsx)
    - Shows document info (type, status) fetched via `api.getAdditionalDocument(docId)`
    - "Back to Documents" link -> /documents
    - Loading states with DaisyUI spinner
    - Error handling with DaisyUI alert

    **App.tsx:**
    Add new routes inside the `<Routes>` block, BEFORE the catch-all route:

    ```tsx
    <Route path="/documents" element={<AuthGatedContent><DocumentsPage /></AuthGatedContent>} />
    <Route path="/documents/:docId/edit" element={<AuthGatedContent><DocumentEditPage /></AuthGatedContent>} />
    <Route path="/documents/:docId/preview" element={<AuthGatedContent><DocumentPreviewPage2 /></AuthGatedContent>} />
    ```

    Create wrapper components (similar to WillPage pattern) that check consent:
    - `DocumentsPage`: renders `AdditionalDocumentsDashboard`
    - `DocumentEditPage`: reads `docId` from params, loads doc from API into Zustand store, renders `LivingWillForm` or `FuneralWishesForm` based on document_type. On complete, navigates to /documents/{id}/preview.
    - `DocumentPreviewPage2`: renders `DocumentPreview` (name avoids conflict with existing DocumentPreviewPage)

    Add imports for all new components at top of App.tsx.

    **WillDashboard.tsx:**
    Add an "Additional Documents" section below the existing wills list. Use a card or divider:
    - Heading: "Additional Documents"
    - Brief description: "Create supplementary estate planning documents."
    - Link button: `<Link to="/documents" className="btn btn-neutral">View Documents</Link>`
    - Show this section regardless of whether the user has wills (it is an independent feature)
  </action>
  <verify>
    - `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit --pretty 2>&1 | head -20` -- no type errors
    - `grep -q "documents" frontend/src/App.tsx` -- routes registered
    - AdditionalDocumentsDashboard.tsx and DocumentPreview.tsx exist and export correctly
  </verify>
  <done>
    Dashboard lists additional documents with create/edit/preview/delete actions. DocumentPreview enables PDF preview and download. Three new routes registered in App.tsx with auth gating.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete additional documents feature: backend API with PDF generation, Jinja2 templates for living will and funeral wishes, frontend forms with multi-step questionnaires, dashboard with document management, PDF preview and download.
  </what-built>
  <how-to-verify>
    1. Start backend: `cd /opt/lampp/htdocs/wdi/backend && source venv/bin/activate && alembic upgrade head && uvicorn app.main:app --reload`
    2. Start frontend: `cd /opt/lampp/htdocs/wdi/frontend && npm run dev`
    3. Sign in and navigate to the main dashboard
    4. Verify "Additional Documents" link/section is visible on the WillDashboard
    5. Click through to /documents -- verify the AdditionalDocumentsDashboard loads
    6. Create a Living Will:
       a. Click "Create Living Will"
       b. Fill in personal details (step 1)
       c. Set treatment preferences (step 2) -- toggle some on/off
       d. Optionally add a healthcare proxy (step 3)
       e. Add personal values/organ donation preferences (step 4)
       f. Click "Save & Complete"
    7. Preview the living will PDF -- verify it opens with professional formatting, watermark, treatment preferences table, and signature lines
    8. Download the final PDF -- verify no watermark
    9. Create a Funeral Wishes document:
       a. Click "Create Funeral Wishes"
       b. Fill personal details
       c. Select burial or cremation and fill conditional fields
       d. Set ceremony preferences
       e. Add messages and wishes
       f. Click "Save & Complete"
    10. Preview and download the funeral wishes PDF
    11. Return to /documents -- verify both documents appear with correct status badges
    12. Verify PDFs have professional formatting matching the will PDF style (serif font, A4, proper margins)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Dashboard accessible via /documents route with auth gating
2. WillDashboard has link/section for additional documents
3. Create -> Edit -> Preview -> Download flow works for both document types
4. PDF formatting matches will document style (serif font, A4, margins)
5. Living will PDF includes treatment preferences, proxy, signatures
6. Funeral wishes PDF includes disposition, ceremony, messages
7. Document status updates correctly (draft -> completed -> generated)
8. All routes protected by auth + consent gates
</verification>

<success_criteria>
- User can navigate from main dashboard to additional documents
- User can create, fill, and complete a living will via 4-step form
- User can create, fill, and complete funeral wishes via 4-step form
- User can preview watermarked PDF and download final PDF for both document types
- Dashboard shows all additional documents with status and actions
- PDFs have professional formatting with proper SA legal context
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/09-additional-documents/09-03-SUMMARY.md`
</output>
