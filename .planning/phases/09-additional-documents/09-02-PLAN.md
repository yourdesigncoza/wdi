---
phase: 09-additional-documents
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/src/services/api.ts
  - frontend/src/features/additional-documents/types/additionalDocument.ts
  - frontend/src/features/additional-documents/schemas/additionalDocSchemas.ts
  - frontend/src/features/additional-documents/store/useAdditionalDocStore.ts
  - frontend/src/features/additional-documents/components/LivingWillForm.tsx
  - frontend/src/features/additional-documents/components/FuneralWishesForm.tsx
autonomous: true

must_haves:
  truths:
    - "Frontend API client can call all additional document endpoints"
    - "TypeScript interfaces match backend Pydantic schemas"
    - "Zod schemas validate living will and funeral wishes form data"
    - "Zustand store manages form state with localStorage persistence"
    - "LivingWillForm collects all treatment preferences, proxy, and values via multi-step form"
    - "FuneralWishesForm collects disposition, ceremony, and personal wishes via multi-step form"
  artifacts:
    - path: "frontend/src/services/api.ts"
      provides: "Additional document API methods in buildApi factory"
      contains: "createAdditionalDocument"
    - path: "frontend/src/features/additional-documents/types/additionalDocument.ts"
      provides: "TypeScript interfaces for additional document data"
      contains: "LivingWillContent"
    - path: "frontend/src/features/additional-documents/schemas/additionalDocSchemas.ts"
      provides: "Zod validation schemas for both form types"
      contains: "livingWillSchema"
    - path: "frontend/src/features/additional-documents/store/useAdditionalDocStore.ts"
      provides: "Zustand persist+immer store for additional document state"
      contains: "useAdditionalDocStore"
    - path: "frontend/src/features/additional-documents/components/LivingWillForm.tsx"
      provides: "Multi-step form for living will data collection"
      contains: "LivingWillForm"
    - path: "frontend/src/features/additional-documents/components/FuneralWishesForm.tsx"
      provides: "Multi-step form for funeral wishes data collection"
      contains: "FuneralWishesForm"
  key_links:
    - from: "frontend/src/services/api.ts"
      to: "/api/additional-documents"
      via: "request/requestBlob functions"
      pattern: "additional-documents"
    - from: "frontend/src/features/additional-documents/store/useAdditionalDocStore.ts"
      to: "frontend/src/services/api.ts"
      via: "API calls in store actions"
      pattern: "api\\.createAdditionalDocument|api\\.updateAdditionalDocument"
    - from: "frontend/src/features/additional-documents/components/LivingWillForm.tsx"
      to: "frontend/src/features/additional-documents/store/useAdditionalDocStore.ts"
      via: "Zustand hook"
      pattern: "useAdditionalDocStore"
---

<objective>
Build the frontend data layer and form components for additional documents: API client methods, TypeScript types, Zod validation schemas, Zustand store, and multi-step form components for living will and funeral wishes.

Purpose: Enable users to fill out living will and funeral wishes questionnaires with proper validation and state management.
Output: Complete form components that collect data and persist to backend via API.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-additional-documents/09-RESEARCH.md
@.planning/phases/09-additional-documents/09-01-SUMMARY.md
@frontend/src/services/api.ts
@frontend/src/features/will/store/useWillStore.ts
@frontend/src/features/will/schemas/willSchemas.ts
@frontend/src/features/will/types/will.ts
@frontend/src/features/will/components/PersonalForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client methods, TypeScript types, Zod schemas, and Zustand store</name>
  <files>
    frontend/src/services/api.ts
    frontend/src/features/additional-documents/types/additionalDocument.ts
    frontend/src/features/additional-documents/schemas/additionalDocSchemas.ts
    frontend/src/features/additional-documents/store/useAdditionalDocStore.ts
  </files>
  <action>
    **API client (api.ts):**
    Add to the `buildApi` factory, under a new `// -- Additional Documents --` section:
    - `createAdditionalDocument(data: { document_type: string; will_id?: string })`: POST /additional-documents
    - `listAdditionalDocuments()`: GET /additional-documents, returns `AdditionalDocumentResponse[]`
    - `getAdditionalDocument(docId: string)`: GET /additional-documents/{docId}
    - `updateAdditionalDocument(docId: string, data: { content: Record<string, unknown>; status?: string })`: PATCH /additional-documents/{docId}
    - `deleteAdditionalDocument(docId: string)`: DELETE /additional-documents/{docId}, returns void (use raw fetch with 204 handling)
    - `previewAdditionalDocument(docId: string)`: POST /additional-documents/{docId}/preview, returns Blob (use requestBlob)
    - `generateAdditionalDocument(docId: string)`: POST /additional-documents/{docId}/generate, returns Blob (use requestBlob)

    Add `AdditionalDocumentResponse` interface to the shared type exports section:
    ```typescript
    export interface AdditionalDocumentResponse {
      id: string
      user_id: string
      will_id: string | null
      document_type: string
      status: string
      content: Record<string, unknown>
      created_at: string
      updated_at: string
    }
    ```

    **TypeScript types (additionalDocument.ts):**
    Create interfaces matching the Pydantic schemas from 09-01:

    ```typescript
    export interface LivingWillContent {
      fullName: string
      idNumber: string
      dateOfBirth: string
      address: string
      // Treatment preferences
      lifeSupport: boolean
      artificialVentilation: boolean
      artificialNutrition: boolean
      resuscitationCpr: boolean
      antibioticsTerminal: boolean
      painManagement: boolean
      // Trigger conditions
      terminalIllness: boolean
      permanentVegetativeState: boolean
      permanentUnconsciousness: boolean
      // Healthcare proxy
      proxyName: string | null
      proxyIdNumber: string | null
      proxyPhone: string | null
      proxyRelationship: string | null
      alternateProxyName: string | null
      // Values
      personalValues: string | null
      religiousConsiderations: string | null
      organDonation: boolean | null
      organDonationDetails: string | null
    }
    ```

    ```typescript
    export interface FuneralWishesContent {
      fullName: string
      idNumber: string
      disposition: string  // "burial" | "cremation"
      embalming: boolean | null
      cemeteryName: string | null
      burialLocationDetails: string | null
      casketPreference: string | null
      ashesInstruction: string | null
      ashesDetails: string | null
      ceremonyType: string | null
      ceremonyLocation: string | null
      religiousDenomination: string | null
      officiantPreference: string | null
      musicPreferences: string | null
      readingsOrPoems: string | null
      specificAttendees: string | null
      budgetPreference: string | null
      additionalWishes: string | null
      messagesToFamily: string | null
    }
    ```

    Also export `type DocumentType = 'living_will' | 'funeral_wishes'` and a `camelToSnake` utility for converting frontend camelCase content to backend snake_case before API calls.

    **Zod schemas (additionalDocSchemas.ts):**
    Create validation schemas:

    `livingWillPersonalSchema`: full_name (min 2), id_number (SA ID pattern: 13 digits), date_of_birth (non-empty string), address (min 5)

    `livingWillTreatmentSchema`: all boolean treatment fields + trigger conditions

    `livingWillProxySchema`: proxy_name (optional but if provided, min 2), proxy_phone (optional SA phone pattern), proxy_relationship (optional)

    `livingWillValuesSchema`: personal_values, religious_considerations, organ_donation, organ_donation_details (all optional)

    `funeralWishesPersonalSchema`: full_name (min 2), id_number (13 digits)

    `funeralWishesDispositionSchema`: disposition (enum: burial/cremation), conditional fields based on disposition

    `funeralWishesCeremonySchema`: ceremony_type (optional enum), location, denomination, officiant (all optional)

    `funeralWishesAdditionalSchema`: music, readings, attendees, budget, wishes, messages (all optional)

    **Zustand store (useAdditionalDocStore.ts):**
    Create store with persist+immer (same pattern as useWillStore):
    - State: `currentDocId: string | null`, `documentType: DocumentType | null`, `livingWillContent: Partial<LivingWillContent>`, `funeralWishesContent: Partial<FuneralWishesContent>`, `currentStep: number`, `status: string`
    - Actions: `setDocId(id)`, `setDocumentType(type)`, `updateLivingWill(partial)`, `updateFuneralWishes(partial)`, `setStep(n)`, `resetDoc()`, `loadFromServer(response)` (maps snake_case API response to camelCase store state using snakeToCamel from api.ts)
    - Persist key: "additional-doc-storage"
  </action>
  <verify>
    - `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit --pretty 2>&1 | head -20` -- no type errors in new files
    - All 4 files exist and export expected symbols
  </verify>
  <done>
    API client has 7 additional document methods. Types match backend schemas. Zod schemas validate form steps. Zustand store manages form state with persist.
  </done>
</task>

<task type="auto">
  <name>Task 2: LivingWillForm and FuneralWishesForm multi-step components</name>
  <files>
    frontend/src/features/additional-documents/components/LivingWillForm.tsx
    frontend/src/features/additional-documents/components/FuneralWishesForm.tsx
  </files>
  <action>
    **LivingWillForm.tsx:**
    Create a 4-step form component following PersonalForm.tsx pattern (step index + conditional rendering):

    Step 0 - Personal Details:
    - Full name, SA ID number, date of birth, address
    - Use React Hook Form with zodResolver(livingWillPersonalSchema)
    - DaisyUI `fieldset`, `form-control`, `input` classes
    - Pre-populated from Zustand store (which may be pre-filled from linked will)

    Step 1 - Treatment Preferences:
    - Section header explaining living will purpose. UPL note: "These are YOUR preferences -- we do not advise on medical treatment decisions. Please consult a medical professional."
    - Trigger conditions (3 toggles): terminal illness, permanent vegetative state, permanent unconsciousness
    - Treatment preferences (6 toggles with clear Accept/Refuse labeling):
      - Life support / artificial ventilation
      - Artificial nutrition (feeding tubes)
      - Resuscitation (CPR)
      - Antibiotics when terminal
      - Pain management (default: accept)
    - Use DaisyUI `toggle` components with descriptive labels

    Step 2 - Healthcare Proxy:
    - Optional section with "Add Healthcare Proxy" toggle
    - If enabled: proxy name, ID number, phone, relationship, alternate proxy name
    - DaisyUI `collapse` or conditional rendering

    Step 3 - Values & Wishes:
    - Personal values statement (textarea)
    - Religious considerations (textarea)
    - Organ donation preference (yes/no/undecided toggle)
    - If yes: organ donation details (text -- specific organs or full body)
    - Review summary showing all selections
    - "Save & Complete" button that saves content to backend via store action

    Navigation: Back/Next buttons (btn btn-soft / btn btn-neutral). On final step, save content to API and set status to "completed". Props: `docId: string`, `onComplete: () => void`, `onBack: () => void`.

    On mount, load existing content from store. On each step transition, save partial content to Zustand store. On "Save & Complete", convert camelCase to snake_case and call `api.updateAdditionalDocument(docId, { content, status: 'completed' })`.

    **FuneralWishesForm.tsx:**
    Create a 4-step form component:

    Step 0 - Personal Details:
    - Full name, SA ID number
    - Use React Hook Form with zodResolver

    Step 1 - Body Disposition:
    - Burial vs Cremation radio/toggle
    - Conditional fields:
      - Burial: cemetery name, location details, casket preference
      - Cremation: ashes instruction (scatter/urn/other dropdown), ashes details
    - Embalming preference (yes/no/no preference)

    Step 2 - Ceremony Preferences:
    - Ceremony type: religious, secular, celebration of life, none (radio group or select)
    - If religious: denomination, officiant preference
    - Ceremony location
    - Music preferences (textarea)
    - Readings or poems (textarea)

    Step 3 - Additional Wishes:
    - People who must be notified (textarea)
    - Budget preference: economical, moderate, elaborate (radio group)
    - Additional wishes (textarea)
    - Messages to family (textarea)
    - Note: "This document records your wishes but is not legally binding."
    - "Save & Complete" button

    Same navigation pattern as LivingWillForm. Same save behavior (camelCase -> snake_case -> API update).

    **Shared patterns for both forms:**
    - DaisyUI classes only: `card`, `card-body`, `form-control`, `label`, `input`, `textarea`, `toggle`, `select`, `btn`, `fieldset`, `fieldset-legend`
    - Step indicator at top showing current step (use `steps` DaisyUI component or a simple progress bar)
    - Each step wrapped in a form with handleSubmit that validates via Zod before advancing
    - No custom CSS
  </action>
  <verify>
    - `cd /opt/lampp/htdocs/wdi/frontend && npx tsc --noEmit --pretty 2>&1 | head -20` -- no type errors
    - Both components exist and export default/named exports
    - Components use DaisyUI classes (grep for "btn btn-neutral" in both files)
  </verify>
  <done>
    LivingWillForm has 4 steps (personal, treatment, proxy, values) with React Hook Form + Zod validation. FuneralWishesForm has 4 steps (personal, disposition, ceremony, wishes). Both save to backend via Zustand store + API client.
  </done>
</task>

</tasks>

<verification>
1. All new frontend files compile without TypeScript errors
2. API client has all 7 additional document methods
3. Zustand store persists to localStorage under "additional-doc-storage"
4. Both form components render with DaisyUI classes
5. Zod schemas validate required fields and SA-specific patterns
6. Form data converts from camelCase to snake_case before API calls
</verification>

<success_criteria>
- Frontend can create, read, update, delete additional documents via API
- LivingWillForm collects treatment preferences, proxy info, values across 4 steps
- FuneralWishesForm collects disposition, ceremony, wishes across 4 steps
- All form fields validated by Zod schemas
- Form state persisted in Zustand store with localStorage
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-additional-documents/09-02-SUMMARY.md`
</output>
