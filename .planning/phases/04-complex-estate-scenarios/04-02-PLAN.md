---
phase: 04-complex-estate-scenarios
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/features/will/types/will.ts
  - frontend/src/features/will/store/useWillStore.ts
  - frontend/src/features/will/schemas/willSchemas.ts
  - frontend/src/features/will/hooks/useScenarioDetection.ts
autonomous: true

must_haves:
  truths:
    - "Frontend types exist for trust, usufruct, business, and joint will data"
    - "Zustand store has state slices and actions for all complex sections"
    - "Zod schemas validate complex section forms with SA-specific rules"
    - "Scenario detection hook fetches detected scenarios from backend"
  artifacts:
    - path: "frontend/src/features/will/types/will.ts"
      provides: "TypeScript interfaces for all complex estate scenarios"
      contains: "TrustProvisions"
    - path: "frontend/src/features/will/store/useWillStore.ts"
      provides: "Zustand state and actions for complex sections"
      contains: "updateTrustProvisions"
    - path: "frontend/src/features/will/schemas/willSchemas.ts"
      provides: "Zod validation schemas for complex section forms"
      contains: "trustProvisionSchema"
    - path: "frontend/src/features/will/hooks/useScenarioDetection.ts"
      provides: "Hook that fetches and tracks detected scenarios"
      exports: ["useScenarioDetection"]
  key_links:
    - from: "frontend/src/features/will/store/useWillStore.ts"
      to: "frontend/src/features/will/types/will.ts"
      via: "imports complex interfaces for state typing"
      pattern: "import.*TrustProvisions.*UsufructProvision.*BusinessAsset.*JointWillConfig"
---

<objective>
Add frontend foundation for complex estate scenarios: TypeScript interfaces, Zustand store extensions, Zod validation schemas, and scenario detection hook.

Purpose: Provide the typed data layer and state management so UI components can manage complex section data with validation.
Output: Extended types, store, schemas, and a new scenario detection hook.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-complex-estate-scenarios/04-RESEARCH.md

@frontend/src/features/will/types/will.ts
@frontend/src/features/will/store/useWillStore.ts
@frontend/src/features/will/schemas/willSchemas.ts
@frontend/src/services/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and Zod schemas for complex sections</name>
  <files>
    frontend/src/features/will/types/will.ts
    frontend/src/features/will/schemas/willSchemas.ts
  </files>
  <action>
    **Types** — Add to `frontend/src/features/will/types/will.ts`:

    1. `BusinessType` const enum: 'cc_member_interest' | 'company_shares' | 'partnership'

    2. `TrustProvisions` interface:
       - trustName: string
       - minorBeneficiaries: string[]
       - vestingAge: number (18-25)
       - trustees: { name: string; idNumber?: string; relationship: string }[]
       - incomeForMaintenance: boolean
       - capitalForEducation: boolean

    3. `UsufructProvision` interface:
       - propertyDescription: string
       - usufructuaryName: string
       - usufructuaryIdNumber?: string
       - bareDominiumHolders: { name: string; idNumber?: string; sharePercent: number }[]
       - duration: 'lifetime' | string

    4. `BusinessAssetDetail` interface:
       - id: string
       - businessName: string
       - businessType: BusinessType
       - registrationNumber?: string
       - percentageHeld?: number
       - heirName?: string
       - heirRelationship?: string
       - hasBuySellAgreement: boolean
       - hasAssociationAgreement: boolean
       - notes?: string

    5. `JointWillConfig` interface:
       - coTestatorFirstName: string
       - coTestatorLastName: string
       - coTestatorIdNumber: string
       - willStructure: 'mutual' | 'mirror'
       - massing: boolean
       - irrevocabilityAcknowledged: boolean

    6. `ComplexScenario` type: 'blended_family' | 'testamentary_trust' | 'usufruct' | 'business_assets'

    Update `WILL_SECTIONS` array to include complex sections BEFORE 'review':
    ```
    'personal', 'beneficiaries', 'assets', 'guardians', 'executor', 'bequests', 'residue',
    'trust', 'usufruct', 'business', 'joint', 'review'
    ```
    This way the type system allows these sections. The wizard will conditionally show them.

    Update `WillState` interface to include:
    - trustProvisions: Partial<TrustProvisions>
    - usufruct: Partial<UsufructProvision>
    - businessAssets: BusinessAssetDetail[]
    - jointWill: Partial<JointWillConfig>
    - scenarios: ComplexScenario[]

    Update `WillActions` interface to include:
    - updateTrustProvisions: (data: Partial<TrustProvisions>) => void
    - updateUsufruct: (data: Partial<UsufructProvision>) => void
    - addBusinessAsset: (asset: BusinessAssetDetail) => void
    - removeBusinessAsset: (id: string) => void
    - updateJointWill: (data: Partial<JointWillConfig>) => void
    - setScenarios: (scenarios: ComplexScenario[]) => void

    **Zod schemas** — Add to `frontend/src/features/will/schemas/willSchemas.ts`:

    1. `trustProvisionSchema`:
       - trustName: z.string().min(1, 'Trust name is required')
       - minorBeneficiaries: z.array(z.string().min(1)).min(1, 'At least one minor beneficiary required')
       - vestingAge: z.number().min(18).max(25, 'Vesting age must be 18-25')
       - trustees: z.array(z.object({ name: z.string().min(1), idNumber: SA_ID or optional, relationship: z.string().min(1) })).min(1, 'At least one trustee required')
       - incomeForMaintenance: z.boolean()
       - capitalForEducation: z.boolean()

    2. `usufructSchema`:
       - propertyDescription: z.string().min(1, 'Property description is required')
       - usufructuaryName: z.string().min(1, 'Usufructuary name is required')
       - usufructuaryIdNumber: z.string().regex(SA_ID_REGEX).optional().or(z.literal(''))
       - bareDominiumHolders: z.array(z.object({ name: z.string().min(1), idNumber: optional, sharePercent: z.number().min(0).max(100) })).min(1)
       - duration: z.string().min(1)

    3. `businessAssetDetailSchema`:
       - id: z.string().min(1)
       - businessName: z.string().min(1, 'Business name is required')
       - businessType: z.enum(['cc_member_interest', 'company_shares', 'partnership'])
       - registrationNumber: z.string().optional().or(z.literal(''))
       - percentageHeld: z.number().min(0).max(100).optional()
       - heirName: z.string().optional().or(z.literal(''))
       - heirRelationship: z.string().optional().or(z.literal(''))
       - hasBuySellAgreement: z.boolean()
       - hasAssociationAgreement: z.boolean()
       - notes: z.string().optional().or(z.literal(''))

    4. `jointWillSchema`:
       - coTestatorFirstName: z.string().min(1, 'Co-testator first name is required')
       - coTestatorLastName: z.string().min(1, 'Co-testator last name is required')
       - coTestatorIdNumber: z.string().regex(SA_ID_REGEX, 'SA ID must be 13 digits')
       - willStructure: z.enum(['mutual', 'mirror'])
       - massing: z.boolean()
       - irrevocabilityAcknowledged: z.boolean().refine(val => val === true, 'You must acknowledge irrevocability')

    Export corresponding form data types for each schema.
  </action>
  <verify>
    Read both files and confirm:
    - All 5 new interfaces exist in types/will.ts
    - WILL_SECTIONS includes trust, usufruct, business, joint
    - WillState and WillActions include complex section fields
    - All 4 Zod schemas exist with proper validation rules
    - SA ID regex used where applicable
    - Export types match interfaces
  </verify>
  <done>Frontend type system fully supports all complex estate scenarios with interfaces, section constants, state types, action types, and Zod validation schemas.</done>
</task>

<task type="auto">
  <name>Task 2: Zustand store extensions and scenario detection hook</name>
  <files>
    frontend/src/features/will/store/useWillStore.ts
    frontend/src/features/will/hooks/useScenarioDetection.ts
  </files>
  <action>
    **Zustand store** — Extend `useWillStore` in `frontend/src/features/will/store/useWillStore.ts`:

    1. Add imports for new types: TrustProvisions, UsufructProvision, BusinessAssetDetail, JointWillConfig, ComplexScenario
    2. Extend `initialState` with:
       - trustProvisions: {}
       - usufruct: {}
       - businessAssets: []
       - jointWill: {}
       - scenarios: []
    3. Extend `sectionsComplete` in initialState with: trust: false, usufruct: false, business: false, joint: false
    4. Add actions using immer pattern (follow existing patterns exactly):
       - `updateTrustProvisions`: Object.assign(state.trustProvisions, data)
       - `updateUsufruct`: Object.assign(state.usufruct, data)
       - `addBusinessAsset`: state.businessAssets.push(asset)
       - `removeBusinessAsset`: filter by id
       - `updateJointWill`: Object.assign(state.jointWill, data)
       - `setScenarios`: state.scenarios = scenarios

    **Scenario detection hook** — Create `frontend/src/features/will/hooks/useScenarioDetection.ts`:

    ```typescript
    import { useState, useCallback } from 'react'
    import { useWillStore } from '../store/useWillStore.ts'
    import type { ComplexScenario } from '../types/will.ts'

    const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8000'

    export function useScenarioDetection() {
      const willId = useWillStore((s) => s.willId)
      const scenarios = useWillStore((s) => s.scenarios)
      const setScenarios = useWillStore((s) => s.setScenarios)
      const [loading, setLoading] = useState(false)
      const [error, setError] = useState<string | null>(null)

      const detectScenarios = useCallback(async () => {
        if (!willId) return
        setLoading(true)
        setError(null)
        try {
          const res = await fetch(`${API_BASE}/api/wills/${willId}/scenarios`, {
            credentials: 'include',
          })
          if (!res.ok) throw new Error('Failed to detect scenarios')
          const data: { scenarios: ComplexScenario[] } = await res.json()
          setScenarios(data.scenarios)
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Unknown error')
        } finally {
          setLoading(false)
        }
      }, [willId, setScenarios])

      const hasScenario = useCallback(
        (scenario: ComplexScenario) => scenarios.includes(scenario),
        [scenarios],
      )

      return { scenarios, loading, error, detectScenarios, hasScenario }
    }
    ```

    This hook:
    - Calls GET /api/wills/{id}/scenarios to auto-detect scenarios
    - Updates the store with detected scenarios
    - Provides hasScenario() helper for conditional rendering
    - Tracks loading and error states
  </action>
  <verify>
    Read both files and confirm:
    - Store has all 6 new state fields in initialState
    - Store has all 6 new actions
    - sectionsComplete includes trust, usufruct, business, joint
    - useScenarioDetection hook fetches from correct endpoint
    - Hook provides scenarios, loading, error, detectScenarios, hasScenario
  </verify>
  <done>Zustand store fully manages complex section state with immer mutations. Scenario detection hook connects frontend to backend detection endpoint.</done>
</task>

</tasks>

<verification>
- TypeScript interfaces compile (no type errors in new additions)
- WILL_SECTIONS includes all complex sections before 'review'
- Store initialState and actions match the types interface
- Zod schemas enforce SA-specific validation (ID regex, vesting age range)
- useScenarioDetection makes authenticated API call
</verification>

<success_criteria>
- All 5 new interfaces and ComplexScenario type in types/will.ts
- Zustand store has 6 new state fields and 6 new actions
- 4 Zod schemas with SA-specific validation
- Scenario detection hook fetches and stores detected scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/04-complex-estate-scenarios/04-02-SUMMARY.md`
</output>
