---
phase: 04-complex-estate-scenarios
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/alembic/versions/004_add_complex_sections.py
  - backend/app/models/will.py
  - backend/app/schemas/will.py
  - backend/app/services/will_service.py
  - backend/app/services/scenario_detector.py
  - backend/app/api/will.py
autonomous: true

must_haves:
  truths:
    - "Will model supports trust_provisions, usufruct, business_assets, joint_will, and scenarios JSONB columns"
    - "Scenario detector returns applicable scenarios based on will data"
    - "API validates and persists data for all new sections"
  artifacts:
    - path: "backend/alembic/versions/004_add_complex_sections.py"
      provides: "Alembic migration adding 5 new JSONB columns to wills table"
      contains: "trust_provisions"
    - path: "backend/app/services/scenario_detector.py"
      provides: "Deterministic scenario detection from will data"
      exports: ["ScenarioDetector"]
    - path: "backend/app/schemas/will.py"
      provides: "Pydantic schemas for trust, usufruct, business, joint sections"
      contains: "TrustProvisionSchema"
  key_links:
    - from: "backend/app/api/will.py"
      to: "backend/app/schemas/will.py"
      via: "_SECTION_SCHEMA_MAP extended with new sections"
      pattern: "trust_provisions.*TrustProvisionSchema"
    - from: "backend/app/services/will_service.py"
      to: "backend/app/models/will.py"
      via: "VALID_SECTIONS extended with new section names"
      pattern: "trust_provisions.*usufruct.*business_assets.*joint_will"
---

<objective>
Add backend foundation for complex estate scenarios: database migration, Will model extensions, Pydantic schemas, scenario detector service, and API updates.

Purpose: Establish the data layer and detection logic so that trust, usufruct, business asset, and joint will sections can be persisted and validated.
Output: Migration 004, extended Will model, 4 new Pydantic schemas, ScenarioDetector service, updated API schema map.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-complex-estate-scenarios/04-RESEARCH.md

@backend/app/models/will.py
@backend/app/schemas/will.py
@backend/app/services/will_service.py
@backend/app/api/will.py
@backend/alembic/versions/003_add_will_and_conversation_tables.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 004 + Will model extensions</name>
  <files>
    backend/alembic/versions/004_add_complex_sections.py
    backend/app/models/will.py
  </files>
  <action>
    Create Alembic migration `004_add_complex_sections.py` that adds 5 new JSONB columns to the `wills` table:

    1. `trust_provisions` — JSONB, NOT NULL, server_default="{}" (dict for testamentary trust data)
    2. `usufruct` — JSONB, NOT NULL, server_default="{}" (dict for usufruct provision data)
    3. `business_assets` — JSONB, NOT NULL, server_default="[]" (list for business asset entries)
    4. `joint_will` — JSONB, NOT NULL, server_default="{}" (dict for joint will configuration)
    5. `scenarios` — JSONB, NOT NULL, server_default="[]" (list of active scenario strings like ["testamentary_trust", "usufruct"])

    Follow the same pattern as migration 003 for JSONB columns. Use `server_default="{}"` not `server_default="'{}'"` — SQLAlchemy adds the quotes (see gotcha in MEMORY.md).

    Downgrade should drop all 5 columns.

    Update `backend/app/models/will.py`:
    - Add the 5 new JSONB columns matching the migration (trust_provisions: dict, usufruct: dict, business_assets: list, joint_will: dict, scenarios: list)
    - Use `sa_column=Column(JSONB, nullable=False, server_default="'{}'")`  for dict columns and `server_default="'[]'"` for list columns — this follows the existing pattern in the file (the model uses single-quoted server_default unlike the migration)
    - Update `sections_complete` default dict to include new keys: trust: False, usufruct: False, business: False, joint: False (only tracked when scenario is active, but present for consistency)
  </action>
  <verify>
    Read both files and confirm:
    - Migration adds exactly 5 columns with correct types and defaults
    - Migration has proper downgrade (drop columns)
    - Will model has all 5 new fields with matching column definitions
    - sections_complete default includes new keys
  </verify>
  <done>Will model has trust_provisions, usufruct, business_assets, joint_will, and scenarios columns with proper JSONB defaults. Migration 004 exists with upgrade and downgrade.</done>
</task>

<task type="auto">
  <name>Task 2: Pydantic schemas, scenario detector, and API updates</name>
  <files>
    backend/app/schemas/will.py
    backend/app/services/scenario_detector.py
    backend/app/services/will_service.py
    backend/app/api/will.py
  </files>
  <action>
    **Pydantic schemas** — Add to `backend/app/schemas/will.py`:

    1. `TrustProvisionSchema(BaseModel)`:
       - trust_name: str (name of testamentary trust)
       - minor_beneficiaries: list[str] (names of minor children)
       - vesting_age: int = Field(default=18, ge=18, le=25)
       - trustees: list[dict] = Field(default_factory=list) — [{name, id_number, relationship}]
       - income_for_maintenance: bool = True
       - capital_for_education: bool = True

    2. `UsufructSchema(BaseModel)`:
       - property_description: str
       - usufructuary_name: str
       - usufructuary_id_number: Optional[str] = None
       - bare_dominium_holders: list[dict] = Field(default_factory=list) — [{name, id_number, share_percent}]
       - duration: str = "lifetime"

    3. `BusinessAssetSchema_Complex(BaseModel)` — name it `BusinessAssetDetailSchema` to avoid collision with existing `AssetSchema`:
       - business_name: str
       - business_type: str = Field(description="cc_member_interest | company_shares | partnership")
       - registration_number: Optional[str] = None
       - percentage_held: Optional[float] = Field(default=None, ge=0, le=100)
       - heir_name: Optional[str] = None
       - heir_relationship: Optional[str] = None
       - has_buy_sell_agreement: bool = False
       - has_association_agreement: bool = False
       - notes: Optional[str] = None

    4. `JointWillSchema(BaseModel)`:
       - co_testator_first_name: str
       - co_testator_last_name: str
       - co_testator_id_number: str = Field(pattern=r"^\d{13}$")
       - will_structure: str = "mutual" (mutual | mirror)
       - massing: bool = False
       - irrevocability_acknowledged: bool = False

    Also add `ScenarioListSchema(BaseModel)` with field `scenarios: list[str]` for the scenarios column.

    Update `WillResponse` to include the 5 new fields: trust_provisions: dict, usufruct: dict, business_assets: list, joint_will: dict, scenarios: list.

    **Scenario detector** — Create `backend/app/services/scenario_detector.py`:

    ```python
    class ScenarioDetector:
        """Deterministic scenario detection from will data."""

        @staticmethod
        def detect(will_data: dict) -> list[str]:
            scenarios = []
            marital = will_data.get("marital", {})
            beneficiaries = will_data.get("beneficiaries", [])
            assets = will_data.get("assets", [])

            is_married = marital.get("status", "").startswith("married")

            # Blended family: married + step-children in beneficiaries
            has_step_children = any(
                b.get("relationship", "").lower() in ("step_child", "step_son", "step_daughter", "stepchild", "stepson", "stepdaughter")
                for b in beneficiaries
            )
            if is_married and has_step_children:
                scenarios.append("blended_family")

            # Testamentary trust: any minor beneficiary
            has_minors = any(b.get("is_minor", False) for b in beneficiaries)
            if has_minors:
                scenarios.append("testamentary_trust")

            # Usufruct: has property + is married
            has_property = any(
                a.get("asset_type") == "property" for a in assets
            )
            if has_property and is_married:
                scenarios.append("usufruct")

            # Business assets: has business-type assets
            has_business = any(
                a.get("asset_type") == "business" for a in assets
            )
            if has_business:
                scenarios.append("business_assets")

            return scenarios
    ```

    Note: Joint will is explicitly user-selected, not auto-detected. It sets will_type="joint".

    **Will service** — Update `VALID_SECTIONS` in `backend/app/services/will_service.py` to include: "trust_provisions", "usufruct", "business_assets", "joint_will", "scenarios".

    **API** — Update `backend/app/api/will.py`:
    - Import new schemas: TrustProvisionSchema, UsufructSchema, BusinessAssetDetailSchema, JointWillSchema
    - Extend `_SECTION_SCHEMA_MAP` with:
      - "trust_provisions": TrustProvisionSchema
      - "usufruct": UsufructSchema
      - "business_assets": BusinessAssetDetailSchema
      - "joint_will": JointWillSchema
    - Add "business_assets" to `_LIST_SECTIONS`
    - Add a new endpoint: `GET /api/wills/{will_id}/scenarios` that accepts a will_id, loads the will, feeds {marital, beneficiaries, assets} into ScenarioDetector.detect(), updates will.scenarios, and returns the scenarios list
  </action>
  <verify>
    Read all 4 files and confirm:
    - 4 new Pydantic schemas exist with correct fields
    - WillResponse includes 5 new fields
    - ScenarioDetector.detect() handles all 4 auto-detected scenarios
    - VALID_SECTIONS includes 5 new sections
    - _SECTION_SCHEMA_MAP includes 4 new entries
    - _LIST_SECTIONS includes business_assets
    - /api/wills/{will_id}/scenarios endpoint exists
  </verify>
  <done>Backend fully supports CRUD for trust, usufruct, business, and joint will sections. Scenario detection endpoint returns applicable scenarios from will data. All new sections validate via Pydantic schemas.</done>
</task>

</tasks>

<verification>
- Migration 004 has both upgrade and downgrade functions
- Will model has 5 new JSONB columns with correct defaults
- 4 new Pydantic schemas exist with field-level validation
- ScenarioDetector returns correct scenarios for each data pattern
- API schema map covers all new sections
- Scenario detection endpoint exists and returns list[str]
</verification>

<success_criteria>
- All 5 new JSONB columns defined in both migration and model
- ScenarioDetector correctly detects blended_family, testamentary_trust, usufruct, and business_assets
- API PATCH /api/wills/{id}/sections/{section} accepts all new sections
- GET /api/wills/{id}/scenarios returns detected scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/04-complex-estate-scenarios/04-01-SUMMARY.md`
</output>
