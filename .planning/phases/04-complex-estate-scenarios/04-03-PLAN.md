---
phase: 04-complex-estate-scenarios
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/app/prompts/system.py
  - backend/app/prompts/extraction.py
  - backend/app/services/upl_filter.py
  - backend/scripts/seed_clauses.py
autonomous: true

must_haves:
  truths:
    - "AI system prompts provide domain-specific guidance for trust, usufruct, business, and joint sections"
    - "Extraction models parse trust, usufruct, and business data from conversation"
    - "UPL filter catches trust tax, fideicommissum, business valuation, and complex trust patterns"
    - "Clause library has placeholder templates for TRUST-01, USUF-01, BUS-01, BUS-02, JOINT-01"
  artifacts:
    - path: "backend/app/prompts/system.py"
      provides: "Section-specific system prompts for 4 complex scenarios"
      contains: "SECTION_PROMPTS[\"trust\"]"
    - path: "backend/app/prompts/extraction.py"
      provides: "Extraction models for trust, usufruct, and business data"
      contains: "ExtractedTrustData"
    - path: "backend/app/services/upl_filter.py"
      provides: "Extended attorney-required patterns for complex scenarios"
      contains: "trust_tax"
    - path: "backend/scripts/seed_clauses.py"
      provides: "5 new placeholder clause templates for complex scenarios"
      contains: "TRUST-01"
  key_links:
    - from: "backend/app/prompts/system.py"
      to: "backend/app/prompts/extraction.py"
      via: "System prompts guide AI to produce data that extraction models can parse"
      pattern: "SECTION_PROMPTS.*trust.*usufruct.*business.*joint"
    - from: "backend/app/services/upl_filter.py"
      to: "backend/scripts/seed_clauses.py"
      via: "UPL REFER patterns redirect to clause library templates"
      pattern: "fideicommissum|trust_tax|business_valuation"
---

<objective>
Add AI prompts, extraction models, UPL filter extensions, and clause templates for all complex estate scenarios.

Purpose: Enable the AI conversation system to guide users through trust, usufruct, business asset, and joint will sections with proper UPL boundaries and structured data extraction.
Output: 4 new system prompts, 3 extraction models, 4 new UPL patterns, 5 new clause templates.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-complex-estate-scenarios/04-RESEARCH.md

@backend/app/prompts/system.py
@backend/app/prompts/extraction.py
@backend/app/services/upl_filter.py
@backend/scripts/seed_clauses.py
@backend/app/models/clause.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: System prompts and extraction models for complex sections</name>
  <files>
    backend/app/prompts/system.py
    backend/app/prompts/extraction.py
  </files>
  <action>
    **System prompts** — Add 4 new entries to `SECTION_PROMPTS` in `backend/app/prompts/system.py`:

    1. `SECTION_PROMPTS["trust"]` — Testamentary trust for minor children:
       - SA context: children under 18 cannot inherit directly — must be held in trust or Guardian's Fund
       - Ask about: which children are minors, vesting age (18, 21, or 25), trustee nominations, whether income available for maintenance and education
       - UPL boundary: Do NOT advise on trust structures, tax implications, or estate duty planning — refer to attorney for complex trust arrangements

    2. `SECTION_PROMPTS["usufruct"]` — Usufruct over property:
       - SA context: usufruct gives right to USE and ENJOY, not own. Bare dominium passes to other beneficiaries
       - Ask about: which property, who gets usage rights (usually spouse), who gets ownership (usually children), duration (lifetime or specific)
       - UPL boundary: usufructuary does NOT own — must maintain and cannot sell. Do NOT confuse with fideicommissum

    3. `SECTION_PROMPTS["business"]` — Business assets in will:
       - SA context: CC member interests need s35 consent from remaining members. Company shares differ from CC interests
       - Ask about: business name and type (CC, Pty Ltd, partnership), percentage held, heir for interest, buy-sell agreement, Association Agreement
       - UPL boundary: Do NOT advise on business valuation, buy-sell terms, or tax implications

    4. `SECTION_PROMPTS["joint"]` — Joint/mutual will:
       - SA context: Joint wills become effectively IRREVOCABLE after first death
       - Ask about: spouse details (if not in marital section), mutual vs mirror structure, massing of estates, irrevocability confirmation
       - UPL boundary: Many estate planners recommend separate mirror wills — mention this option. Do NOT give opinion on which is legally better

    Also update `format_will_summary()` to include new section data in the will context summary:
    - If trust_provisions has trust_name: add "Trust: {trust_name} (vesting at {vesting_age})"
    - If usufruct has property_description: add "Usufruct: {usufructuary_name} over {property_description}"
    - If business_assets has items: add "Business assets: {count} item(s)"
    - If joint_will has co_testator_first_name: add "Joint will with {co_testator_first_name} {co_testator_last_name}"

    **Extraction models** — Add 3 new extraction models to `backend/app/prompts/extraction.py`:

    1. `ExtractedTrustData(BaseModel)`:
       - trust_name: Optional[str] = None
       - minor_beneficiaries: list[str] = Field(default_factory=list)
       - vesting_age: Optional[int] = None
       - trustees: list[dict] = Field(default_factory=list)
       - income_for_maintenance: Optional[bool] = None
       - capital_for_education: Optional[bool] = None

    2. `ExtractedUsufructData(BaseModel)`:
       - property_description: Optional[str] = None
       - usufructuary_name: Optional[str] = None
       - bare_dominium_holders: list[dict] = Field(default_factory=list)
       - duration: Optional[str] = None

    3. `ExtractedBusinessData(BaseModel)`:
       - business_name: Optional[str] = None
       - business_type: Optional[str] = None
       - registration_number: Optional[str] = None
       - percentage_held: Optional[float] = None
       - heir_name: Optional[str] = None
       - has_buy_sell_agreement: Optional[bool] = None
       - has_association_agreement: Optional[bool] = None

    Update `ExtractedWillData` to include optional fields for the new data:
    - trust: Optional[ExtractedTrustData] = None
    - usufruct_data: Optional[ExtractedUsufructData] = None
    - business_data: list[ExtractedBusinessData] = Field(default_factory=list)

    Update `EXTRACTION_SYSTEM_PROMPT` to mention: "Also extract trust provisions (trust name, vesting age, trustees), usufruct details (property, usufructuary), and business asset information (business name, type, heir) when discussed."
  </action>
  <verify>
    Read both files and confirm:
    - 4 new entries in SECTION_PROMPTS with SA-specific context and UPL boundaries
    - format_will_summary includes trust, usufruct, business, joint data
    - 3 new extraction Pydantic models
    - ExtractedWillData includes optional trust, usufruct, business fields
    - EXTRACTION_SYSTEM_PROMPT updated
  </verify>
  <done>AI system prompts provide SA-specific guidance for all 4 complex sections. Extraction models parse trust, usufruct, and business data from conversation turns. Will summary includes complex section data.</done>
</task>

<task type="auto">
  <name>Task 2: UPL filter patterns and clause library seeds</name>
  <files>
    backend/app/services/upl_filter.py
    backend/scripts/seed_clauses.py
  </files>
  <action>
    **UPL filter** — Add 4 new patterns to `_ATTORNEY_REQUIRED_PATTERNS` in `backend/app/services/upl_filter.py`:

    1. `("trust_tax", re.compile(r"trust\s+(?:tax|duty|estate\s+duty|section\s+7[cC])", re.IGNORECASE))`
    2. `("fideicommissum", re.compile(r"fideicommiss", re.IGNORECASE))`
    3. `("business_valuation", re.compile(r"business\s+(?:valuation|fair\s+market\s+value)", re.IGNORECASE))`
    4. `("complex_trust", re.compile(r"(?:special|discretionary|inter\s+vivos)\s+trust", re.IGNORECASE))`

    These patterns trigger REFER (attorney referral) — highest priority, checked before advice patterns.

    **Clause seeds** — Add 5 new clause templates to `SEED_CLAUSES` list in `backend/scripts/seed_clauses.py`:

    1. `TRUST-01` — "Testamentary Trust for Minor Children":
       - category: ClauseCategory.TRUST
       - template: "I direct that any inheritance due to my minor children, namely {{ children_names }}, shall be held in a testamentary trust to be known as the {{ trust_name }}. The trust shall be administered by {{ trustee_names }} as Trustee(s). The trust assets shall vest in each beneficiary upon attaining the age of {{ vesting_age }} years. Until vesting, the Trustee(s) shall have the power to apply trust income and, if necessary, capital for the maintenance, education, and general welfare of the beneficiaries."
       - variables: children_names, trust_name, trustee_names, vesting_age
       - will_types: [TRUST, BASIC]
       - is_required: False, display_order: 55

    2. `USUF-01` — "Usufruct over Immovable Property":
       - category: ClauseCategory.USUFRUCT
       - template: "I bequeath to {{ usufructuary_name }}, Identity Number {{ usufructuary_id_number }}, a usufruct over the immovable property described as {{ property_description }}, for the duration of {{ usufructuary_name }}'s lifetime. The bare dominium of the said property shall vest in {{ bare_dominium_holders }}. The usufructuary shall be entitled to the use and enjoyment of the property and shall be responsible for the maintenance thereof and the payment of all rates and taxes."
       - variables: usufructuary_name, usufructuary_id_number, property_description, bare_dominium_holders
       - will_types: [USUFRUCT, BASIC]
       - is_required: False, display_order: 57

    3. `BUS-01` — "Bequest of Close Corporation Member Interest":
       - category: ClauseCategory.BENEFICIARY
       - template: "I bequeath my member's interest of {{ percentage_held }}% in {{ business_name }}, registration number {{ registration_number }}, to {{ heir_name }}. This bequest is subject to the consent of the remaining members of the close corporation in terms of Section 35 of the Close Corporations Act 69 of 1984. Should such consent not be obtained, I direct my Executor to dispose of my member's interest in such manner as may be required by law."
       - variables: percentage_held, business_name, registration_number, heir_name
       - will_types: _ALL_TYPES
       - is_required: False, display_order: 35

    4. `BUS-02` — "Bequest of Company Shares":
       - category: ClauseCategory.BENEFICIARY
       - template: "I bequeath my {{ percentage_held }}% shareholding in {{ business_name }}, registration number {{ registration_number }}, to {{ heir_name }}. This bequest is subject to any restrictions on transfer contained in the company's Memorandum of Incorporation and any applicable Shareholders Agreement."
       - variables: percentage_held, business_name, registration_number, heir_name
       - will_types: _ALL_TYPES
       - is_required: False, display_order: 36

    5. `JOINT-01` — "Joint Will Mutual Bequest":
       - category: ClauseCategory.BENEFICIARY
       - template: "We, {{ testator_1_name }}, Identity Number {{ testator_1_id }}, and {{ testator_2_name }}, Identity Number {{ testator_2_id }}, being husband and wife, do hereby jointly declare this to be our joint last will and testament. Upon the death of the first-dying, the survivor shall inherit the entire estate of the first-dying. Upon the death of the survivor, the combined estate shall be distributed as set out in this will."
       - variables: testator_1_name, testator_1_id, testator_2_name, testator_2_id
       - will_types: [JOINT]
       - is_required: True, display_order: 15

    All clauses use `approved_by="PLACEHOLDER - Pending Attorney Review"` and the same approval_notes as existing seeds.
  </action>
  <verify>
    Read both files and confirm:
    - 4 new patterns in _ATTORNEY_REQUIRED_PATTERNS
    - Patterns use re.IGNORECASE and compile at module load
    - 5 new clause entries in SEED_CLAUSES
    - Each clause has all required fields: code, name, category, template_text, variables_schema, will_types, is_required, display_order
    - All new clauses marked as PLACEHOLDER for attorney review
  </verify>
  <done>UPL filter catches trust tax, fideicommissum, business valuation, and complex trust patterns with REFER action. Clause library has 5 new placeholder templates for trust, usufruct, business (CC and company), and joint will scenarios.</done>
</task>

</tasks>

<verification>
- 4 system prompts mention SA-specific legal context and UPL boundaries
- 3 extraction models have correct Optional fields for incremental extraction
- format_will_summary outputs complex section data
- 4 new attorney-required patterns compile and match expected text
- 5 clause templates have valid Jinja2 {{ variable }} placeholders
- All clauses idempotently seed (existing codes skipped)
</verification>

<success_criteria>
- SECTION_PROMPTS has entries for "trust", "usufruct", "business", "joint"
- ExtractedWillData includes trust, usufruct_data, business_data fields
- UPL filter has 10 attorney-required patterns (was 6, now 10)
- SEED_CLAUSES has 12 entries (was 7, now 12)
</success_criteria>

<output>
After completion, create `.planning/phases/04-complex-estate-scenarios/04-03-SUMMARY.md`
</output>
