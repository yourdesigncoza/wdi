---
phase: 04-complex-estate-scenarios
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-04"]
files_modified:
  - frontend/src/features/will/components/ScenarioDetector.tsx
  - frontend/src/features/will/components/WillWizard.tsx
  - frontend/src/features/will/hooks/useWillProgress.ts
  - frontend/src/features/will/components/SectionReview.tsx
autonomous: false

must_haves:
  truths:
    - "Wizard conditionally shows complex sections based on detected scenarios"
    - "Scenario detector triggers after basic sections and activates relevant complex sections"
    - "Step indicator dynamically includes/excludes complex section steps"
    - "Section review includes complex section data in the will summary"
    - "User can navigate through complex sections in the wizard flow"
  artifacts:
    - path: "frontend/src/features/will/components/ScenarioDetector.tsx"
      provides: "Component that detects and displays applicable complex scenarios"
      exports: ["ScenarioDetector"]
    - path: "frontend/src/features/will/components/WillWizard.tsx"
      provides: "Extended wizard with conditional complex section rendering"
      contains: "TrustSection"
    - path: "frontend/src/features/will/hooks/useWillProgress.ts"
      provides: "Dynamic section list based on active scenarios"
      contains: "scenarios"
  key_links:
    - from: "frontend/src/features/will/components/WillWizard.tsx"
      to: "frontend/src/features/will/components/TrustSection.tsx"
      via: "conditional rendering when testamentary_trust scenario active"
      pattern: "hasScenario.*testamentary_trust.*TrustSection"
    - from: "frontend/src/features/will/components/ScenarioDetector.tsx"
      to: "frontend/src/features/will/hooks/useScenarioDetection.ts"
      via: "calls detectScenarios and displays results"
      pattern: "useScenarioDetection.*detectScenarios"
    - from: "frontend/src/features/will/hooks/useWillProgress.ts"
      to: "frontend/src/features/will/store/useWillStore.ts"
      via: "reads scenarios from store to build dynamic section list"
      pattern: "scenarios.*trust.*usufruct.*business.*joint"
---

<objective>
Integrate complex sections into the WillWizard with dynamic scenario detection, conditional section rendering, and updated progress tracking.

Purpose: Connect all Phase 4 components into a seamless user flow where the wizard adapts to the user's situation — showing trust sections only when minors are present, usufruct when property exists, etc.
Output: ScenarioDetector component, extended WillWizard, dynamic step indicator, updated section review.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-complex-estate-scenarios/04-RESEARCH.md

@frontend/src/features/will/components/WillWizard.tsx
@frontend/src/features/will/hooks/useWillProgress.ts
@frontend/src/features/will/hooks/useScenarioDetection.ts
@frontend/src/features/will/components/SectionReview.tsx
@frontend/src/features/will/components/TrustSection.tsx
@frontend/src/features/will/components/UsufructSection.tsx
@frontend/src/features/will/components/BusinessAssetsSection.tsx
@frontend/src/features/will/components/JointWillSetup.tsx
@frontend/src/features/will/store/useWillStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScenarioDetector component and dynamic useWillProgress</name>
  <files>
    frontend/src/features/will/components/ScenarioDetector.tsx
    frontend/src/features/will/hooks/useWillProgress.ts
  </files>
  <action>
    **ScenarioDetector.tsx** — Create a transitional component shown between the basic sections (after residue) and complex sections:

    1. When mounted, calls `detectScenarios()` from useScenarioDetection hook
    2. While loading, shows a spinner with text "Analyzing your will for complex scenarios..."
    3. If scenarios detected, shows a card listing what was found with explanations:
       - blended_family: "Your family situation may benefit from specific provisions for step-children"
       - testamentary_trust: "You have minor beneficiaries who will need a testamentary trust"
       - usufruct: "You have property and a spouse — a usufruct can protect both"
       - business_assets: "Your business interests need special provisions in your will"
    4. If no scenarios detected, shows a success message: "Your will doesn't require any complex provisions. You can proceed to review."
    5. Has a "Continue" button that advances to the first detected complex section, or to review if none
    6. User can also opt in to sections NOT auto-detected (e.g., toggle "I want to set up a joint will" even without auto-detection)

    ```tsx
    import { useEffect } from 'react'
    import { useScenarioDetection } from '../hooks/useScenarioDetection.ts'
    import { useWillStore } from '../store/useWillStore.ts'
    import type { ComplexScenario, WillSection } from '../types/will.ts'

    const SCENARIO_INFO: Record<ComplexScenario, { label: string; description: string; section: WillSection }> = {
      blended_family: {
        label: 'Blended Family',
        description: 'Specific provisions for step-children and multiple marriages',
        section: 'trust', // handled within trust/beneficiary context
      },
      testamentary_trust: {
        label: 'Testamentary Trust',
        description: 'Protect minor children\'s inheritance with a trust',
        section: 'trust',
      },
      usufruct: {
        label: 'Usufruct',
        description: 'Spouse keeps the home while children inherit ownership',
        section: 'usufruct',
      },
      business_assets: {
        label: 'Business Assets',
        description: 'CC member interests, company shares, or partnership interests',
        section: 'business',
      },
    }

    interface ScenarioDetectorProps {
      willId: string
      onContinue: (nextSection: WillSection) => void
    }

    export function ScenarioDetector({ willId, onContinue }: ScenarioDetectorProps) {
      // ... implementation
    }
    ```

    The onContinue callback receives the first complex section to navigate to, or 'review' if none.

    **useWillProgress** — Update to dynamically include complex sections based on active scenarios:

    1. Read `scenarios` from the store
    2. Build the SECTION_CONFIG array dynamically:
       - Always include: personal, beneficiaries, assets, guardians, executor, bequests, residue
       - If scenarios includes 'testamentary_trust' OR 'blended_family': include { key: 'trust', label: 'Trust' }
       - If scenarios includes 'usufruct': include { key: 'usufruct', label: 'Usufruct' }
       - If scenarios includes 'business_assets': include { key: 'business', label: 'Business' }
       - If will_type is 'joint' (check store): include { key: 'joint', label: 'Joint Will' }
       - Always include review last
    3. Update TOTAL_SECTIONS calculation to be dynamic (base 7 + active complex sections)
    4. Update REQUIRED_SECTIONS to NOT include complex sections (they're optional extras)
    5. Return a new `activeComplexSections` array for WillWizard to use
  </action>
  <verify>
    Read both files and confirm:
    - ScenarioDetector calls detectScenarios on mount
    - ScenarioDetector shows scenario explanations with labels
    - ScenarioDetector has Continue button navigating to first complex section or review
    - useWillProgress dynamically builds section list from scenarios
    - useWillProgress includes trust section when testamentary_trust or blended_family active
    - useWillProgress returns activeComplexSections
    - TOTAL_SECTIONS is dynamic
  </verify>
  <done>ScenarioDetector analyzes will data and shows applicable complex scenarios. useWillProgress dynamically adjusts the step indicator based on active scenarios.</done>
</task>

<task type="auto">
  <name>Task 2: Extend WillWizard with conditional complex sections and update SectionReview</name>
  <files>
    frontend/src/features/will/components/WillWizard.tsx
    frontend/src/features/will/components/SectionReview.tsx
  </files>
  <action>
    **WillWizard.tsx** — Extend to handle complex sections:

    1. Import new components: TrustSection, UsufructSection, BusinessAssetsSection, JointWillSetup, ScenarioDetector
    2. Add complex sections to AI_SECTIONS set: 'trust', 'usufruct', 'business' (they use ChatSection)
    3. Update `renderSection()` to handle new sections:
       - 'trust': return `<TrustSection willId={willId} />`
       - 'usufruct': return `<UsufructSection willId={willId} />`
       - 'business': return `<BusinessAssetsSection willId={willId} />`
       - 'joint': return `<JointWillSetup willId={willId} />`
    4. The ScenarioDetector is NOT a wizard section — it's triggered automatically. After the residue section is completed, the wizard can detect scenarios. This can be done:
       - Option A: Insert a "scenario" pseudo-section after residue (simpler)
       - Option B: Auto-detect on section transitions

       Use Option A: Add 'scenarios' to the section flow (between 'residue' and complex sections). When currentSection === 'scenarios', render ScenarioDetector. The ScenarioDetector's onContinue advances to the appropriate next section.

       BUT: 'scenarios' is a transitional UI section, not a data section. Do NOT add it to WILL_SECTIONS type — handle it as a special case in WillWizard only. Use a local state or a check: if residue is complete and no scenarios have been detected yet, show ScenarioDetector before allowing navigation to complex sections.

       Simpler approach: Add scenario detection logic inside WillWizard. When user navigates past residue, if scenarios haven't been detected yet (scenarios.length === 0 and residue is complete), auto-trigger detection and show ScenarioDetector as an interstitial. Once scenarios are set (even to empty), allow normal navigation to review or complex sections.

    5. Ensure `ensureWillExists` covers new AI sections (trust, usufruct, business)

    **SectionReview.tsx** — Update to include complex section data in the review:

    Read the existing SectionReview component first. Then extend it to:

    1. If trustProvisions has data: show "Testamentary Trust" section with trust name, vesting age, trustees, maintenance/education flags
    2. If usufruct has data: show "Usufruct" section with property, usufructuary, bare dominium holders, duration
    3. If businessAssets has items: show "Business Assets" section listing each business with type badge and CC consent note
    4. If jointWill has data: show "Joint Will" section with co-testator details, structure (mutual/mirror), massing, irrevocability status

    Use the same DaisyUI card/divider patterns as the existing review sections.
  </action>
  <verify>
    Read both files and confirm:
    - WillWizard imports all 4 new section components + ScenarioDetector
    - WillWizard renderSection handles 'trust', 'usufruct', 'business', 'joint'
    - Scenario detection triggers after residue completion
    - ensureWillExists covers new AI sections
    - SectionReview shows trust, usufruct, business, joint data when present
    - SectionReview uses DaisyUI patterns consistent with existing sections
  </verify>
  <done>WillWizard conditionally renders complex sections based on detected scenarios. SectionReview displays all complex section data in the will summary. Full wizard flow: personal -> basic sections -> scenario detection -> applicable complex sections -> review.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 integration: scenario detection after basic sections, conditional complex section wizard steps, trust/usufruct/business/joint UI components, dynamic step indicator, and updated section review.
  </what-built>
  <how-to-verify>
    1. Start the dev servers: backend (`uvicorn`) and frontend (`npm run dev`)
    2. Navigate to the will wizard
    3. Complete personal and marital sections (set status to married)
    4. In beneficiaries chat, mention a minor child
    5. In assets chat, mention a property and a business
    6. Complete remaining basic sections (guardians, executor, bequests, residue)
    7. After residue, scenario detector should trigger and show:
       - Testamentary trust (minor child detected)
       - Usufruct (property + married)
       - Business assets (business detected)
    8. Verify trust section shows info banner and AI chat
    9. Verify usufruct section shows info + warning banners
    10. Verify business section shows CC consent warning
    11. Navigate to review — verify complex section data appears
    12. Verify step indicator shows dynamic sections
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- WillWizard renders complex sections when scenarios are active
- ScenarioDetector triggers after basic sections are complete
- Step indicator dynamically shows/hides complex section steps
- Section review includes all complex section data
- Joint will setup accessible when user selects joint will type
- All new components use DaisyUI classes matching existing patterns
</verification>

<success_criteria>
- Wizard flow: personal -> basic sections -> scenario detection -> complex sections -> review
- Only applicable complex sections shown (e.g., no trust section if no minors)
- Step indicator updates dynamically when scenarios change
- Section review displays trust, usufruct, business, joint data when present
- Human verification confirms full flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-complex-estate-scenarios/04-05-SUMMARY.md`
</output>
